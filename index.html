<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharma Gestion - Interface de Gestion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffa726, #ff9800);
        }

        .btn-warning:hover {
            box-shadow: 0 5px 15px rgba(255, 167, 38, 0.4);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table tr:hover {
            background-color: #f8f9ff;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .import-export {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-input {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input label {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .file-input label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paye {
            background: #d4edda;
            color: #155724;
        }

        .status-impaye {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav-tabs {
                justify-content: center;
            }

            .nav-tab {
                font-size: 12px;
                padding: 8px 15px;
            }

            .data-table {
                font-size: 12px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-pills"></i> Pharma Gestion</h1>
            <div class="info-cards">
                <div class="info-card">
                    <h3 id="societeName">-</h3>
                    <p>Société</p>
                </div>
                <div class="info-card">
                    <h3 id="totalDocs">0</h3>
                    <p>Documents Total</p>
                </div>
                <div class="info-card">
                    <h3 id="exportDate">-</h3>
                    <p>Date Export</p>
                </div>
                <div class="info-card">
                    <h3 id="appVersion">-</h3>
                    <p>Version App</p>
                </div>
            </div>

            <div class="import-export">
                <div class="file-input">
                    <input type="file" id="jsonFileInput" accept=".json">
                    <label for="jsonFileInput">
                        <i class="fas fa-upload"></i> Importer JSON
                    </label>
                </div>
                <button class="btn" onclick="exportData()">
                    <i class="fas fa-download"></i> Exporter JSON
                </button>
                <button class="btn btn-danger" onclick="resetData()">
                    <i class="fas fa-trash"></i> Réinitialiser
                </button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-pie"></i> Dashboard
                </button>
                <button class="nav-tab" onclick="showSection('achats')">
                    <i class="fas fa-shopping-cart"></i> Achats
                </button>
                <button class="nav-tab" onclick="showSection('ventes')">
                    <i class="fas fa-cash-register"></i> Ventes
                </button>
                <button class="nav-tab" onclick="showSection('stock')">
                    <i class="fas fa-boxes"></i> Stock
                </button>
                <button class="nav-tab" onclick="showSection('paiements')">
                    <i class="fas fa-credit-card"></i> Paiements
                </button>
                <button class="nav-tab" onclick="showSection('users')">
                    <i class="fas fa-users"></i> Utilisateurs
                </button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="section-header">
                <h2><i class="fas fa-chart-pie"></i> Tableau de Bord</h2>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-shopping-cart"></i>
                    <h3 id="stats-achats">0</h3>
                    <p>Achats</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-cash-register"></i>
                    <h3 id="stats-ventes">0</h3>
                    <p>Ventes</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-boxes"></i>
                    <h3 id="stats-stock">0</h3>
                    <p>Articles en Stock</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-credit-card"></i>
                    <h3 id="stats-paiements">0</h3>
                    <p>Paiements</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <h3 id="stats-users">0</h3>
                    <p>Utilisateurs</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-euro-sign"></i>
                    <h3 id="stats-ca">0€</h3>
                    <p>Chiffre d'Affaires</p>
                </div>
            </div>
        </div>

        <!-- Achats Section -->
        <div id="achats" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-shopping-cart"></i> Gestion des Achats</h2>
                <button class="btn" onclick="openModal('achatModal')">
                    <i class="fas fa-plus"></i> Nouvel Achat
                </button>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchAchats" placeholder="Rechercher dans les achats..." onkeyup="searchTable('achatsTable', this.value)">
                </div>
            </div>

            <table class="data-table" id="achatsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Fournisseur</th>
                        <th>Articles</th>
                        <th>Montant</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="achatsTableBody">
                </tbody>
            </table>
        </div>

        <!-- Ventes Section -->
        <div id="ventes" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-cash-register"></i> Gestion des Ventes</h2>
                <button class="btn" onclick="openModal('venteModal')">
                    <i class="fas fa-plus"></i> Nouvelle Vente
                </button>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchVentes" placeholder="Rechercher dans les ventes..." onkeyup="searchTable('ventesTable', this.value)">
                </div>
            </div>

            <table class="data-table" id="ventesTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Client</th>
                        <th>Articles</th>
                        <th>Montant</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ventesTableBody">
                </tbody>
            </table>
        </div>

        <!-- Stock Section -->
        <div id="stock" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-boxes"></i> Gestion du Stock</h2>
                <button class="btn" onclick="openModal('stockModal')">
                    <i class="fas fa-plus"></i> Nouvel Article
                </button>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchStock" placeholder="Rechercher dans le stock..." onkeyup="searchTable('stockTable', this.value)">
                </div>
            </div>

            <table class="data-table" id="stockTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Quantité</th>
                        <th>Seuil</th>
                        <th>Prix Achat</th>
                        <th>Prix Vente</th>
                        <th>Fournisseur</th>
                        <th>Expiration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                </tbody>
            </table>
        </div>

        <!-- Paiements Section -->
        <div id="paiements" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-credit-card"></i> Gestion des Paiements</h2>
                <button class="btn" onclick="openModal('paiementModal')">
                    <i class="fas fa-plus"></i> Nouveau Paiement
                </button>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchPaiements" placeholder="Rechercher dans les paiements..." onkeyup="searchTable('paiementsTable', this.value)">
                </div>
            </div>

            <table class="data-table" id="paiementsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Montant</th>
                        <th>Mode</th>
                        <th>Créé par</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="paiementsTableBody">
                </tbody>
            </table>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Gestion des Utilisateurs</h2>
                <button class="btn" onclick="openModal('userModal')">
                    <i class="fas fa-plus"></i> Nouvel Utilisateur
                </button>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchUsers" placeholder="Rechercher dans les utilisateurs..." onkeyup="searchTable('usersTable', this.value)">
                </div>
            </div>

            <table class="data-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Rôle</th>
                        <th>Actif</th>
                        <th>Dernière Connexion</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="achatModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('achatModal')">&times;</span>
            <h2>Nouvel Achat</h2>
            <div class="form-group">
                <label>Date:</label>
                <input type="date" id="achat-date" required>
            </div>
            <div class="form-group">
                <label>Fournisseur:</label>
                <input type="text" id="achat-fournisseur" placeholder="Nom du fournisseur" required>
            </div>
            <div class="form-group">
                <label>Statut Paiement:</label>
                <select id="achat-statut">
                    <option value="payé">Payé</option>
                    <option value="impayé">Impayé</option>
                </select>
            </div>
            <button class="btn" onclick="saveAchat()">Enregistrer</button>
        </div>
    </div>

    <div id="venteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('venteModal')">&times;</span>
            <h2>Nouvelle Vente</h2>
            <div class="form-group">
                <label>Date:</label>
                <input type="date" id="vente-date" required>
            </div>
            <div class="form-group">
                <label>Client:</label>
                <input type="text" id="vente-client" placeholder="Nom du client" required>
            </div>
            <div class="form-group">
                <label>Montant Total:</label>
                <input type="number" id="vente-montant" placeholder="0.00" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Mode de Paiement:</label>
                <select id="vente-mode">
                    <option value="Espèces">Espèces</option>
                    <option value="Carte">Carte</option>
                    <option value="Virement">Virement</option>
                </select>
            </div>
            <div class="form-group">
                <label>Statut Paiement:</label>
                <select id="vente-statut">
                    <option value="payé">Payé</option>
                    <option value="impayé">Impayé</option>
                </select>
            </div>
            <button class="btn" onclick="saveVente()">Enregistrer</button>
        </div>
    </div>

    <div id="stockModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('stockModal')">&times;</span>
            <h2>Nouvel Article Stock</h2>
            <div class="form-group">
                <label>Nom du Produit:</label>
                <input type="text" id="stock-nom" placeholder="Nom du produit" required>
            </div>
            <div class="form-group">
                <label>Quantité:</label>
                <input type="number" id="stock-quantite" placeholder="0" required>
            </div>
            <div class="form-group">
                <label>Seuil Minimum:</label>
                <input type="number" id="stock-seuil" placeholder="5" required>
            </div>
            <div class="form-group">
                <label>Prix d'Achat:</label>
                <input type="number" id="stock-prix-achat" placeholder="0.00" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Prix de Vente:</label>
                <input type="number" id="stock-prix-vente" placeholder="0.00" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Fournisseur:</label>
                <input type="text" id="stock-fournisseur" placeholder="Nom du fournisseur">
            </div>
            <div class="form-group">
                <label>Date de Péremption:</label>
                <input type="date" id="stock-peremption">
            </div>
            <button class="btn" onclick="saveStock()">Enregistrer</button>
        </div>
    </div>

    <div id="paiementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paiementModal')">&times;</span>
            <h2>Nouveau Paiement</h2>
            <div class="form-group">
                <label>Date:</label>
                <input type="date" id="paiement-date" required>
            </div>
            <div class="form-group">
                <label>Type:</label>
                <select id="paiement-type">
                    <option value="ventes">Vente</option>
                    <option value="achats">Achat</option>
                </select>
            </div>
            <div class="form-group">
                <label>Montant:</label>
                <input type="number" id="paiement-montant" placeholder="0.00" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Mode:</label>
                <select id="paiement-mode">
                    <option value="Espèces">Espèces</option>
                    <option value="Carte">Carte</option>
                    <option value="Virement">Virement</option>
                    <option value="Chèque">Chèque</option>
                </select>
            </div>
            <button class="btn" onclick="savePaiement()">Enregistrer</button>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('userModal')">&times;</span>
            <h2>Nouvel Utilisateur</h2>
            <div class="form-group">
                <label>Nom d'affichage:</label>
                <input type="text" id="user-nom" placeholder="Nom d'affichage" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="user-email" placeholder="email@example.com" required>
            </div>
            <div class="form-group">
                <label>Rôle:</label>
                <select id="user-role">
                    <option value="docteur">Docteur</option>
                    <option value="vendeuse">Vendeuse</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label>Téléphone:</label>
                <input type="tel" id="user-telephone" placeholder="Numéro de téléphone">
            </div>
            <button class="btn" onclick="saveUser()">Enregistrer</button>
        </div>
    </div>

    <script>
        // Global data storage
        let pharmaData = {
            metadata: {
                exportDate: "2025-08-28T14:30:50.812Z",
                exportDateFr: "28 août 2025 à 15:30",
                societeName: "PHARMACIE DRARGA",
                version: "1.2",
                appName: "Pharma Gestion"
            },
            data: {
                achats: [
                    {
                        id: "7ppZ9mpi3piwsSHhYVU7",
                        date: "2025-08-27T00:00:00.000Z",
                        fournisseur: "Sorefa",
                        statutPaiement: "payé",
                        articles: [{
                            produit: "Amoxyl 200",
                            quantite: 25,
                            prixAchat: 89,
                            prixVente: 99
                        }]
                    }
                ],
                ventes: [
                    {
                        id: "atPgLOd5dIVxjL6uuCES",
                        date: "2025-08-28T00:00:00.000Z",
                        client: "Passant",
                        montantTotal: 594,
                        statutPaiement: "payé",
                        articles: [{
                            produit: "Amoxyl 200",
                            quantite: 6,
                            prixUnitaire: 99
                        }]
                    },
                    {
                        id: "hwekVy7fBHKMNMs0oLF6",
                        date: "2025-08-27T00:00:00.000Z",
                        client: "ALIM",
                        montantTotal: 396,
                        statutPaiement: "payé",
                        articles: [{
                            produit: "Amoxyl 200",
                            quantite: 4,
                            prixUnitaire: 99
                        }]
                    }
                ],
                stock: [
                    {
                        id: "0YUtJRrXVp2TeAsqIFxF",
                        nom: "Amoxyl 200",
                        quantite: 25,
                        seuil: 5,
                        prixAchat: 89,
                        prixVente: 99,
                        dernierFournisseur: "Sorefa",
                        datePeremption: "2026-01-23"
                    }
                ],
                paiements: [
                    {
                        id: "0i7qDp1ToRh7F6sDVwWj",
                        type: "ventes",
                        montant: 594,
                        mode: "Espèces",
                        date: "2025-08-28T10:11:33.000Z",
                        createdBy: "echchaaba0178@gmail.com"
                    },
                    {
                        id: "LokLLaKEkzFoHD5dNFbf",
                        type: "ventes",
                        montant: 396,
                        mode: "Espèces",
                        date: "2025-08-27T14:11:35.000Z",
                        createdBy: "sara@gmail.com"
                    },
                    {
                        id: "RbI0qRgKoRFz7jdfygmr",
                        type: "achats",
                        montant: 2225,
                        mode: "Espèces",
                        date: "2025-08-27T14:05:24.000Z",
                        createdBy: "echchaaba0178@gmail.com"
                    }
                ],
                users: [
                    {
                        id: "AKwsLYAvr4fhM0fzEpuZ6kbnjo33",
                        displayName: "ech-chaaba",
                        email: "echchaaba0178@gmail.com",
                        role: "docteur",
                        active: true,
                        createdAt: "2025-08-27T13:51:40.000Z"
                    },
                    {
                        id: "Wc1Ovwz6ZVWRF59zXblhzoTRPii1",
                        displayName: "SARA CHAABA",
                        email: "sara@gmail.com",
                        role: "vendeuse",
                        active: true,
                        createdAt: "2025-08-27T13:52:48.000Z"
                    }
                ]
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('achat-date').value = today;
            document.getElementById('vente-date').value = today;
            document.getElementById('paiement-date').value = today;
            
            updateDisplay();
        });

        // Load JSON file
        document.getElementById('jsonFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        pharmaData = jsonData;
                        updateDisplay();
                        alert('Données importées avec succès !');
                    } catch (error) {
                        alert('Erreur lors de l\'importation: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Navigation functions
        function showSection(sectionName) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            switch(sectionName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'achats':
                    updateAchatsTable();
                    break;
                case 'ventes':
                    updateVentesTable();
                    break;
                case 'stock':
                    updateStockTable();
                    break;
                case 'paiements':
                    updatePaiementsTable();
                    break;
                case 'users':
                    updateUsersTable();
                    break;
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            const modal = document.getElementById(modalId);
            const inputs = modal.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.type === 'date') {
                    input.value = new Date().toISOString().split('T')[0];
                } else {
                    input.value = '';
                }
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Update display functions
        function updateDisplay() {
            updateHeaderInfo();
            updateDashboard();
            updateAllTables();
        }

        function updateHeaderInfo() {
            const metadata = pharmaData.metadata || {};
            
            document.getElementById('societeName').textContent = metadata.societeName || 'PHARMACIE DRARGA';
            document.getElementById('totalDocs').textContent = Object.values(pharmaData.data).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0);
            document.getElementById('exportDate').textContent = metadata.exportDateFr || 'Aujourd\'hui';
            document.getElementById('appVersion').textContent = metadata.version || '1.2';
        }

        function updateDashboard() {
            const data = pharmaData.data || {};
            
            document.getElementById('stats-achats').textContent = (data.achats || []).length;
            document.getElementById('stats-ventes').textContent = (data.ventes || []).length;
            document.getElementById('stats-stock').textContent = (data.stock || []).length;
            document.getElementById('stats-paiements').textContent = (data.paiements || []).length;
            document.getElementById('stats-users').textContent = (data.users || []).length;
            
            const totalCA = (data.ventes || []).reduce((sum, vente) => {
                return sum + (vente.montantTotal || 0);
            }, 0);
            document.getElementById('stats-ca').textContent = totalCA.toFixed(2) + '€';
        }

        function updateAllTables() {
            updateAchatsTable();
            updateVentesTable();
            updateStockTable();
            updatePaiementsTable();
            updateUsersTable();
        }

        // Achats functions
        function updateAchatsTable() {
            const tbody = document.getElementById('achatsTableBody');
            const achats = pharmaData.data.achats || [];
            
            tbody.innerHTML = '';
            
            achats.forEach(achat => {
                const row = document.createElement('tr');
                const totalArticles = (achat.articles || []).length;
                const montantTotal = (achat.articles || []).reduce((sum, article) => {
                    return sum + ((article.prixAchat || 0) * (article.quantite || 0));
                }, 0);
                
                row.innerHTML = `
                    <td>${formatDate(achat.date)}</td>
                    <td>${achat.fournisseur || '-'}</td>
                    <td>${totalArticles} article(s)</td>
                    <td>${montantTotal.toFixed(2)}€</td>
                    <td><span class="status-badge status-${achat.statutPaiement || 'impaye'}">${achat.statutPaiement || 'Impayé'}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="editAchat('${achat.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteAchat('${achat.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function saveAchat() {
            const modal = document.getElementById('achatModal');
            const editId = modal.getAttribute('data-edit-id');
            
            const achatData = {
                date: document.getElementById('achat-date').value,
                fournisseur: document.getElementById('achat-fournisseur').value,
                statutPaiement: document.getElementById('achat-statut').value
            };

            if (editId) {
                const index = pharmaData.data.achats.findIndex(a => a.id === editId);
                if (index !== -1) {
                    pharmaData.data.achats[index] = {...pharmaData.data.achats[index], ...achatData};
                    alert('Achat modifié avec succès !');
                }
                modal.removeAttribute('data-edit-id');
            } else {
                const newAchat = {
                    id: generateId(),
                    ...achatData,
                    articles: [],
                    creePar: "current_user",
                    creeParEmail: "user@example.com",
                    timestamp: new Date().toISOString(),
                    creeLe: new Date().toISOString()
                };

                if (!pharmaData.data.achats) {
                    pharmaData.data.achats = [];
                }
                
                pharmaData.data.achats.push(newAchat);
                alert('Achat enregistré avec succès !');
            }

            updateDisplay();
            closeModal('achatModal');
        }

        function deleteAchat(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet achat ?')) {
                pharmaData.data.achats = pharmaData.data.achats.filter(achat => achat.id !== id);
                updateDisplay();
            }
        }

        function editAchat(id) {
            const achat = pharmaData.data.achats.find(a => a.id === id);
            if (achat) {
                document.getElementById('achat-date').value = achat.date ? achat.date.split('T')[0] : '';
                document.getElementById('achat-fournisseur').value = achat.fournisseur || '';
                document.getElementById('achat-statut').value = achat.statutPaiement || 'impayé';
                
                document.getElementById('achatModal').setAttribute('data-edit-id', id);
                openModal('achatModal');
            }
        }

        // Ventes functions
        function updateVentesTable() {
            const tbody = document.getElementById('ventesTableBody');
            const ventes = pharmaData.data.ventes || [];
            
            tbody.innerHTML = '';
            
            ventes.forEach(vente => {
                const row = document.createElement('tr');
                const totalArticles = (vente.articles || []).length;
                
                row.innerHTML = `
                    <td>${formatDate(vente.date)}</td>
                    <td>${vente.client || '-'}</td>
                    <td>${totalArticles} article(s)</td>
                    <td>${(vente.montantTotal || 0).toFixed(2)}€</td>
                    <td><span class="status-badge status-${vente.statutPaiement || 'impaye'}">${vente.statutPaiement || 'Impayé'}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="editVente('${vente.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteVente('${vente.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function saveVente() {
            const modal = document.getElementById('venteModal');
            const editId = modal.getAttribute('data-edit-id');
            
            const venteData = {
                date: document.getElementById('vente-date').value,
                client: document.getElementById('vente-client').value,
                montantTotal: parseFloat(document.getElementById('vente-montant').value),
                modePaiement: document.getElementById('vente-mode').value,
                statutPaiement: document.getElementById('vente-statut').value
            };

            if (editId) {
                const index = pharmaData.data.ventes.findIndex(v => v.id === editId);
                if (index !== -1) {
                    pharmaData.data.ventes[index] = {...pharmaData.data.ventes[index], ...venteData, updatedAt: new Date().toISOString()};
                    alert('Vente modifiée avec succès !');
                }
                modal.removeAttribute('data-edit-id');
            } else {
                const newVente = {
                    id: generateId(),
                    ...venteData,
                    articles: [],
                    createdBy: "user@example.com",
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (!pharmaData.data.ventes) {
                    pharmaData.data.ventes = [];
                }
                
                pharmaData.data.ventes.push(newVente);
                alert('Vente enregistrée avec succès !');
            }

            updateDisplay();
            closeModal('venteModal');
        }

        function deleteVente(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette vente ?')) {
                pharmaData.data.ventes = pharmaData.data.ventes.filter(vente => vente.id !== id);
                updateDisplay();
            }
        }

        function editVente(id) {
            const vente = pharmaData.data.ventes.find(v => v.id === id);
            if (vente) {
                document.getElementById('vente-date').value = vente.date ? vente.date.split('T')[0] : '';
                document.getElementById('vente-client').value = vente.client || '';
                document.getElementById('vente-montant').value = vente.montantTotal || 0;
                document.getElementById('vente-mode').value = vente.modePaiement || 'Espèces';
                document.getElementById('vente-statut').value = vente.statutPaiement || 'impayé';
                
                document.getElementById('venteModal').setAttribute('data-edit-id', id);
                openModal('venteModal');
            }
        }

        // Stock functions
        function updateStockTable() {
            const tbody = document.getElementById('stockTableBody');
            const stock = pharmaData.data.stock || [];
            
            tbody.innerHTML = '';
            
            stock.forEach(item => {
                const row = document.createElement('tr');
                const lowStock = item.quantite <= item.seuil;
                
                row.innerHTML = `
                    <td>${item.nom || '-'}</td>
                    <td style="color: ${lowStock ? 'red' : 'black'}; font-weight: ${lowStock ? 'bold' : 'normal'}">${item.quantite || 0}</td>
                    <td>${item.seuil || 0}</td>
                    <td>${(item.prixAchat || 0).toFixed(2)}€</td>
                    <td>${(item.prixVente || 0).toFixed(2)}€</td>
                    <td>${item.dernierFournisseur || '-'}</td>
                    <td>${formatDate(item.datePeremption)}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editStock('${item.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteStock('${item.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function saveStock() {
            const modal = document.getElementById('stockModal');
            const editId = modal.getAttribute('data-edit-id');
            
            const stockData = {
                nom: document.getElementById('stock-nom').value,
                quantite: parseInt(document.getElementById('stock-quantite').value),
                seuil: parseInt(document.getElementById('stock-seuil').value),
                prixAchat: parseFloat(document.getElementById('stock-prix-achat').value),
                prixVente: parseFloat(document.getElementById('stock-prix-vente').value),
                dernierFournisseur: document.getElementById('stock-fournisseur').value,
                datePeremption: document.getElementById('stock-peremption').value
            };

            if (editId) {
                const index = pharmaData.data.stock.findIndex(s => s.id === editId);
                if (index !== -1) {
                    pharmaData.data.stock[index] = {...pharmaData.data.stock[index], ...stockData};
                    alert('Article modifié avec succès !');
                }
                modal.removeAttribute('data-edit-id');
            } else {
                const newStock = {
                    id: generateId(),
                    ...stockData,
                    creePar: "current_user",
                    creeParEmail: "user@example.com",
                    creeLe: new Date().toISOString()
                };

                if (!pharmaData.data.stock) {
                    pharmaData.data.stock = [];
                }
                
                pharmaData.data.stock.push(newStock);
                alert('Article ajouté au stock avec succès !');
            }

            updateDisplay();
            closeModal('stockModal');
        }

        function deleteStock(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet article du stock ?')) {
                pharmaData.data.stock = pharmaData.data.stock.filter(item => item.id !== id);
                updateDisplay();
            }
        }

        function editStock(id) {
            const stock = pharmaData.data.stock.find(s => s.id === id);
            if (stock) {
                document.getElementById('stock-nom').value = stock.nom || '';
                document.getElementById('stock-quantite').value = stock.quantite || 0;
                document.getElementById('stock-seuil').value = stock.seuil || 5;
                document.getElementById('stock-prix-achat').value = stock.prixAchat || 0;
                document.getElementById('stock-prix-vente').value = stock.prixVente || 0;
                document.getElementById('stock-fournisseur').value = stock.dernierFournisseur || '';
                document.getElementById('stock-peremption').value = stock.datePeremption ? stock.datePeremption.split('T')[0] : '';
                
                document.getElementById('stockModal').setAttribute('data-edit-id', id);
                openModal('stockModal');
            }
        }

        // Paiements functions
        function updatePaiementsTable() {
            const tbody = document.getElementById('paiementsTableBody');
            const paiements = pharmaData.data.paiements || [];
            
            tbody.innerHTML = '';
            
            paiements.forEach(paiement => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${formatDate(paiement.date)}</td>
                    <td><span class="status-badge ${paiement.type === 'ventes' ? 'status-paye' : 'status-impaye'}">${paiement.type || '-'}</span></td>
                    <td>${(paiement.montant || 0).toFixed(2)}€</td>
                    <td>${paiement.mode || '-'}</td>
                    <td>${paiement.createdBy || '-'}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editPaiement('${paiement.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deletePaiement('${paiement.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function savePaiement() {
            const modal = document.getElementById('paiementModal');
            const editId = modal.getAttribute('data-edit-id');
            
            const paiementData = {
                date: document.getElementById('paiement-date').value,
                type: document.getElementById('paiement-type').value,
                montant: parseFloat(document.getElementById('paiement-montant').value),
                mode: document.getElementById('paiement-mode').value
            };

            if (editId) {
                const index = pharmaData.data.paiements.findIndex(p => p.id === editId);
                if (index !== -1) {
                    pharmaData.data.paiements[index] = {...pharmaData.data.paiements[index], ...paiementData};
                    alert('Paiement modifié avec succès !');
                }
                modal.removeAttribute('data-edit-id');
            } else {
                const newPaiement = {
                    id: generateId(),
                    ...paiementData,
                    createdBy: "user@example.com",
                    docId: generateId()
                };

                if (!pharmaData.data.paiements) {
                    pharmaData.data.paiements = [];
                }
                
                pharmaData.data.paiements.push(newPaiement);
                alert('Paiement enregistré avec succès !');
            }

            updateDisplay();
            closeModal('paiementModal');
        }

        function deletePaiement(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce paiement ?')) {
                pharmaData.data.paiements = pharmaData.data.paiements.filter(paiement => paiement.id !== id);
                updateDisplay();
            }
        }

        function editPaiement(id) {
            const paiement = pharmaData.data.paiements.find(p => p.id === id);
            if (paiement) {
                document.getElementById('paiement-date').value = paiement.date ? paiement.date.split('T')[0] : '';
                document.getElementById('paiement-type').value = paiement.type || 'ventes';
                document.getElementById('paiement-montant').value = paiement.montant || 0;
                document.getElementById('paiement-mode').value = paiement.mode || 'Espèces';
                
                document.getElementById('paiementModal').setAttribute('data-edit-id', id);
                openModal('paiementModal');
            }
        }

        // Users functions
        function updateUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            const users = pharmaData.data.users || [];
            
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.displayName || user.nom || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td><span class="status-badge status-paye">${user.role || '-'}</span></td>
                    <td><span class="status-badge ${user.active !== false ? 'status-paye' : 'status-impaye'}">${user.active !== false ? 'Actif' : 'Inactif'}</span></td>
                    <td>${formatDate(user.derniereConnexion || user.createdAt)}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editUser('${user.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function saveUser() {
            const modal = document.getElementById('userModal');
            const editId = modal.getAttribute('data-edit-id');
            
            const userData = {
                displayName: document.getElementById('user-nom').value,
                email: document.getElementById('user-email').value,
                role: document.getElementById('user-role').value,
                telephone: document.getElementById('user-telephone').value
            };

            if (editId) {
                const index = pharmaData.data.users.findIndex(u => u.id === editId);
                if (index !== -1) {
                    pharmaData.data.users[index] = {...pharmaData.data.users[index], ...userData, modifiedAt: new Date().toISOString()};
                    alert('Utilisateur modifié avec succès !');
                }
                modal.removeAttribute('data-edit-id');
            } else {
                const newUser = {
                    id: generateId(),
                    ...userData,
                    active: true,
                    createdAt: new Date().toISOString(),
                    modifiedAt: new Date().toISOString(),
                    createdBy: "admin"
                };

                if (!pharmaData.data.users) {
                    pharmaData.data.users = [];
                }
                
                pharmaData.data.users.push(newUser);
                alert('Utilisateur créé avec succès !');
            }

            updateDisplay();
            closeModal('userModal');
        }

        function deleteUser(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
                pharmaData.data.users = pharmaData.data.users.filter(user => user.id !== id);
                updateDisplay();
            }
        }

        function editUser(id) {
            const user = pharmaData.data.users.find(u => u.id === id);
            if (user) {
                document.getElementById('user-nom').value = user.displayName || user.nom || '';
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('user-role').value = user.role || 'vendeuse';
                document.getElementById('user-telephone').value = user.telephone || '';
                
                document.getElementById('userModal').setAttribute('data-edit-id', id);
                openModal('userModal');
            }
        }

        // Utility functions
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR');
            } catch (e) {
                return '-';
            }
        }

        function searchTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            
            searchTerm = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let found = false;
                
                cells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                    }
                });
                
                row.style.display = found ? '' : 'none';
            });
        }

        // Import/Export functions
        function exportData() {
            pharmaData.metadata.exportDate = new Date().toISOString();
            pharmaData.metadata.exportDateFr = new Date().toLocaleDateString('fr-FR') + ' à ' + new Date().toLocaleTimeString('fr-FR');
            
            const dataStr = JSON.stringify(pharmaData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pharma-gestion-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function resetData() {
            if (confirm('Êtes-vous sûr de vouloir réinitialiser toutes les données ? Cette action est irréversible.')) {
                pharmaData = {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        exportDateFr: new Date().toLocaleDateString('fr-FR'),
                        societeName: "NOUVELLE PHARMACIE",
                        version: "1.2",
                        appName: "Pharma Gestion"
                    },
                    data: {
                        achats: [],
                        ventes: [],
                        stock: [],
                        paiements: [],
                        users: []
                    }
                };
                updateDisplay();
                alert('Données réinitialisées avec succès !');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                exportData();
            }
            
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal[style*="block"]');
                openModals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // Initialize display on page load
        updateDisplay();
    </script>
</body>
</html>
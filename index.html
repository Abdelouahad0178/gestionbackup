<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pharma Gestion Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0f766e;
            --primary-dark: #0d5c5a;
            --primary-light: #f0fdfa;
            --accent-color: #06b6d4;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #ea580c;
            --danger-color: #dc2626;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --surface-secondary: #f1f5f9;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        /* ===== SIDEBAR PROFESSIONNEL ===== */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, var(--surface-color) 0%, #fcfcfc 100%);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
        }

        .sidebar-header {
            padding: 28px 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--surface-color);
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            letter-spacing: -0.025em;
        }

        .logo-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--warning-color);
            box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.2);
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--success-color);
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.2);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sidebar-nav {
            flex: 1;
            padding: 24px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            padding: 0 24px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
            margin: 2px 12px;
            border-radius: var(--radius-lg);
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: var(--primary-color);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            min-width: 24px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-color);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 24px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .nav-item.active .nav-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid var(--border-light);
            background: var(--surface-secondary);
        }

        /* ===== MAIN CONTENT PROFESSIONNEL ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--background-color);
        }

        .main-header {
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .main-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
        }

        .header-left h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: -0.025em;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            background: var(--background-color);
        }

        /* ===== BOUTONS PROFESSIONNELS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-primary);
            border-color: var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            background: var(--surface-secondary);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #c2410c 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #b91c1c 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 0.8rem;
        }

        .btn-lg {
            padding: 16px 28px;
            font-size: 1rem;
            font-weight: 700;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ===== CARDS MÉDICALES ===== */
        .card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            transition: box-shadow 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-content {
            padding: 28px;
        }

        /* ===== DASHBOARD MÉDICAL ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 28px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .metric-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .metric-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }

        /* ===== TABLES PROFESSIONNELLES ===== */
        .table-container {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .table-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-actions {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            min-width: 280px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
            background: var(--surface-color);
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1);
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px 20px;
            text-align: left;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        tr:hover {
            background: var(--primary-light);
        }

        tr:nth-child(even) {
            background: rgba(248, 250, 252, 0.5);
        }

        tr:nth-child(even):hover {
            background: var(--primary-light);
        }

        /* ===== STATUS BADGES MÉDICAUX ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-paid {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #a7f3d0;
        }

        .status-unpaid {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-partial {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #facc15;
        }

        .stock-low {
            color: var(--danger-color);
            font-weight: 700;
            animation: blink 1.5s infinite;
        }

        .stock-ok {
            color: var(--success-color);
            font-weight: 600;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ===== MODALS PROFESSIONNELS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        .modal-header {
            padding: 28px 28px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 0;
            padding-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--surface-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--danger-color);
            color: white;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 28px;
        }

        .modal-footer {
            padding: 0 28px 28px;
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-light);
            padding-top: 20px;
            margin-top: 20px;
        }

        /* ===== FORMULAIRES MÉDICAUX ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-input, .form-select {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
            background: var(--surface-color);
            font-weight: 500;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1);
            background: white;
        }

        .form-input:invalid {
            border-color: var(--danger-color);
        }

        /* ===== ALERTES MÉDICALES ===== */
        .alert {
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #facc15;
        }

        .alert-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* ===== ÉTAT VIDE PROFESSIONNEL ===== */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-light) 0%, #e6fffa 100%);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2rem;
            color: var(--primary-color);
        }

        .empty-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .empty-description {
            font-size: 0.95rem;
            margin-bottom: 32px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        /* ===== SECTIONS ARTICLES ===== */
        .article-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid var(--border-light);
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: var(--surface-secondary);
            border-radius: var(--radius-lg);
        }

        .article-item {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .article-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .article-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .total-display {
            background: linear-gradient(135deg, var(--primary-light) 0%, #e6fffa 100%);
            border: 2px solid var(--primary-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 24px;
            text-align: center;
        }

        .total-amount {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* ===== ACCÈS RAPIDE CAISSE ===== */
        .quick-actions {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .quick-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        .quick-btn.primary {
            width: 70px;
            height: 70px;
            font-size: 1.8rem;
        }

        /* ===== AMÉLIORATION LOADING ===== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            flex-direction: column;
            gap: 16px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-muted);
            font-weight: 500;
        }

        /* ===== PROGRESS PROFESSIONNEL ===== */
        .progress {
            width: 100%;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
            transition: width 0.3s ease;
            border-radius: 6px;
        }

        /* ===== CAPACITÉ AMÉLIORÉE ===== */
        .capacity-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .capacity-line:last-child {
            border-bottom: none;
        }

        .muted {
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* ===== RESPONSIVE MÉDICAL ===== */
        @media (max-width: 1024px) {
            .sidebar {
                width: 260px;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -300px;
                height: 100%;
                z-index: 200;
                transition: left 0.3s ease;
                width: 300px;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                width: 100%;
            }

            .content-area {
                padding: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .table-actions {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            .main-header {
                padding: 16px 20px;
            }

            .header-left h1 {
                font-size: 1.5rem;
            }

            .quick-actions {
                bottom: 16px;
                right: 16px;
            }

            .quick-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .quick-btn.primary {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }

        /* ===== MENU MOBILE ===== */
        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* ===== AMÉLIORATIONS TACTILES ===== */
        @media (hover: none) {
            .btn, .nav-item, .metric-card {
                transition: none;
            }
            
            .btn:hover, .nav-item:hover, .metric-card:hover {
                transform: none;
            }
        }

        /* ===== SCROLL PERSONNALISÉ ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ===== NOUVELLES CLASSES UTILITAIRES ===== */
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success-color); }
        .text-warning { color: var(--warning-color); }
        .text-danger { color: var(--danger-color); }

        .bg-primary { background: var(--primary-color); }
        .bg-surface { background: var(--surface-color); }
        .bg-secondary { background: var(--surface-secondary); }

        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }

        .rounded-sm { border-radius: var(--radius-sm); }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }

        /* ===== AMÉLIORATIONS SPÉCIFIQUES PHARMACIE ===== */
        .prescription-badge {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #facc15;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .expiry-warning {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid #fca5a5;
        }

        .barcode-scanner {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px dashed var(--accent-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            color: var(--accent-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .barcode-scanner:hover {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
    </style>
</head>
<body>
<div class="app-layout">
    <!-- Sidebar Professionnel -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-clinic-medical"></i>
                Pharma Gestion
            </div>
            <div class="logo-subtitle">Système Professionnel</div>
        </div>

        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Mode Hors Ligne</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-title">Navigation</div>
                <button class="nav-item active" onclick="showSection('dashboard', event)">
                    <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                    Tableau de bord
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-title">Gestion</div>
                <button class="nav-item" onclick="showSection('stock', event)">
                    <div class="nav-icon"><i class="fas fa-boxes"></i></div>
                    Inventaire
                    <div class="nav-badge" id="stockBadge">0</div>
                </button>
                <button class="nav-item" onclick="showSection('ventes', event)">
                    <div class="nav-icon"><i class="fas fa-cash-register"></i></div>
                    Ventes
                    <div class="nav-badge" id="ventesBadge">0</div>
                </button>
                <button class="nav-item" onclick="showSection('achats', event)">
                    <div class="nav-icon"><i class="fas fa-truck"></i></div>
                    Achats
                    <div class="nav-badge" id="achatsBadge">0</div>
                </button>
                <button class="nav-item" onclick="showSection('paiements', event)">
                    <div class="nav-icon"><i class="fas fa-credit-card"></i></div>
                    Paiements
                    <div class="nav-badge" id="paiementsBadge">0</div>
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-title">Données</div>
                <div class="file-input-wrapper">
                    <input type="file" id="importFile" class="file-input" accept=".json" style="display: none;">
                    <button class="nav-item" onclick="document.getElementById('importFile').click()">
                        <div class="nav-icon"><i class="fas fa-file-import"></i></div>
                        Importer
                    </button>
                </div>
                <button class="nav-item" id="exportBtn" onclick="exportData()" disabled>
                    <div class="nav-icon"><i class="fas fa-file-export"></i></div>
                    Exporter
                </button>
                <button class="nav-item" onclick="openCapacityModal()">
                    <div class="nav-icon"><i class="fas fa-database"></i></div>
                    Stockage
                </button>
            </div>
        </nav>

        <div class="sidebar-footer">
            <button class="btn btn-danger btn-sm" onclick="clearAllData()" style="width: 100%;">
                <i class="fas fa-trash-alt"></i>
                Réinitialiser
            </button>
        </div>
    </div>

    <!-- Contenu Principal -->
    <div class="main-content">
        <div class="main-header">
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h1 id="pageTitle">Tableau de bord</h1>
                    <div class="header-subtitle" id="pageSubtitle">Vue d'ensemble de votre pharmacie</div>
                </div>
            </div>
            <div class="header-actions" id="headerActions"></div>
        </div>

        <div class="content-area" id="contentArea">
            <!-- Dashboard Médical -->
            <div id="section-dashboard" class="section active">
                <div id="dashboardEmpty" class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-clinic-medical"></i>
                    </div>
                    <div class="empty-title">Bienvenue dans Pharma Gestion Pro</div>
                    <div class="empty-description">
                        Importez vos données JSON pour commencer à gérer votre pharmacie de manière professionnelle
                    </div>
                    <button class="btn btn-primary btn-lg" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload"></i>
                        Commencer
                    </button>
                </div>
                <div id="dashboardContent" style="display:none;">
                    <div class="dashboard-grid" id="dashboardMetrics"></div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                Alertes de Stock
                            </div>
                        </div>
                        <div class="card-content" id="stockAlerts"></div>
                    </div>
                </div>
            </div>

            <!-- Sections -->
            <div id="section-stock" class="section" style="display:none;"></div>
            <div id="section-ventes" class="section" style="display:none;"></div>
            <div id="section-achats" class="section" style="display:none;"></div>
            <div id="section-paiements" class="section" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- Actions Rapides Flottantes -->
<div class="quick-actions">
    <button class="quick-btn" onclick="openQuickSale()" title="Vente rapide">
        <i class="fas fa-cash-register"></i>
    </button>
    <button class="quick-btn" onclick="openQuickSearch()" title="Recherche rapide">
        <i class="fas fa-search"></i>
    </button>
    <button class="quick-btn primary" onclick="showSection('ventes')" title="Caisse">
        <i class="fas fa-shopping-cart"></i>
    </button>
</div>

<!-- Conteneur d'alertes -->
<div id="alertsContainer" style="position:fixed;top:20px;right:20px;z-index:1100;max-width:400px;"></div>

<!-- Modal d'édition -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="editModalTitle">
                <i class="fas fa-plus-circle"></i>
                Ajouter
            </div>
            <button class="modal-close" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="editModalBody"></div>
    </div>
</div>

<!-- Modal de confirmation -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-question-circle text-warning"></i>
                Confirmation
            </div>
            <button class="modal-close" onclick="closeConfirmModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage" style="font-size: 1rem; line-height: 1.6;"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeConfirmModal()">
                <i class="fas fa-times"></i>
                Annuler
            </button>
            <button class="btn btn-danger" id="confirmButton">
                <i class="fas fa-check"></i>
                Confirmer
            </button>
        </div>
    </div>
</div>

<!-- Modal de progression -->
<div id="progressModal" class="modal">
    <div class="modal-content" style="max-width:450px;">
        <div class="modal-body">
            <div class="loading">
                <div class="spinner"></div>
                <div class="loading-text" id="progressText">Traitement en cours...</div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width:0%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de capacité -->
<div id="capacityModal" class="modal">
    <div class="modal-content" style="max-width:520px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-database"></i>
                Capacité de stockage
            </div>
            <button class="modal-close" onclick="closeCapacityModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="capacityBody">
            <div class="loading">
                <div class="spinner"></div>
                <div class="loading-text">Analyse en cours...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="refreshCapacity()">
                <i class="fas fa-sync-alt"></i>
                Actualiser
            </button>
            <button class="btn btn-primary" onclick="requestPersistence()">
                <i class="fas fa-lock"></i>
                Demander persistance
            </button>
        </div>
    </div>
</div>

<!-- Modal Vente Rapide -->
<div id="quickSaleModal" class="modal">
    <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-bolt"></i>
                Vente Rapide
            </div>
            <button class="modal-close" onclick="closeQuickSaleModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="barcode-scanner" onclick="simulateBarcodeScan()">
                <i class="fas fa-barcode" style="font-size: 2rem; margin-bottom: 8px;"></i>
                <div>Scanner code-barres</div>
                <div style="font-size: 0.8rem; margin-top: 4px; opacity: 0.7;">Ou cliquez pour simulation</div>
            </div>
            
            <div id="quickSaleContent" style="margin-top: 24px;">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-pills"></i>
                        Recherche produit
                    </label>
                    <input type="text" class="form-input" id="quickProductSearch" 
                           placeholder="Nom du produit ou code-barres..." 
                           oninput="searchProducts(this.value)">
                </div>
                
                <div id="productSuggestions" style="max-height: 200px; overflow-y: auto; margin-top: 12px;"></div>
                
                <div id="quickSaleItems" style="margin-top: 24px;"></div>
                
                <div class="total-display" id="quickSaleTotal" style="display: none;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 4px;">
                        Total à payer
                    </div>
                    <div class="total-amount" id="quickTotalAmount">0.00 DHS</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="clearQuickSale()">
                <i class="fas fa-trash"></i>
                Effacer
            </button>
            <button class="btn btn-success btn-lg" onclick="processQuickSale()" id="quickSaleProcess" disabled>
                <i class="fas fa-check-circle"></i>
                Finaliser la vente
            </button>
        </div>
    </div>
</div>

<!-- Modal Recherche Rapide -->
<div id="quickSearchModal" class="modal">
    <div class="modal-content" style="max-width:700px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-search"></i>
                Recherche Rapide
            </div>
            <button class="modal-close" onclick="closeQuickSearchModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <input type="text" class="form-input" id="globalSearch" 
                       placeholder="Rechercher produit, client, fournisseur..." 
                       style="font-size: 1.1rem; padding: 16px 20px;"
                       oninput="performGlobalSearch(this.value)">
            </div>
            <div id="searchResults" style="margin-top: 20px; max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<script>
/* ===================== Variables globales ===================== */
let currentData = null;
let originalData = null;
let currentSection = 'dashboard';
let editingItem = null;
let editingIndex = null;
let searchFilter = '';
let quickSaleItems = [];

/* ===================== IndexedDB (même logique) ===================== */
const IDB_AVAILABLE = !!window.indexedDB;
const DB_NAME = 'pharma-gestion-pro';
const DB_VERSION = 1;
const STORE = 'kv';

function openDB(){
    return new Promise((resolve, reject) => {
        if (!IDB_AVAILABLE){ return reject(new Error('IndexedDB non disponible')); }
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(STORE)){
                db.createObjectStore(STORE, { keyPath: 'key' });
            }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error || new Error('Impossible d\'ouvrir IndexedDB'));
    });
}

function idbTx(mode, fn){
    return openDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, mode);
        const store = tx.objectStore(STORE);
        let out;
        try { out = fn(store); } catch (e){ reject(e); return; }
        tx.oncomplete = () => resolve(out);
        tx.onerror = () => reject(tx.error || new Error('Transaction échouée'));
    }));
}

function idbGet(key){
    if (!IDB_AVAILABLE){
        try { return Promise.resolve(JSON.parse(localStorage.getItem(key))); } catch { return Promise.resolve(null); }
    }
    return idbTx('readonly', store => new Promise((resolve, reject) => {
        const r = store.get(key);
        r.onsuccess = () => resolve(r.result ? r.result.value : null);
        r.onerror = () => reject(r.error);
    }));
}
function idbSet(key, value){
    if (!IDB_AVAILABLE){
        try { localStorage.setItem(key, JSON.stringify(value)); return Promise.resolve(true); } catch(e){ return Promise.reject(e); }
    }
    return idbTx('readwrite', store => new Promise((resolve, reject) => {
        const r = store.put({ key, value });
        r.onsuccess = () => resolve(true);
        r.onerror = () => reject(r.error);
    }));
}
function idbDelete(key){
    if (!IDB_AVAILABLE){
        try { localStorage.removeItem(key); return Promise.resolve(true); } catch(e){ return Promise.reject(e); }
    }
    return idbTx('readwrite', store => new Promise((resolve, reject) => {
        const r = store.delete(key);
        r.onsuccess = () => resolve(true);
        r.onerror = () => reject(r.error);
    }));
}
function idbClear(){
    if (!IDB_AVAILABLE){
        ['pharmaData','pharmaDataOriginal','lastImport','lastModified'].forEach(k => localStorage.removeItem(k));
        return Promise.resolve(true);
    }
    return idbTx('readwrite', store => new Promise((resolve, reject) => {
        const r = store.clear();
        r.onsuccess = () => resolve(true);
        r.onerror = () => reject(r.error);
    }));
}

/* ===== Migration auto depuis localStorage ===== */
async function maybeMigrateFromLocalStorage(){
    try{
        const already = await idbGet('pharmaData');
        if (already) return;

        const lsData = localStorage.getItem('pharmaData');
        if (!lsData) return;

        const data = JSON.parse(lsData);
        await idbSet('pharmaData', data);
        const orig = localStorage.getItem('pharmaDataOriginal');
        await idbSet('pharmaDataOriginal', orig ? JSON.parse(orig) : JSON.parse(lsData));
        const li = localStorage.getItem('lastImport');
        if (li) await idbSet('lastImport', li);
        const lm = localStorage.getItem('lastModified');
        if (lm) await idbSet('lastModified', lm);

        ['pharmaData','pharmaDataOriginal','lastImport','lastModified'].forEach(k => localStorage.removeItem(k));
        showAlert('Migration vers IndexedDB terminée', 'success');
    }catch(e){
        console.warn('Migration localStorage -> IDB: ', e);
    }
}

/* ===================== Initialisation ===================== */
document.addEventListener('DOMContentLoaded', async function() {
    updateConnectionStatus();
    if (!IDB_AVAILABLE){
        showAlert("IndexedDB indisponible, utilisation du localStorage", "warning");
    }
    await maybeMigrateFromLocalStorage();
    await loadStoredData();
    setupEventListeners();
    setupKeyboardShortcuts();
});

/* ===================== Raccourcis clavier ===================== */
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case '1': e.preventDefault(); showSection('dashboard'); break;
                case '2': e.preventDefault(); showSection('stock'); break;
                case '3': e.preventDefault(); showSection('ventes'); break;
                case '4': e.preventDefault(); showSection('achats'); break;
                case '5': e.preventDefault(); showSection('paiements'); break;
                case 'k': e.preventDefault(); openQuickSearch(); break;
                case 'n': e.preventDefault(); if(currentSection !== 'dashboard') openAddModal(currentSection); break;
            }
        }
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
        }
    });
}

/* ===================== Écouteurs ===================== */
function setupEventListeners() {
    document.getElementById('importFile').addEventListener('change', handleFileImport);
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            if (event.target.id !== 'progressModal') {
                event.target.style.display = 'none';
            }
        }
    });
    
    // Drag & drop amélioré
    const dropZone = document.body;
    dropZone.addEventListener('dragover', function(e) { 
        e.preventDefault(); 
        e.stopPropagation();
        dropZone.style.background = 'linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%)';
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault(); 
        e.stopPropagation();
        dropZone.style.background = '';
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault(); 
        e.stopPropagation();
        dropZone.style.background = '';
        const files = e.dataTransfer.files;
        if (files.length > 0 && (files[0].type === 'application/json' || files[0].name.endsWith('.json'))) {
            handleFileImport({ target: { files: files } });
        }
    });
}

/* ===================== Statut connexion ===================== */
function updateConnectionStatus() {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    if (navigator.onLine) { 
        dot.classList.add('online'); 
        text.innerHTML = '<i class="fas fa-wifi"></i> En ligne'; 
    } else { 
        dot.classList.remove('online'); 
        text.innerHTML = '<i class="fas fa-wifi-slash"></i> Hors ligne'; 
    }
}

/* ===================== Menu mobile ===================== */
function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('open');
}

/* ===================== Import fichier (même logique) ===================== */
async function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    showProgress('Lecture du fichier...', 10);
    try {
        const text = await file.text();
        showProgress('Analyse des données...', 30);
        const data = JSON.parse(text);
        showProgress('Validation...', 50);
        if (!data || typeof data !== 'object') throw new Error('Fichier JSON invalide');

        initializeDataStructure(data);
        showProgress('Sauvegarde...', 70);
        await saveToLocal(data);

        showProgress('Mise à jour interface...', 90);
        currentData = data;
        originalData = JSON.parse(JSON.stringify(data));
        updateInterface();
        showSection('dashboard');

        showProgress('Terminé!', 100);
        setTimeout(() => { 
            hideProgress(); 
            showAlert('Données importées avec succès!', 'success'); 
        }, 400);
    } catch (error) {
        hideProgress();
        showAlert('Erreur: ' + error.message, 'error');
    }
}

/* ===================== Init structure (même logique) ===================== */
function initializeDataStructure(data) {
    if (!data.metadata) data.metadata = {};
    if (!data.data) data.data = {};
    const collections = ['achats', 'ventes', 'stock', 'paiements'];
    collections.forEach(col => { if (!data.data[col]) data.data[col] = []; });
}

/* ===================== Stockage (même logique) ===================== */
async function saveToLocal(data) {
    await idbSet('pharmaData', data);
    await idbSet('pharmaDataOriginal', data);
    await idbSet('lastImport', new Date().toISOString());
}
async function loadStoredData() {
    try {
        const stored = await idbGet('pharmaData');
        if (stored) {
            currentData = stored;
            originalData = (await idbGet('pharmaDataOriginal')) || JSON.parse(JSON.stringify(stored));
            updateInterface();
        } else {
            updateNavBadges();
        }
    } catch (error) {
        showAlert('Erreur de chargement des données locales', 'error');
    }
}
async function saveData() {
    if (currentData) {
        await idbSet('pharmaData', currentData);
        await idbSet('lastModified', new Date().toISOString());
    }
}

/* ===================== Parsing robuste (même logique) ===================== */
function parseNumeric(val){
    if (typeof val === 'number') return val;
    if (typeof val !== 'string') return NaN;
    let s = val.trim().replace(/\s+/g,'').replace(/'/g,'');
    s = s.replace(/[^0-9.,-]/g,'');
    const lastComma = s.lastIndexOf(',');
    const lastDot = s.lastIndexOf('.');
    let decSep = null;
    if (lastComma > lastDot) decSep = ',';
    else if (lastDot > lastComma) decSep = '.';
    if (decSep){
        const parts = s.split(decSep);
        const intPart = parts.slice(0,-1).join(decSep).replace(/[.,]/g,'');
        const fracPart = parts[parts.length-1];
        s = intPart + '.' + fracPart;
    } else {
        s = s.replace(/[.,]/g,'');
    }
    const n = parseFloat(s);
    return Number.isNaN(n) ? NaN : n;
}
function trouverMontantBrut(obj, cles = ['totalTTC','ttc','montant','total','netAPayer','amount','paid','due']){
    if (!obj || typeof obj !== 'object') return NaN;
    for (const cle of cles) {
        if (obj[cle] !== undefined && obj[cle] !== null){
            const n = parseNumeric(obj[cle]);
            if (!Number.isNaN(n)) return n;
        }
    }
    const nests = ['totals','total','amount','payment','paiement','resume','summary'];
    for (const key of nests){
        if (obj[key] && typeof obj[key] === 'object'){
            const n = trouverMontantBrut(obj[key], cles);
            if (!Number.isNaN(n)) return n;
        }
    }
    for (const k in obj){
        const v = obj[k];
        if (v && typeof v === 'object'){
            if (k.toLowerCase() === 'articles') continue;
            const n = trouverMontantBrut(v, cles);
            if (!Number.isNaN(n)) return n;
        }
    }
    return NaN;
}
function calculerDepuisArticles(item, type){
    if (!item || !Array.isArray(item.articles)) return NaN;
    let total = 0;
    if (type === 'achat'){
        item.articles.forEach(a => {
            const q = parseNumeric(a.quantite) || 0;
            const p = parseNumeric(a.prixAchat) || 0;
            total += q * p;
        });
        const remise = parseNumeric(item.remiseGlobale) || 0;
        total = total - total * (remise/100);
    } else if (type === 'vente'){
        item.articles.forEach(a => {
            const q = parseNumeric(a.quantite) || 0;
            const p = parseNumeric(a.prixUnitaire) || 0;
            const st = q * p;
            const r = parseNumeric(a.remise) || 0;
            total += st - (st * r / 100);
        });
    }
    return total;
}
function montantAchat(item){
    let n = trouverMontantBrut(item, ['totalTTC','ttc','montant','total','netAPayer','amount']);
    if (Number.isNaN(n)) n = calculerDepuisArticles(item, 'achat');
    return Number.isNaN(n) ? 0 : n;
}
function montantVente(item){
    let n = trouverMontantBrut(item, ['totalTTC','ttc','netAPayer','montant','total','amount']);
    if (Number.isNaN(n)) n = calculerDepuisArticles(item, 'vente');
    return Number.isNaN(n) ? 0 : n;
}

/* ===================== Interface améliorée ===================== */
function updateInterface() {
    if (!currentData) return;
    updateNavBadges();
    updateDashboard();
    updateAllSections();
    document.getElementById('exportBtn').disabled = false;
}

function updateNavBadges() {
    const badges = {
        stock: document.getElementById('stockBadge'),
        ventes: document.getElementById('ventesBadge'),
        achats: document.getElementById('achatsBadge'),
        paiements: document.getElementById('paiementsBadge')
    };
    if (!currentData || !currentData.data) {
        Object.values(badges).forEach(b => { if (b) b.textContent = '0'; });
        return;
    }
    Object.entries(badges).forEach(([key, badge]) => {
        if (badge) {
            const arr = Array.isArray(currentData.data[key]) ? currentData.data[key] : [];
            badge.textContent = arr.length;
        }
    });
}

function updateDashboard() {
    const emptyState = document.getElementById('dashboardEmpty');
    const content = document.getElementById('dashboardContent');
    if (!currentData || !currentData.data) { 
        emptyState.style.display='block'; 
        content.style.display='none'; 
        return; 
    }
    emptyState.style.display='none'; 
    content.style.display='block';
    
    const metrics = calculateMetrics();
    updateDashboardMetrics(metrics);
    updateStockAlerts();
}

function calculateMetrics() {
    const data = currentData.data;
    let totalStock = 0, stockFaible = 0, ventesToday = 0, ventesAmount = 0, achatsAmount = 0;

    if (data.stock) {
        totalStock = data.stock.length;
        stockFaible = data.stock.filter(item => (parseInt(item.quantite)||0) <= (parseInt(item.seuil)||5)).length;
    }

    const today = new Date().toISOString().split('T')[0];
    if (data.ventes) {
        const ventesTodayList = data.ventes.filter(v => 
            (v.date && v.date.startsWith(today)) || (v.createdAt && v.createdAt.startsWith(today))
        );
        ventesToday = ventesTodayList.length;
        ventesAmount = ventesTodayList.reduce((s,v)=> s + montantVente(v), 0);
    }

    const thisMonth = new Date().toISOString().substring(0,7);
    if (data.achats) {
        const achatsThisMonth = data.achats.filter(a => 
            (a.date && a.date.startsWith(thisMonth)) || (a.createdAt && a.createdAt.startsWith(thisMonth))
        );
        achatsAmount = achatsThisMonth.reduce((s,a)=> s + montantAchat(a), 0);
    }

    return {
        totalStock, stockFaible, ventesToday, ventesAmount, achatsAmount,
        totalDocuments: Object.values(data).reduce((sum, arr) => sum + (Array.isArray(arr)?arr.length:0), 0)
    };
}

function updateDashboardMetrics(m) {
    const container = document.getElementById('dashboardMetrics');
    container.innerHTML = `
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Stock Total</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);color:#1d4ed8;">
                    <i class="fas fa-boxes"></i>
                </div>
            </div>
            <div class="metric-value">${m.totalStock.toLocaleString()}</div>
            <div class="metric-subtitle">Produits en inventaire</div>
            <div class="metric-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                +12% ce mois
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Alertes Stock</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);color:#dc2626;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="metric-value">${m.stockFaible}</div>
            <div class="metric-subtitle">Produits en rupture</div>
            ${m.stockFaible > 0 ? '<div class="metric-trend trend-down"><i class="fas fa-arrow-down"></i>Action requise</div>' : '<div class="metric-trend trend-up"><i class="fas fa-check"></i>Tout va bien</div>'}
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Ventes Aujourd'hui</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);color:#166534;">
                    <i class="fas fa-cash-register"></i>
                </div>
            </div>
            <div class="metric-value">${m.ventesToday}</div>
            <div class="metric-subtitle">${m.ventesAmount.toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</div>
            <div class="metric-trend trend-up">
                <i class="fas fa-chart-line"></i>
                Performance du jour
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Achats ce Mois</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);color:#92400e;">
                    <i class="fas fa-truck"></i>
                </div>
            </div>
            <div class="metric-value">${m.achatsAmount.toLocaleString('fr-FR', {minimumFractionDigits: 0})}</div>
            <div class="metric-subtitle">DHS investis</div>
            <div class="metric-trend trend-up">
                <i class="fas fa-trending-up"></i>
                Gestion optimisée
            </div>
        </div>
    `;
}

function updateStockAlerts() {
    const container = document.getElementById('stockAlerts');
    if (!currentData || !currentData.data.stock) { 
        container.innerHTML = '<p class="empty-description">Aucun produit en stock</p>'; 
        return; 
    }
    
    const lowStockItems = currentData.data.stock.filter(item => 
        (parseInt(item.quantite)||0) <= (parseInt(item.seuil)||5)
    );
    
    if (lowStockItems.length === 0) { 
        container.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success-color); margin-bottom: 12px;"></i>
                <p class="empty-description">Aucune alerte de stock - Tout va bien!</p>
            </div>
        `; 
        return; 
    }
    
    container.innerHTML = lowStockItems.slice(0,5).map(item => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--border-color);">
            <div>
                <div style="font-weight:600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-pills text-primary"></i>
                    ${item.nom}
                </div>
                <div style="font-size:.8rem;color:var(--text-secondary); margin-top: 4px;">
                    Stock: <span class="stock-low">${item.quantite}</span> | Seuil: ${item.seuil || 5}
                    ${item.datePeremption ? `| Expire: ${new Date(item.datePeremption).toLocaleDateString('fr-FR')}` : ''}
                </div>
            </div>
            <div class="status-badge" style="background:#fee2e2;color:#991b1b;">
                <i class="fas fa-exclamation-triangle"></i>
                Critique
            </div>
        </div>
    `).join('') + (lowStockItems.length>5 ? 
        `<div style="text-align:center;margin-top:20px;padding:12px;background:var(--surface-secondary);border-radius:var(--radius-md);">
            <span style="color:var(--text-secondary);font-weight:600;">
                <i class="fas fa-ellipsis-h"></i>
                ${lowStockItems.length - 5} autres alertes
            </span>
        </div>` : ''
    );
}

/* ===================== Navigation (améliorée) ===================== */
function showSection(sectionName, evt) {
    currentSection = sectionName;
    
    // Fermer sidebar mobile
    document.querySelector('.sidebar').classList.remove('open');
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (evt && (evt.currentTarget || evt.target)) {
        (evt.currentTarget || evt.target).classList.add('active');
    } else {
        const guessBtn = Array.from(document.querySelectorAll('.nav-item'))
            .find(b => (b.getAttribute('onclick') || '').includes(`'${sectionName}'`));
        if (guessBtn) guessBtn.classList.add('active');
    }
    
    document.querySelectorAll('.section').forEach(section => { section.style.display = 'none'; });
    const targetSection = document.getElementById(`section-${sectionName}`);
    if (targetSection) {
        targetSection.style.display = 'block';
        updateSectionContent(sectionName);
    }
    updatePageHeader(sectionName);
}

function updatePageHeader(sectionName) {
    const titles = {
        dashboard: { title: 'Tableau de bord', subtitle: 'Vue d\'ensemble de votre pharmacie', icon: 'fas fa-chart-line' },
        stock: { title: 'Gestion de l\'Inventaire', subtitle: 'Produits et niveaux de stock', icon: 'fas fa-boxes' },
        ventes: { title: 'Point de Vente', subtitle: 'Transactions et caisse', icon: 'fas fa-cash-register' },
        achats: { title: 'Commandes Fournisseurs', subtitle: 'Approvisionnement et réceptions', icon: 'fas fa-truck' },
        paiements: { title: 'Gestion des Paiements', subtitle: 'Historique financier', icon: 'fas fa-credit-card' }
    };
    
    const config = titles[sectionName] || { title: sectionName, subtitle: '', icon: 'fas fa-file' };
    document.getElementById('pageTitle').innerHTML = `<i class="${config.icon}"></i> ${config.title}`;
    document.getElementById('pageSubtitle').textContent = config.subtitle;

    const actionsContainer = document.getElementById('headerActions');
    if (sectionName !== 'dashboard') {
        actionsContainer.innerHTML = `
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Rechercher..." onkeyup="filterTable(this.value)">
                <div class="search-icon"><i class="fas fa-search"></i></div>
            </div>
            <button class="btn btn-primary" onclick="openAddModal('${sectionName}')">
                <i class="fas fa-plus"></i>
                Ajouter
            </button>
        `;
    } else {
        actionsContainer.innerHTML = `
            <button class="btn btn-primary" onclick="openQuickSale()">
                <i class="fas fa-bolt"></i>
                Vente Rapide
            </button>
        `;
    }
}

function updateSectionContent(sectionName) {
    if (sectionName === 'dashboard') { updateDashboard(); return; }
    const container = document.getElementById(`section-${sectionName}`);
    if (!container) return;

    if (!currentData || !currentData.data[sectionName] || currentData.data[sectionName].length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="${getSectionIcon(sectionName)}"></i>
                </div>
                <div class="empty-title">Aucun ${getSectionLabel(sectionName)}</div>
                <div class="empty-description">
                    Commencez par ajouter votre premier ${getSectionLabel(sectionName, true)} pour une gestion optimale
                </div>
                <button class="btn btn-primary btn-lg" onclick="openAddModal('${sectionName}')">
                    <i class="fas fa-plus"></i>
                    Ajouter ${getSectionLabel(sectionName, true)}
                </button>
            </div>
        `;
        return;
    }
    container.innerHTML = createTableView(sectionName);
}

/* ===================== Helpers sections (améliorés) ===================== */
function getSectionIcon(section) {
    const icons = { 
        stock:'fas fa-boxes', 
        ventes:'fas fa-cash-register', 
        achats:'fas fa-truck', 
        paiements:'fas fa-credit-card' 
    };
    return icons[section] || 'fas fa-file';
}

function getSectionLabel(section, singular=false) {
    const labels = {
        stock: singular ? 'produit' : 'produits en stock',
        ventes: singular ? 'vente' : 'ventes',
        achats: singular ? 'commande' : 'commandes',
        paiements: singular ? 'paiement' : 'paiements'
    };
    return labels[section] || section;
}

function createTableView(sectionName) {
    const data = currentData.data[sectionName];
    const columns = getTableColumns(sectionName);
    const filteredData = searchFilter ? data.filter(item => searchInItem(item, searchFilter)) : data;

    return `
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <i class="${getSectionIcon(sectionName)}"></i>
                    ${getSectionLabel(sectionName)} (${filteredData.length})
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            ${columns.map(col => `<th><i class="fas fa-${col.icon || 'info'}"></i> ${col.label}</th>`).join('')}
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.slice(0, 100).map((item, index) => createTableRow(item, index, columns, sectionName)).join('')}
                    </tbody>
                </table>
            </div>
            ${filteredData.length>100 ? 
                `<div style="padding:20px;text-align:center;color:var(--text-secondary);font-size:.9rem;background:var(--surface-secondary);">
                    <i class="fas fa-info-circle"></i>
                    Affichage des 100 premiers éléments sur ${filteredData.length}
                </div>` : ''}
        </div>
    `;
}

function getTableColumns(section) {
    const columns = {
        stock: [
            { key:'nom', label:'Produit', icon:'pills' },
            { key:'quantite', label:'Stock', icon:'warehouse' },
            { key:'prixVente', label:'Prix Vente', icon:'tag' },
            { key:'datePeremption', label:'Péremption', icon:'calendar-alt' },
            { key:'dernierFournisseur', label:'Fournisseur', icon:'truck' }
        ],
        ventes: [
            { key:'date', label:'Date', icon:'calendar' },
            { key:'client', label:'Client', icon:'user' },
            { key:'_montant_vente', label:'Montant', icon:'euro-sign' },
            { key:'modePaiement', label:'Paiement', icon:'credit-card' },
            { key:'statutPaiement', label:'Statut', icon:'check-circle' }
        ],
        achats: [
            { key:'date', label:'Date', icon:'calendar' },
            { key:'fournisseur', label:'Fournisseur', icon:'building' },
            { key:'_montant_achat', label:'Montant', icon:'euro-sign' },
            { key:'statutPaiement', label:'Statut', icon:'check-circle' },
            { key:'articles', label:'Articles', icon:'list' }
        ],
        paiements: [
            { key:'date', label:'Date', icon:'calendar' },
            { key:'montant', label:'Montant', icon:'euro-sign' },
            { key:'mode', label:'Mode', icon:'credit-card' },
            { key:'type', label:'Type', icon:'tag' },
            { key:'docId', label:'Document', icon:'file-alt' }
        ]
    };
    return columns[section] || [];
}

function createTableRow(item, index, columns, section) {
    let html = '<tr>';
    columns.forEach(col => {
        if (col.key === '_montant_achat') {
            html += `<td><strong>${montantAchat(item).toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong></td>`;
        } else if (col.key === '_montant_vente') {
            html += `<td><strong>${montantVente(item).toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong></td>`;
        } else {
            html += `<td>${formatCellValue(item[col.key], col.key, item)}</td>`;
        }
    });
    html += `
        <td>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-sm btn-secondary" onclick="openEditModal('${section}', ${index})" title="Modifier">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${section}', ${index})" title="Supprimer">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    html += '</tr>';
    return html;
}

function formatCellValue(value, key, item) {
    if (key === '_montant_achat') return `<strong>${montantAchat(item).toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong>`;
    if (key === '_montant_vente') return `<strong>${montantVente(item).toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong>`;

    if (value === null || value === undefined) {
        if (['totalTTC','montant','total','ttc','netAPayer'].includes(key)) {
            const amt = trouverMontantBrut(item);
            if (!Number.isNaN(amt)) return `<strong>${amt.toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong>`;
        }
        return '<span class="text-muted">—</span>';
    }
    
    switch (key) {
        case 'date':
        case 'datePeremption':
        case 'createdAt':
            try { 
                const date = new Date(value);
                const isExpiringSoon = key === 'datePeremption' && 
                    (date - new Date()) < (30 * 24 * 60 * 60 * 1000) && date > new Date();
                const isExpired = key === 'datePeremption' && date < new Date();
                let dateStr = date.toLocaleDateString('fr-FR');
                if (isExpired) dateStr = `<span class="expiry-warning"><i class="fas fa-exclamation-triangle"></i> ${dateStr}</span>`;
                else if (isExpiringSoon) dateStr = `<span style="color: var(--warning-color); font-weight: 600;"><i class="fas fa-clock"></i> ${dateStr}</span>`;
                return dateStr;
            } catch(e){ return String(value); }
        case 'totalTTC':
        case 'totalHT':
        case 'montant':
        case 'prixVente':
        case 'prixAchat':
        case 'ttc': {
            const n = parseNumeric(value) || 0;
            return `<strong>${n.toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong>`;
        }
        case 'quantite':
        case 'stock':
        case 'seuil': {
            const qty = parseInt(value)||0;
            const seuil = parseInt(item.seuil)||5;
            const className = qty <= seuil ? 'stock-low' : 'stock-ok';
            const icon = qty <= seuil ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
            return `<span class="${className}"><i class="${icon}"></i> ${qty}</span>`;
        }
        case 'statutPaiement': {
            const icons = { 'payé': 'fas fa-check-circle', 'impayé': 'fas fa-times-circle', 'partiel': 'fas fa-clock' };
            const statusClass = value === 'payé' ? 'status-paid' : value === 'impayé' ? 'status-unpaid' : 'status-partial';
            return `<span class="status-badge ${statusClass}"><i class="${icons[value] || 'fas fa-question'}"></i> ${value}</span>`;
        }
        case 'modePaiement': {
            const icons = { 
                'Espèces': 'fas fa-money-bill-wave', 
                'Carte': 'fas fa-credit-card', 
                'Chèque': 'fas fa-money-check', 
                'Virement': 'fas fa-university' 
            };
            return `<i class="${icons[value] || 'fas fa-payment'}" style="margin-right: 6px;"></i>${value}`;
        }
        case 'articles':
            if (Array.isArray(value)) {
                const count = value.length;
                const preview = value.slice(0,2).map(a => a.produit || 'N/A').join(', ');
                return `<span title="${value.map(a => a.produit).join(', ')}">
                    <i class="fas fa-list" style="margin-right: 6px;"></i>
                    ${count} article${count > 1 ? 's' : ''}
                    ${count > 2 ? ` (+${count-2})` : ''}
                </span>`;
            }
            return '<span class="text-muted">—</span>';
        default:
            return String(value).substring(0, 60);
    }
}

function searchInItem(item, query) {
    const q = query.toLowerCase();
    return Object.values(item).some(value => {
        if (typeof value === 'string') return value.toLowerCase().includes(q);
        if (typeof value === 'number') return String(value).includes(q);
        if (Array.isArray(value)) return value.some(v => {
            if (typeof v === 'string') return v.toLowerCase().includes(q);
            if (v && typeof v === 'object') {
                return Object.values(v).some(x => typeof x === 'string' && x.toLowerCase().includes(q));
            }
            return false;
        });
        if (value && typeof value === 'object') {
            return Object.values(value).some(x => typeof x === 'string' && x.toLowerCase().includes(q));
        }
        return false;
    });
}

function filterTable(query) { 
    searchFilter = query.toLowerCase(); 
    updateSectionContent(currentSection); 
}

/* ===================== Modals professionnels ===================== */
function openAddModal(section) {
    editingItem = null; 
    editingIndex = null;
    
    const icons = {
        stock: 'fas fa-plus-circle',
        ventes: 'fas fa-cash-register', 
        achats: 'fas fa-truck',
        paiements: 'fas fa-credit-card'
    };
    
    document.getElementById('editModalTitle').innerHTML = `
        <i class="${icons[section] || 'fas fa-plus'}"></i>
        Ajouter ${getSectionLabel(section, true)}
    `;
    document.getElementById('editModalBody').innerHTML = createFormHTML(section);
    document.getElementById('editModal').style.display = 'block';
    
    setTimeout(() => { 
        const firstInput = document.querySelector('#editModal input:not([type="hidden"])'); 
        if (firstInput) firstInput.focus(); 
    }, 200);
}

function openEditModal(section, index) {
    editingItem = currentData.data[section][index]; 
    editingIndex = index;
    
    const icons = {
        stock: 'fas fa-edit',
        ventes: 'fas fa-edit', 
        achats: 'fas fa-edit',
        paiements: 'fas fa-edit'
    };
    
    document.getElementById('editModalTitle').innerHTML = `
        <i class="${icons[section] || 'fas fa-edit'}"></i>
        Modifier ${getSectionLabel(section, true)}
    `;
    document.getElementById('editModalBody').innerHTML = createFormHTML(section, editingItem);
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() { 
    document.getElementById('editModal').style.display = 'none'; 
    editingItem = null; 
    editingIndex = null; 
}

/* ===================== Formulaires professionnels ===================== */
function createFormHTML(section, item=null) {
    const forms = {
        stock: createStockForm(item),
        ventes: createVentesForm(item),
        achats: createAchatsForm(item),
        paiements: createPaiementsForm(item)
    };
    const formContent = forms[section] || '<p>Formulaire non disponible pour cette section.</p>';
    return `
        ${formContent}
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
                Annuler
            </button>
            <button class="btn btn-primary" onclick="saveCurrentItem('${section}')">
                <i class="fas fa-save"></i>
                ${item ? 'Modifier' : 'Ajouter'}
            </button>
        </div>
    `;
}

function createStockForm(item=null) {
    return `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-pills"></i>
                    Nom du produit *
                </label>
                <input type="text" class="form-input" id="nom" value="${item?.nom || ''}" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-warehouse"></i>
                    Quantité en stock *
                </label>
                <input type="number" class="form-input" id="quantite" value="${item?.quantite || 0}" min="0" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-dollar-sign"></i>
                    Prix d'achat *
                </label>
                <input type="number" class="form-input" id="prixAchat" value="${item?.prixAchat || 0}" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-tag"></i>
                    Prix de vente *
                </label>
                <input type="number" class="form-input" id="prixVente" value="${item?.prixVente || 0}" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar-alt"></i>
                    Date de péremption
                </label>
                <input type="date" class="form-input" id="datePeremption" value="${item?.datePeremption ? item.datePeremption.split('T')[0] : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-truck"></i>
                    Fournisseur
                </label>
                <input type="text" class="form-input" id="dernierFournisseur" value="${item?.dernierFournisseur || ''}">
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-exclamation-triangle"></i>
                    Seuil d'alerte
                </label>
                <input type="number" class="form-input" id="seuil" value="${item?.seuil || 5}" min="0">
            </div>
        </div>
    `;
}

function createVentesForm(item=null) {
    return `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar"></i>
                    Date *
                </label>
                <input type="date" class="form-input" id="date" value="${item?.date ? item.date.split('T')[0] : new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-user"></i>
                    Client *
                </label>
                <input type="text" class="form-input" id="client" value="${item?.client || ''}" placeholder="Nom du client" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-credit-card"></i>
                    Mode de paiement
                </label>
                <select class="form-input" id="modePaiement">
                    <option value="Espèces" ${item?.modePaiement === 'Espèces' ? 'selected' : ''}>Espèces</option>
                    <option value="Carte" ${item?.modePaiement === 'Carte' ? 'selected' : ''}>Carte</option>
                    <option value="Chèque" ${item?.modePaiement === 'Chèque' ? 'selected' : ''}>Chèque</option>
                    <option value="Virement" ${item?.modePaiement === 'Virement' ? 'selected' : ''}>Virement</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-check-circle"></i>
                    Statut paiement
                </label>
                <select class="form-input" id="statutPaiement">
                    <option value="payé" ${item?.statutPaiement === 'payé' ? 'selected' : ''}>Payé</option>
                    <option value="impayé" ${item?.statutPaiement === 'impayé' ? 'selected' : ''}>Impayé</option>
                </select>
            </div>
        </div>
        <div class="article-section">
            <div class="article-header">
                <h3 style="font-size:1.125rem;font-weight:700;">
                    <i class="fas fa-list"></i>
                    Articles vendus
                </h3>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addVenteArticle()">
                    <i class="fas fa-plus"></i>
                    Ajouter article
                </button>
            </div>
            <div id="articlesContainer">
                ${item?.articles && item.articles.length>0 ? item.articles.map((a,i)=>createVenteArticleHTML(a,i)).join('') : createVenteArticleHTML(null,0)}
            </div>
            <div class="total-display">
                <div style="font-size:.9rem;color:var(--text-secondary);margin-bottom:8px;">
                    <i class="fas fa-calculator"></i>
                    Total de la vente
                </div>
                <div class="total-amount" id="totalAmount">0.00 DHS</div>
            </div>
        </div>
    `;
}

function createAchatsForm(item=null) {
    return `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar"></i>
                    Date *
                </label>
                <input type="date" class="form-input" id="date" value="${item?.date ? item.date.split('T')[0] : new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-building"></i>
                    Fournisseur *
                </label>
                <input type="text" class="form-input" id="fournisseur" value="${item?.fournisseur || ''}" placeholder="Nom du fournisseur" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-check-circle"></i>
                    Statut paiement
                </label>
                <select class="form-input" id="statutPaiement">
                    <option value="payé" ${item?.statutPaiement === 'payé' ? 'selected' : ''}>Payé</option>
                    <option value="impayé" ${item?.statutPaiement === 'impayé' ? 'selected' : ''}>Impayé</option>
                    <option value="partiel" ${item?.statutPaiement === 'partiel' ? 'selected' : ''}>Partiel</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-percentage"></i>
                    Remise globale (%)
                </label>
                <input type="number" class="form-input" id="remiseGlobale" value="${item?.remiseGlobale || 0}" min="0" max="100" step="0.01" onchange="calculateTotal()">
            </div>
        </div>
        <div class="article-section">
            <div class="article-header">
                <h3 style="font-size:1.125rem;font-weight:700;">
                    <i class="fas fa-boxes"></i>
                    Articles achetés
                </h3>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addAchatArticle()">
                    <i class="fas fa-plus"></i>
                    Ajouter article
                </button>
            </div>
            <div id="articlesContainer">
                ${item?.articles && item.articles.length>0 ? item.articles.map((a,i)=>createAchatArticleHTML(a,i)).join('') : createAchatArticleHTML(null,0)}
            </div>
            <div class="total-display">
                <div style="font-size:.9rem;color:var(--text-secondary);margin-bottom:8px;">
                    <i class="fas fa-calculator"></i>
                    Total TTC
                </div>
                <div class="total-amount" id="totalAmount">0.00 DHS</div>
            </div>
        </div>
    `;
}

function createPaiementsForm(item=null) {
    return `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar"></i>
                    Date *
                </label>
                <input type="date" class="form-input" id="date" value="${item?.date ? item.date.split('T')[0] : new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-euro-sign"></i>
                    Montant *
                </label>
                <input type="number" class="form-input" id="montant" value="${item?.montant || 0}" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-credit-card"></i>
                    Mode de paiement
                </label>
                <select class="form-input" id="mode">
                    <option value="Espèces" ${item?.mode === 'Espèces' ? 'selected' : ''}>Espèces</option>
                    <option value="Carte" ${item?.mode === 'Carte' ? 'selected' : ''}>Carte</option>
                    <option value="Chèque" ${item?.mode === 'Chèque' ? 'selected' : ''}>Chèque</option>
                    <option value="Virement" ${item?.mode === 'Virement' ? 'selected' : ''}>Virement</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-tag"></i>
                    Type
                </label>
                <select class="form-input" id="type">
                    <option value="ventes" ${item?.type === 'ventes' ? 'selected' : ''}>Ventes</option>
                    <option value="achats" ${item?.type === 'achats' ? 'selected' : ''}>Achats</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-file-alt"></i>
                    Document ID
                </label>
                <input type="text" class="form-input" id="docId" value="${item?.docId || ''}" placeholder="ID du document">
            </div>
        </div>
    `;
}

/* ===================== Articles professionnels ===================== */
function createVenteArticleHTML(article=null, index=0) {
    const products = getAvailableProducts();
    return `
        <div class="article-item" data-index="${index}">
            <div class="article-item-header">
                <strong>
                    <i class="fas fa-pills"></i>
                    Article ${index + 1}
                </strong>
                ${index>0 ? '<button type="button" class="btn btn-sm btn-danger" onclick="removeArticle(this)"><i class="fas fa-trash"></i></button>' : ''}
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-search"></i>
                        Produit *
                    </label>
                    <input type="text" class="form-input" name="produit" value="${article?.produit || ''}"
                           list="productList${index}" required onchange="updateVenteProductInfo(this, ${index}); calculateTotal()"
                           placeholder="Rechercher ou scanner...">
                    <datalist id="productList${index}">
                        ${products.map(p => `<option value="${p.nom}">${p.nom} (Stock: ${p.quantite})</option>`).join('')}
                    </datalist>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-sort-numeric-up"></i>
                        Quantité *
                    </label>
                    <input type="number" class="form-input" name="quantite" value="${article?.quantite || 1}"
                           min="1" required onchange="calculateTotal()">
                    <small id="stockInfo${index}" style="color:var(--text-secondary);font-size:.8rem;margin-top:4px;display:block;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-tag"></i>
                        Prix unitaire *
                    </label>
                    <input type="number" class="form-input" name="prixUnitaire" value="${article?.prixUnitaire || 0}"
                           min="0" step="0.01" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-percentage"></i>
                        Remise (%)
                    </label>
                    <input type="number" class="form-input" name="remise" value="${article?.remise || 0}"
                           min="0" max="100" step="0.01" onchange="calculateTotal()">
                </div>
            </div>
        </div>
    `;
}

function createAchatArticleHTML(article=null, index=0) {
    const products = getAvailableProducts();
    return `
        <div class="article-item" data-index="${index}">
            <div class="article-item-header">
                <strong>
                    <i class="fas fa-box"></i>
                    Article ${index + 1}
                </strong>
                ${index>0 ? '<button type="button" class="btn btn-sm btn-danger" onclick="removeArticle(this)"><i class="fas fa-trash"></i></button>' : ''}
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-pills"></i>
                        Produit *
                    </label>
                    <input type="text" class="form-input" name="produit" value="${article?.produit || ''}"
                           list="productListAchat${index}" required onchange="updateAchatProductInfo(this, ${index}); calculateTotal()">
                    <datalist id="productListAchat${index}">
                        ${products.map(p => `<option value="${p.nom}">${p.nom}</option>`).join('')}
                    </datalist>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-sort-numeric-up"></i>
                        Quantité *
                    </label>
                    <input type="number" class="form-input" name="quantite" value="${article?.quantite || 1}"
                           min="1" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-dollar-sign"></i>
                        Prix d'achat *
                    </label>
                    <input type="number" class="form-input" name="prixAchat" value="${article?.prixAchat || 0}"
                           min="0" step="0.01" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-tag"></i>
                        Prix de vente *
                    </label>
                    <input type="number" class="form-input" name="prixVente" value="${article?.prixVente || 0}"
                           min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt"></i>
                        Date de péremption
                    </label>
                    <input type="date" class="form-input" name="datePeremption" value="${article?.datePeremption ? article.datePeremption.split('T')[0] : ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-barcode"></i>
                        Numéro de lot
                    </label>
                    <input type="text" class="form-input" name="numeroLot" value="${article?.numeroLot || ''}" placeholder="Ex: LOT2024001">
                </div>
            </div>
        </div>
    `;
}

function getAvailableProducts() {
    if (!currentData || !currentData.data.stock) return [];
    return currentData.data.stock
        .filter(item => item && item.nom)
        .map(item => ({
            nom: item.nom,
            quantite: parseInt(item.quantite)||0,
            prixAchat: parseNumeric(item.prixAchat)||0,
            prixVente: parseNumeric(item.prixVente)||0
        }));
}

function addVenteArticle(){ 
    const c=document.getElementById('articlesContainer'); 
    const count=c.children.length; 
    c.insertAdjacentHTML('beforeend', createVenteArticleHTML(null,count)); 
    calculateTotal(); 
}

function addAchatArticle(){ 
    const c=document.getElementById('articlesContainer'); 
    const count=c.children.length; 
    c.insertAdjacentHTML('beforeend', createAchatArticleHTML(null,count)); 
    calculateTotal(); 
}

function removeArticle(button){
    const article = button.closest('.article-item'); 
    article.remove();
    const articles = document.querySelectorAll('.article-item');
    articles.forEach((item, idx) => {
        item.dataset.index = idx;
        const header = item.querySelector('.article-item-header strong');
        if (header) header.innerHTML = `<i class="fas fa-pills"></i> Article ${idx + 1}`;
    });
    calculateTotal();
}

function calculateTotal() {
    const totalElement = document.getElementById('totalAmount');
    if (!totalElement) return;
    let total = 0;
    const articles = document.querySelectorAll('.article-item');
    articles.forEach(article => {
        const quantite = parseNumeric(article.querySelector('input[name="quantite"]')?.value) || 0;
        if (currentSection === 'ventes') {
            const prix = parseNumeric(article.querySelector('input[name="prixUnitaire"]')?.value) || 0;
            const remise = parseNumeric(article.querySelector('input[name="remise"]')?.value) || 0;
            const sousTotal = quantite * prix;
            total += sousTotal - (sousTotal * remise / 100);
        } else if (currentSection === 'achats') {
            const prix = parseNumeric(article.querySelector('input[name="prixAchat"]')?.value) || 0;
            total += quantite * prix;
        }
    });
    if (currentSection === 'achats') {
        const remiseGlobale = parseNumeric(document.getElementById('remiseGlobale')?.value) || 0;
        total -= total * (remiseGlobale / 100);
    }
    totalElement.textContent = `${total.toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS`;
}

function updateVenteProductInfo(input, index) {
    const products = getAvailableProducts();
    const product = products.find(p => p.nom === input.value);
    if (product) {
        const prixInput = input.closest('.article-item').querySelector('input[name="prixUnitaire"]');
        const stockInfo = document.getElementById(`stockInfo${index}`);
        if (prixInput) prixInput.value = product.prixVente;
        if (stockInfo) {
            const icon = product.quantite <= 5 ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
            const color = product.quantite <= 5 ? 'var(--danger-color)' : 'var(--success-color)';
            stockInfo.innerHTML = `<i class="${icon}" style="color: ${color};"></i> Stock disponible: ${product.quantite}`;
            stockInfo.style.color = color;
        }
    }
}

function updateAchatProductInfo(input, index) {
    const products = getAvailableProducts();
    const product = products.find(p => p.nom === input.value);
    if (product) {
        const article = input.closest('.article-item');
        const prixAchatInput = article.querySelector('input[name="prixAchat"]');
        const prixVenteInput = article.querySelector('input[name="prixVente"]');
        if (prixAchatInput && product.prixAchat) prixAchatInput.value = product.prixAchat;
        if (prixVenteInput && product.prixVente) prixVenteInput.value = product.prixVente;
    }
}

/* ===================== VENTE RAPIDE ===================== */
function openQuickSale() {
    quickSaleItems = [];
    document.getElementById('quickSaleModal').style.display = 'block';
    updateQuickSaleDisplay();
    setTimeout(() => {
        const searchInput = document.getElementById('quickProductSearch');
        if (searchInput) searchInput.focus();
    }, 200);
}

function closeQuickSaleModal() {
    document.getElementById('quickSaleModal').style.display = 'none';
    quickSaleItems = [];
}

function simulateBarcodeScan() {
    const products = getAvailableProducts();
    if (products.length === 0) {
        showAlert('Aucun produit en stock pour la simulation', 'warning');
        return;
    }
    
    const randomProduct = products[Math.floor(Math.random() * products.length)];
    document.getElementById('quickProductSearch').value = randomProduct.nom;
    searchProducts(randomProduct.nom);
    showAlert(`Code-barres simulé: ${randomProduct.nom}`, 'info');
}

function searchProducts(query) {
    const container = document.getElementById('productSuggestions');
    if (!query.trim()) {
        container.innerHTML = '';
        return;
    }
    
    const products = getAvailableProducts();
    const matches = products.filter(p => 
        p.nom.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 5);
    
    if (matches.length === 0) {
        container.innerHTML = '<div style="padding: 12px; color: var(--text-muted);"><i class="fas fa-search"></i> Aucun produit trouvé</div>';
        return;
    }
    
    container.innerHTML = matches.map(product => `
        <div class="card" style="margin-bottom: 8px; cursor: pointer;" onclick="addToQuickSale('${product.nom}', ${product.prixVente}, ${product.quantite})">
            <div class="card-content" style="padding: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">
                            <i class="fas fa-pills text-primary"></i>
                            ${product.nom}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            Stock: ${product.quantite} | Prix: ${product.prixVente.toFixed(2)} DHS
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function addToQuickSale(productName, price, availableStock) {
    const existing = quickSaleItems.find(item => item.product === productName);
    
    if (existing) {
        if (existing.quantity < availableStock) {
            existing.quantity++;
            existing.total = existing.quantity * existing.price;
        } else {
            showAlert('Stock insuffisant pour ce produit', 'warning');
            return;
        }
    } else {
        if (availableStock <= 0) {
            showAlert('Produit en rupture de stock', 'error');
            return;
        }
        quickSaleItems.push({
            product: productName,
            price: price,
            quantity: 1,
            total: price,
            availableStock: availableStock
        });
    }
    
    document.getElementById('quickProductSearch').value = '';
    document.getElementById('productSuggestions').innerHTML = '';
    updateQuickSaleDisplay();
}

function updateQuickSaleDisplay() {
    const container = document.getElementById('quickSaleItems');
    const totalContainer = document.getElementById('quickSaleTotal');
    const processBtn = document.getElementById('quickSaleProcess');
    
    if (quickSaleItems.length === 0) {
        container.innerHTML = '';
        totalContainer.style.display = 'none';
        processBtn.disabled = true;
        return;
    }
    
    let grandTotal = 0;
    container.innerHTML = quickSaleItems.map((item, index) => {
        grandTotal += item.total;
        return `
            <div class="card" style="margin-bottom: 12px;">
                <div class="card-content" style="padding: 16px;">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">
                                <i class="fas fa-pills text-primary"></i>
                                ${item.product}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                                ${item.price.toFixed(2)} DHS × ${item.quantity} = ${item.total.toFixed(2)} DHS
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="btn btn-sm btn-secondary" onclick="changeQuickSaleQuantity(${index}, -1)" ${item.quantity <= 1 ? 'disabled' : ''}>
                                <i class="fas fa-minus"></i>
                            </button>
                            <span style="font-weight: 600; min-width: 20px; text-align: center;">${item.quantity}</span>
                            <button class="btn btn-sm btn-secondary" onclick="changeQuickSaleQuantity(${index}, 1)" ${item.quantity >= item.availableStock ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removeFromQuickSale(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('quickTotalAmount').textContent = `${grandTotal.toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS`;
    totalContainer.style.display = 'block';
    processBtn.disabled = false;
}

function changeQuickSaleQuantity(index, delta) {
    const item = quickSaleItems[index];
    const newQuantity = item.quantity + delta;
    
    if (newQuantity <= 0) {
        removeFromQuickSale(index);
        return;
    }
    
    if (newQuantity > item.availableStock) {
        showAlert('Stock insuffisant', 'warning');
        return;
    }
    
    item.quantity = newQuantity;
    item.total = item.quantity * item.price;
    updateQuickSaleDisplay();
}

function removeFromQuickSale(index) {
    quickSaleItems.splice(index, 1);
    updateQuickSaleDisplay();
}

function clearQuickSale() {
    quickSaleItems = [];
    updateQuickSaleDisplay();
    document.getElementById('quickProductSearch').value = '';
    document.getElementById('productSuggestions').innerHTML = '';
}

async function processQuickSale() {
    if (quickSaleItems.length === 0) return;
    
    const vente = {
        id: generateId(),
        date: new Date().toISOString(),
        client: 'Vente comptoir',
        modePaiement: 'Espèces',
        statutPaiement: 'payé',
        articles: quickSaleItems.map(item => ({
            produit: item.product,
            quantite: item.quantity,
            prixUnitaire: item.price,
            remise: 0
        })),
        totalTTC: quickSaleItems.reduce((sum, item) => sum + item.total, 0),
        creeLe: new Date().toISOString(),
        creeParEmail: 'caisse@pharmacie.com'
    };
    
    if (!currentData.data.ventes) currentData.data.ventes = [];
    currentData.data.ventes.push(vente);
    
    updateStockForOperation('ventes', vente);
    await saveData();
    updateInterface();
    
    closeQuickSaleModal();
    showAlert(`Vente de ${vente.totalTTC.toFixed(2)} DHS enregistrée!`, 'success');
}

/* ===================== RECHERCHE GLOBALE ===================== */
function openQuickSearch() {
    document.getElementById('quickSearchModal').style.display = 'block';
    setTimeout(() => {
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) searchInput.focus();
    }, 200);
}

function closeQuickSearchModal() {
    document.getElementById('quickSearchModal').style.display = 'none';
    document.getElementById('globalSearch').value = '';
    document.getElementById('searchResults').innerHTML = '';
}

function performGlobalSearch(query) {
    const container = document.getElementById('searchResults');
    
    if (!query.trim()) {
        container.innerHTML = '';
        return;
    }
    
    if (!currentData || !currentData.data) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Aucune donnée chargée</div>';
        return;
    }
    
    const results = {
        stock: [],
        ventes: [],
        achats: [],
        paiements: []
    };
    
    Object.keys(results).forEach(section => {
        if (currentData.data[section]) {
            results[section] = currentData.data[section].filter(item => searchInItem(item, query));
        }
    });
    
    const totalResults = Object.values(results).reduce((sum, arr) => sum + arr.length, 0);
    
    if (totalResults === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 12px;"></i>
                <div>Aucun résultat trouvé pour "${query}"</div>
            </div>
        `;
        return;
    }
    
    let html = `<div style="margin-bottom: 16px; font-weight: 600; color: var(--text-primary);">
        <i class="fas fa-search"></i> ${totalResults} résultat${totalResults > 1 ? 's' : ''} trouvé${totalResults > 1 ? 's' : ''}
    </div>`;
    
    Object.keys(results).forEach(section => {
        if (results[section].length > 0) {
            html += `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-header" style="padding: 16px 20px;">
                        <div class="card-title" style="font-size: 1rem;">
                            <i class="${getSectionIcon(section)}"></i>
                            ${getSectionLabel(section)} (${results[section].length})
                        </div>
                    </div>
                    <div class="card-content" style="padding: 0;">
                        ${results[section].slice(0, 5).map(item => `
                            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); cursor: pointer;" 
                                 onclick="goToSection('${section}', '${item.id || ''}')">
                                <div style="font-weight: 600; margin-bottom: 4px;">
                                    ${item.nom || item.client || item.fournisseur || 'Sans nom'}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ${getItemPreview(item, section)}
                                </div>
                            </div>
                        `).join('')}
                        ${results[section].length > 5 ? 
                            `<div style="padding: 12px 20px; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                                ... et ${results[section].length - 5} autres résultats
                            </div>` : ''}
                    </div>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

function getItemPreview(item, section) {
    switch(section) {
        case 'stock':
            return `Stock: ${item.quantite || 0} | Prix: ${(parseNumeric(item.prixVente) || 0).toFixed(2)} DHS`;
        case 'ventes':
            return `Client: ${item.client || 'N/A'} | Montant: ${montantVente(item).toFixed(2)} DHS`;
        case 'achats':
            return `Fournisseur: ${item.fournisseur || 'N/A'} | Montant: ${montantAchat(item).toFixed(2)} DHS`;
        case 'paiements':
            return `Mode: ${item.mode || 'N/A'} | Montant: ${(parseNumeric(item.montant) || 0).toFixed(2)} DHS`;
        default:
            return 'Détails disponibles';
    }
}

function goToSection(section, itemId) {
    closeQuickSearchModal();
    showSection(section);
    
    if (itemId) {
        setTimeout(() => {
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                const item = currentData.data[section].find(i => i.id === itemId);
                if (item) {
                    const searchTerm = item.nom || item.client || item.fournisseur || '';
                    searchInput.value = searchTerm;
                    filterTable(searchTerm);
                }
            }
        }, 300);
    }
}

/* ===================== Save/Validate (amélioré) ===================== */
async function saveCurrentItem(section) {
    try {
        const formData = collectFormData(section);
        if (!validateFormData(formData, section)) return;

        if (!currentData.data[section]) currentData.data[section] = [];
        const now = new Date().toISOString();

        if (editingIndex === null) {
            formData.id = generateId();
            formData.creeLe = now;
            formData.creeParEmail = 'pharmacien@pharmacie.com';
            currentData.data[section].push(formData);
            showAlert(`${getSectionLabel(section, true)} ajouté avec succès!`, 'success');
        } else {
            const existing = currentData.data[section][editingIndex];
            Object.assign(formData, {
                id: existing.id || generateId(),
                creeLe: existing.creeLe || now,
                creeParEmail: existing.creeParEmail || 'pharmacien@pharmacie.com',
                modifieLe: now,
                modifieParEmail: 'pharmacien@pharmacie.com'
            });
            currentData.data[section][editingIndex] = formData;
            showAlert(`${getSectionLabel(section, true)} modifié avec succès!`, 'success');
        }

        updateStockForOperation(section, formData);
        await saveData();
        closeEditModal();
        updateInterface();
    } catch (error) {
        showAlert('Erreur: ' + error.message, 'error');
    }
}

function collectFormData(section) {
    const formData = {};
    const inputs = document.querySelectorAll('#editModal input:not([name]), #editModal select:not([name])');
    inputs.forEach(input => {
        if (input.id) {
            let value = input.value;
            if (input.type === 'number') {
                value = (input.id === 'quantite' || input.id === 'seuil') ? (parseInt(value)||0) : (parseNumeric(value)||0);
            } else if (input.type === 'date' && value) {
                value = new Date(value).toISOString();
            }
            formData[input.id] = value;
        }
    });

    if (section === 'achats' || section === 'ventes') {
        const articles = [];
        const articleItems = document.querySelectorAll('.article-item');
        articleItems.forEach(item => {
            const article = {};
            const inputs = item.querySelectorAll('input[name]');
            inputs.forEach(input => {
                let value = input.value;
                if (input.type === 'number') value = (input.name === 'quantite') ? (parseInt(value)||0) : (parseNumeric(value)||0);
                else if (input.type === 'date' && value) value = new Date(value).toISOString();
                article[input.name] = value;
            });
            if (article.produit && article.produit.trim()) articles.push(article);
        });
        formData.articles = articles;

        if (section === 'ventes') {
            formData.totalTTC = montantVente(formData);
        } else if (section === 'achats') {
            formData.totalTTC = montantAchat(formData);
        }
    }
    return formData;
}

function validateFormData(formData, section) {
    if ((section === 'achats' || section === 'ventes') && (!formData.articles || formData.articles.length === 0)) {
        showAlert('Veuillez ajouter au moins un article', 'error');
        return false;
    }
    
    // Validation spécifique pharmacie
    if (section === 'ventes' && formData.articles) {
        const products = getAvailableProducts();
        for (const article of formData.articles) {
            const product = products.find(p => p.nom === article.produit);
            if (product && article.quantite > product.quantite) {
                showAlert(`Stock insuffisant pour ${article.produit} (disponible: ${product.quantite})`, 'error');
                return false;
            }
        }
    }
    
    return true;
}

/* ===================== Stock update (même logique) ===================== */
function updateStockForOperation(section, data) {
    if (!currentData.data.stock) return;

    if (section === 'achats' && data.articles) {
        data.articles.forEach(article => {
            let stockItem = currentData.data.stock.find(s => s.nom && s.nom.toLowerCase() === article.produit.toLowerCase());
            if (stockItem) {
                stockItem.quantite = (parseInt(stockItem.quantite)||0) + (parseInt(article.quantite)||0);
                stockItem.prixAchat = parseNumeric(article.prixAchat)||0;
                stockItem.prixVente = parseNumeric(article.prixVente)||0;
                stockItem.datePeremption = article.datePeremption || stockItem.datePeremption;
                stockItem.dernierFournisseur = data.fournisseur || stockItem.dernierFournisseur;
                stockItem.modifieLe = new Date().toISOString();
            } else {
                currentData.data.stock.push({
                    id: generateId(),
                    nom: article.produit,
                    quantite: parseInt(article.quantite)||0,
                    prixAchat: parseNumeric(article.prixAchat)||0,
                    prixVente: parseNumeric(article.prixVente)||0,
                    datePeremption: article.datePeremption,
                    dernierFournisseur: data.fournisseur,
                    seuil: 5,
                    creeLe: new Date().toISOString()
                });
            }
        });
    } else if (section === 'ventes' && data.articles) {
        data.articles.forEach(article => {
            let stockItem = currentData.data.stock.find(s => s.nom && s.nom.toLowerCase() === article.produit.toLowerCase());
            if (stockItem) {
                const oldQty = parseInt(stockItem.quantite)||0;
                const qtyToRemove = parseInt(article.quantite)||0;
                stockItem.quantite = Math.max(0, oldQty - qtyToRemove);
                stockItem.modifieLe = new Date().toISOString();
                if (stockItem.quantite <= (parseInt(stockItem.seuil)||5)) {
                    showAlert(`Stock faible: ${stockItem.nom} (${stockItem.quantite} restants)`, 'warning');
                }
            }
        });
    }
}

/* ===================== Sections refresh ===================== */
function updateAllSections() { 
    ['stock','ventes','achats','paiements'].forEach(section => updateSectionContent(section)); 
}

/* ===================== Confirm/Suppressions ===================== */
function confirmDelete(section, index) {
    const item = currentData.data[section][index];
    const name = item.nom || item.client || item.fournisseur || `Élément ${index + 1}`;
    document.getElementById('confirmMessage').innerHTML = `
        <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-right: 8px;"></i>
        Voulez-vous vraiment supprimer "<strong>${name}</strong>" ?
        <br><br>
        <small style="color: var(--text-muted);">Cette action est irréversible.</small>
    `;
    document.getElementById('confirmButton').onclick = async () => { await deleteItem(section, index); closeConfirmModal(); };
    document.getElementById('confirmModal').style.display = 'block';
}

async function deleteItem(section, index) {
    currentData.data[section].splice(index, 1);
    await saveData();
    updateInterface();
    showAlert('Élément supprimé avec succès', 'success');
}

function closeConfirmModal() { 
    document.getElementById('confirmModal').style.display='none'; 
}

/* ===================== Progress & Alerts améliorés ===================== */
function showProgress(text, percentage) {
    document.getElementById('progressText').innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressModal').style.display = 'block';
}

function hideProgress() { 
    document.getElementById('progressModal').style.display='none'; 
}

function showAlert(message, type='info') {
    const container = document.getElementById('alertsContainer');
    const alert = document.createElement('div');
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-times-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };
    
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <i class="${icons[type]}"></i>
        <span>${message}</span>
        <button style="background:none;border:none;color:inherit;cursor:pointer;margin-left:auto;padding:4px;" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    alert.style.animation = 'slideInRight 0.3s ease-out';
    container.appendChild(alert);
    
    setTimeout(() => { 
        if (alert.parentElement) {
            alert.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => alert.remove(), 300);
        }
    }, 5000);
}

/* ===================== Utils ===================== */
function generateId() { 
    return 'pharma_' + Math.random().toString(36).substr(2,9) + '_' + Date.now(); 
}

/* ===================== Export/Clear améliorés ===================== */
async function exportData() {
    if (!currentData) { 
        showAlert('Aucune donnée à exporter', 'error'); 
        return; 
    }
    
    showProgress('Préparation de l\'export...', 20);
    const exportData = JSON.parse(JSON.stringify(currentData));
    exportData.metadata = exportData.metadata || {};
    exportData.metadata.exportDateIso = new Date().toISOString();
    exportData.metadata.exportedFrom = 'pharma-gestion-pro';
    exportData.metadata.version = '2.0';
    
    showProgress('Génération du fichier...', 80);
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = `pharma-export-${new Date().toISOString().split('T')[0]}.json`; 
    a.click();
    URL.revokeObjectURL(url);
    
    showProgress('Export terminé!', 100);
    setTimeout(() => { 
        hideProgress(); 
        showAlert('Export terminé avec succès!', 'success'); 
    }, 500);
}

async function clearAllData() {
    if (confirm('⚠️ ATTENTION: Voulez-vous vraiment effacer toutes les données ?\n\nCette action est irréversible et supprimera :\n- Tous les produits\n- Toutes les ventes\n- Tous les achats\n- Tous les paiements\n\nConfirmez-vous ?')) {
        showProgress('Effacement en cours...', 50);
        
        await idbClear();
        ['pharmaData','pharmaDataOriginal','lastImport','lastModified'].forEach(key => localStorage.removeItem(key));

        currentData = null;
        originalData = null;
        quickSaleItems = [];

        document.getElementById('exportBtn').disabled = true;
        updateNavBadges();

        const emptyState = document.getElementById('dashboardEmpty');
        const content = document.getElementById('dashboardContent');
        if (emptyState) emptyState.style.display = 'block';
        if (content) content.style.display = 'none';

        showSection('dashboard');
        
        showProgress('Nettoyage terminé!', 100);
        setTimeout(() => {
            hideProgress();
            showAlert('Toutes les données ont été effacées', 'info');
        }, 500);
    }
}

/* ===================== CAPACITÉ AMÉLIORÉE ===================== */
function bytesToHuman(n){
    if (!Number.isFinite(n)) return '—';
    const KB=1024, MB=KB*1024, GB=MB*1024;
    if (n>=GB) return (n/GB).toFixed(2)+' Go';
    if (n>=MB) return (n/MB).toFixed(2)+' Mo';
    if (n>=KB) return (n/KB).toFixed(2)+' Ko';
    return n.toFixed(0)+' o';
}

async function getStorageEstimate(){
    if (!(navigator.storage && navigator.storage.estimate)) return null;
    const { usage=0, quota=0 } = await navigator.storage.estimate();
    const persisted = (navigator.storage && navigator.storage.persisted)
        ? await navigator.storage.persisted()
        : false;
    return { usage, quota, persisted };
}

function openCapacityModal(){
    document.getElementById('capacityBody').innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <div class="loading-text">Analyse du stockage...</div>
        </div>
    `;
    document.getElementById('capacityModal').style.display = 'block';
    refreshCapacity();
}

function closeCapacityModal() { 
    document.getElementById('capacityModal').style.display='none'; 
}

async function refreshCapacity(){
    const body = document.getElementById('capacityBody');
    const info = await getStorageEstimate();
    
    if (!info){
        body.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--warning-color); margin-bottom: 16px;"></i>
                <p>Votre navigateur ne fournit pas l'estimation de stockage.</p>
                <p class="muted">L'application fonctionne normalement malgré cette limitation.</p>
            </div>
        `;
        return;
    }
    
    const { usage, quota, persisted } = info;
    const libre = Math.max(0, quota - usage);
    const usagePercent = quota > 0 ? (usage / quota * 100).toFixed(1) : 0;
    
    body.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="font-weight: 600;">Utilisation du stockage</span>
                <span style="font-weight: 700; color: var(--primary-color);">${usagePercent}%</span>
            </div>
            <div class="progress">
                <div class="progress-bar" style="width: ${usagePercent}%;"></div>
            </div>
        </div>
        
        <div class="capacity-line">
            <span><i class="fas fa-database"></i> Utilisé</span>
            <strong>${bytesToHuman(usage)}</strong>
        </div>
        <div class="capacity-line">
            <span><i class="fas fa-hdd"></i> Quota total</span>
            <strong>${bytesToHuman(quota)}</strong>
        </div>
        <div class="capacity-line">
            <span><i class="fas fa-free-code-camp"></i> Espace libre</span>
            <strong>${bytesToHuman(libre)}</strong>
        </div>
        <div class="capacity-line">
            <span><i class="fas fa-lock"></i> Stockage persistant</span>
            <strong style="color: ${persisted ? 'var(--success-color)' : 'var(--warning-color)'};">
                ${persisted ? 'Activé ✅' : 'Désactivé ❌'}
            </strong>
        </div>
        
        <div style="margin-top: 20px; padding: 16px; background: var(--surface-secondary); border-radius: var(--radius-md);">
            <p class="muted" style="margin: 0;">
                <i class="fas fa-info-circle"></i>
                Ces données incluent l'ensemble du stockage local pour ce site (IndexedDB, Cache, localStorage).
                ${!persisted ? ' Activez la persistance pour éviter la suppression automatique des données.' : ''}
            </p>
        </div>
    `;
}

async function requestPersistence(){
    if (!(navigator.storage && navigator.storage.persist)){
        showAlert("API de persistance non disponible sur ce navigateur", "warning");
        return;
    }
    try{
        const granted = await navigator.storage.persist();
        if (granted){
            showAlert("Stockage persistant activé avec succès!", "success");
        } else {
            showAlert("Demande de persistance refusée par le navigateur", "warning");
        }
        refreshCapacity();
    } catch(e) {
        showAlert("Erreur lors de la demande: " + (e.message || e), "error");
    }
}

/* ===================== CSS ANIMATIONS ===================== */
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .form-input:focus {
        transform: scale(1.02);
    }
    
    .metric-card {
        transform-origin: center;
    }
    
    .nav-item {
        transform-origin: left center;
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>
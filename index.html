<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pharma Gestion Pro - Hybride</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0f766e;
            --primary-dark: #0d5c5a;
            --primary-light: #f0fdfa;
            --accent-color: #06b6d4;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #ea580c;
            --danger-color: #dc2626;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --surface-secondary: #f1f5f9;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, var(--surface-color) 0%, #fcfcfc 100%);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
        }

        .sidebar-header {
            padding: 28px 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--surface-color);
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            letter-spacing: -0.025em;
        }

        .logo-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .storage-status {
            padding: 16px 24px;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .storage-mode {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .storage-mode.hybrid { color: var(--success-color); }
        .storage-mode.browser-only { color: var(--warning-color); }

        .storage-details {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--warning-color);
            box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.2);
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--success-color);
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.2);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sidebar-nav {
            flex: 1;
            padding: 24px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            padding: 0 24px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
            margin: 2px 12px;
            border-radius: var(--radius-lg);
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: var(--primary-color);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            min-width: 24px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-color);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 24px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .nav-item.active .nav-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--background-color);
        }

        .main-header {
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .main-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
        }

        .header-left h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: -0.025em;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            background: var(--background-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-primary);
            border-color: var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #c2410c 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #b91c1c 100%);
            color: white;
        }

        .btn-sm { padding: 8px 14px; font-size: 0.8rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            transition: box-shadow 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-content {
            padding: 28px;
        }

        .setup-card {
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            border: 2px solid var(--success-color);
            border-radius: var(--radius-xl);
            padding: 32px;
            text-align: center;
            margin-bottom: 32px;
        }

        .setup-icon {
            width: 80px;
            height: 80px;
            background: var(--success-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }

        .setup-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .setup-description {
            color: var(--text-muted);
            margin-bottom: 24px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .storage-manager {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 24px 0;
        }

        .storage-section {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .storage-section h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .storage-stats {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .storage-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 28px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .metric-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .metric-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .alert {
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #facc15;
        }

        .alert-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: 28px 28px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 0;
            padding-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--surface-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--danger-color);
            color: white;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 28px;
        }

        .modal-footer {
            padding: 0 28px 28px;
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-light);
            padding-top: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: var(--surface-color);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1);
        }

        .articles-container {
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            background: var(--surface-secondary);
        }

        .articles-header {
            margin-bottom: 16px;
        }

        .article-row {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
        }

        .article-row .form-row:first-child {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 12px;
        }

        .article-row .form-row:nth-child(2) {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: 12px;
        }

        .form-col label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
        }

        .article-total {
            margin-top: 12px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .article-details {
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--surface-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
        }

        .detail-row {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr auto 1fr;
            gap: 8px;
            align-items: center;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .marge-display {
            background: #f0fdfa !important;
            border-color: var(--success-color) !important;
        }

        .benefice-unitaire, .benefice-total, .benefice-potentiel {
            font-weight: 600;
        }

        .expiration-warning {
            color: var(--danger-color);
            font-weight: 600;
        }

        .form-col-action {
            display: flex;
            align-items: end;
            justify-content: center;
        }

        .table-container {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }

        .table-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-box {
            position: relative;
            min-width: 280px;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
            background: var(--surface-color);
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1);
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px 20px;
            text-align: left;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        tr:hover {
            background: var(--primary-light);
        }

        tr:nth-child(even) {
            background: rgba(248, 250, 252, 0.5);
        }

        tr:nth-child(even):hover {
            background: var(--primary-light);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-light) 0%, #e6fffa 100%);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2rem;
            color: var(--primary-color);
        }

        .empty-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .empty-description {
            font-size: 0.95rem;
            margin-bottom: 32px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-paid {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #a7f3d0;
        }

        .status-unpaid {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-partial {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #facc15;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            flex-direction: column;
            gap: 16px;
        }

        .progress {
            width: 100%;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
            transition: width 0.3s ease;
            border-radius: 6px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -320px;
                height: 100%;
                z-index: 200;
                transition: left 0.3s ease;
                width: 320px;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                width: 100%;
            }

            .storage-manager {
                grid-template-columns: 1fr;
            }

            .content-area {
                padding: 20px;
            }

            .article-row .form-row:first-child {
                grid-template-columns: 1fr;
            }

            .article-row .form-row:nth-child(2) {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr !important;
            }

            .detail-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
                gap: 12px;
            }

            .header-left {
                display: flex;
                align-items: center;
            }

            .main-header {
                padding: 16px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .modal-content {
                width: 98%;
                max-width: none;
            }

            .table-header {
                flex-direction: column;
                gap: 12px;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="app-layout">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-clinic-medical"></i>
                Pharma Gestion
            </div>
            <div class="logo-subtitle">Version Hybride Pro</div>
        </div>

        <div class="storage-status">
            <div class="storage-mode" id="storageMode">
                <i class="fas fa-server"></i>
                <span id="storageModeText">Initialisation...</span>
            </div>
            <div class="storage-details">
                <span id="currentDataSize">0 MB</span>
                <span id="archiveCount">Session courante</span>
            </div>
        </div>

        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Vérification...</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-title">Navigation</div>
                <button class="nav-item active" onclick="showSection('dashboard', event)">
                    <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                    Tableau de bord
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-title">Gestion</div>
                <button class="nav-item" onclick="showSection('stock', event)">
                    <div class="nav-icon"><i class="fas fa-boxes"></i></div>
                    Inventaire
                    <div class="nav-badge" id="stockBadge">0</div>
                </button>
                <button class="nav-item" onclick="showSection('ventes', event)">
                    <div class="nav-icon"><i class="fas fa-cash-register"></i></div>
                    Ventes
                    <div class="nav-badge" id="ventesBadge">0</div>
                </button>
                <button class="nav-item" onclick="showSection('achats', event)">
                    <div class="nav-icon"><i class="fas fa-truck"></i></div>
                    Achats
                    <div class="nav-badge" id="achatsBadge">0</div>
                </button>
                <button class="nav-item" onclick="showSection('paiements', event)">
                    <div class="nav-icon"><i class="fas fa-credit-card"></i></div>
                    Paiements
                    <div class="nav-badge" id="paiementsBadge">0</div>
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-title">Données</div>
                <div class="file-input-wrapper">
                    <input type="file" id="importFile" style="display: none;" accept=".json" multiple>
                    <button class="nav-item" onclick="document.getElementById('importFile').click()">
                        <div class="nav-icon"><i class="fas fa-file-import"></i></div>
                        Importer
                    </button>
                </div>
                <button class="nav-item" onclick="openExportOptions()">
                    <div class="nav-icon"><i class="fas fa-file-export"></i></div>
                    Exporter
                </button>
            </div>
        </nav>

        <div class="hybrid-indicator" id="hybridStatus">
            <i class="fas fa-info-circle"></i>
            Mode : <span id="hybridModeText">Initialisation...</span>
        </div>

        <div class="sidebar-footer">
            <button class="btn btn-danger btn-sm" onclick="clearAllData()" style="width: 100%;">
                <i class="fas fa-trash-alt"></i>
                Réinitialiser
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="main-header">
            <div class="header-left">
                <button class="btn btn-secondary" onclick="toggleSidebar()" style="display: none; margin-right: 16px;" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h1 id="pageTitle">Tableau de bord</h1>
                    <div class="header-subtitle" id="pageSubtitle">Vue d'ensemble de votre pharmacie</div>
                </div>
            </div>
            <div class="header-actions" id="headerActions">
                <button class="btn btn-success" onclick="openExportOptions()">
                    <i class="fas fa-download"></i>
                    Exporter
                </button>
            </div>
        </div>

        <div class="content-area" id="contentArea">
            <div id="setup-section" style="display: none;">
                <div class="setup-card">
                    <div class="setup-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <div class="setup-title">Pharma Gestion Pro - Hybride</div>
                    <div class="setup-description">
                        Application de gestion de pharmacie avec stockage hybride intelligent et export JSON.
                    </div>
                    <button class="btn btn-primary" onclick="setupHybridStorage()">
                        <i class="fas fa-play"></i>
                        Démarrer l'application
                    </button>
                </div>

                <div class="storage-manager">
                    <div class="storage-section">
                        <h3>
                            <i class="fas fa-tachometer-alt"></i>
                            Stockage Rapide
                        </h3>
                        <div class="storage-stats">
                            <div>Données courantes en mémoire</div>
                            <div>Accès instantané</div>
                            <div>Capacité : Session courante</div>
                        </div>
                    </div>

                    <div class="storage-section">
                        <h3>
                            <i class="fas fa-download"></i>
                            Export JSON
                        </h3>
                        <div class="storage-stats">
                            <div>Sauvegarde vers fichiers JSON</div>
                            <div>Compatible avec autres systèmes</div>
                            <div>Format : JSON structuré</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-info-circle"></i>
                            Fonctionnalités
                        </div>
                    </div>
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div>
                                <h4 style="color: var(--primary-color); margin-bottom: 12px;">
                                    <i class="fas fa-boxes"></i>
                                    Gestion Complète
                                </h4>
                                <ul style="list-style: none; font-size: 0.9rem; line-height: 1.8;">
                                    <li><i class="fas fa-check" style="color: var(--success-color); margin-right: 8px;"></i> Stock et inventaire</li>
                                    <li><i class="fas fa-check" style="color: var(--success-color); margin-right: 8px;"></i> Ventes et caisse</li>
                                    <li><i class="fas fa-check" style="color: var(--success-color); margin-right: 8px;"></i> Achats fournisseurs</li>
                                    <li><i class="fas fa-check" style="color: var(--success-color); margin-right: 8px;"></i> Paiements et finances</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="color: var(--accent-color); margin-bottom: 12px;">
                                    <i class="fas fa-exchange-alt"></i>
                                    Import / Export
                                </h4>
                                <ul style="list-style: none; font-size: 0.9rem; line-height: 1.8;">
                                    <li><i class="fas fa-check" style="color: var(--success-color); margin-right: 8px;"></i> Import JSON natif</li>
                                    <li><i class="fas fa-check" style="color: var(--success-color); margin-right: 8px;"></i> Export complet</li>
                                    <li><i class="fas fa-check" style="color: var(--success-color); margin-right: 8px;"></i> Format standardisé</li>
                                    <li><i class="fas fa-check" style="color: var(--success-color); margin-right: 8px;"></i> Backup automatique</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sections dynamiques créées par JavaScript -->
            <div id="section-dashboard" class="section" style="display: block;">
                <div id="dashboardEmpty" class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-clinic-medical"></i>
                    </div>
                    <div class="empty-title">Bienvenue dans Pharma Gestion Pro Hybride</div>
                    <div class="empty-description">
                        Votre application de gestion de pharmacie est prête
                    </div>
                </div>
                <div id="dashboardContent" style="display:none;">
                    <div class="dashboard-grid" id="dashboardMetrics"></div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
                                Alertes de Stock
                            </div>
                        </div>
                        <div class="card-content" id="stockAlerts"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="alertsContainer" style="position:fixed;top:20px;right:20px;z-index:1100;max-width:400px;"></div>

<script>
/* ===================== VARIABLES GLOBALES ===================== */
let currentData = null;
let originalData = null;
let currentSection = 'dashboard';
let editingItem = null;
let editingIndex = null;
let searchFilter = '';

/* ===================== SYSTÈME DE STOCKAGE HYBRIDE ===================== */

class HybridStorageManager {
    constructor() {
        this.currentData = null;
        this.isHybridMode = false;
        this.memoryStorage = {}; // Stockage en mémoire pour remplacer localStorage
        this.archiveThresholdMonths = 3;
        this.maxMemorySize = 50 * 1024 * 1024;
    }

    async initialize() {
        try {
            // Essayer de charger les données sauvegardées
            await this.loadCurrentSession();
            this.updateStorageStatus();
            return true;
        } catch (error) {
            console.warn('Initialisation échouée:', error);
            return false;
        }
    }

    async setup() {
        try {
            showProgress('Configuration du stockage...', 10);
            
            // En mode navigateur standard, on utilise juste la mémoire
            this.isHybridMode = false;
            
            showProgress('Initialisation des données...', 50);
            
            // Créer structure de données par défaut
            if (!this.currentData) {
                this.currentData = {
                    metadata: { 
                        createdAt: new Date().toISOString(), 
                        version: '1.0',
                        appName: 'Pharma Gestion Pro',
                        type: 'hybrid_session'
                    },
                    data: { 
                        stock: [], 
                        ventes: [], 
                        achats: [], 
                        paiements: [],
                        devisFactures: [],
                        retours: [],
                        parametres: []
                    }
                };
            }

            showProgress('Finalisation...', 90);
            this.updateStorageStatus();

            showProgress('Configuration terminée!', 100);
            setTimeout(() => {
                hideProgress();
                showAlert('Application configurée avec succès!', 'success');
                this.initializeMainApp();
            }, 500);

        } catch (error) {
            hideProgress();
            showAlert('Erreur de configuration: ' + error.message, 'error');
        }
    }

    async saveCurrentSession() {
        if (!this.currentData) return;

        try {
            // Sauvegarder en mémoire
            this.memoryStorage.current_session = JSON.stringify(this.currentData);
            
            // Sauvegarde périodique locale si possible
            try {
                if (typeof localStorage !== 'undefined') {
                    localStorage.setItem('pharma_backup', JSON.stringify(this.currentData));
                }
            } catch (e) {
                // Ignorer si localStorage non disponible
            }
        } catch (error) {
            console.error('Erreur sauvegarde session:', error);
        }
    }

    async loadCurrentSession() {
        try {
            // Charger depuis la mémoire
            let dataStr = this.memoryStorage.current_session;
            
            // Fallback vers localStorage si disponible
            if (!dataStr) {
                try {
                    if (typeof localStorage !== 'undefined') {
                        dataStr = localStorage.getItem('pharma_backup');
                    }
                } catch (e) {
                    // Ignorer si localStorage non disponible
                }
            }

            if (dataStr) {
                this.currentData = JSON.parse(dataStr);
                return this.currentData;
            }
        } catch (error) {
            console.error('Erreur chargement session:', error);
        }
        return null;
    }

    async importData(data) {
        try {
            showProgress('Traitement des données...', 30);
            
            // Normaliser la structure des données importées
            const normalizedData = this.normalizeImportedData(data);
            
            showProgress('Sauvegarde...', 70);
            
            this.currentData = normalizedData;
            await this.saveCurrentSession();
            
            showProgress('Import terminé!', 100);
            
            setTimeout(() => {
                hideProgress();
                showAlert('Données importées avec succès!', 'success');
                this.initializeMainApp();
            }, 500);

        } catch (error) {
            hideProgress();
            showAlert('Erreur import: ' + error.message, 'error');
        }
    }

    normalizeImportedData(data) {
        // Structure normalisée pour l'application
        const normalized = {
            metadata: {
                createdAt: data.metadata?.createdAt || new Date().toISOString(),
                version: '1.0',
                appName: 'Pharma Gestion Pro',
                type: 'imported_data',
                importedAt: new Date().toISOString(),
                originalSource: data.metadata?.appName || 'external'
            },
            data: {
                stock: [],
                ventes: [],
                achats: [],
                paiements: [],
                devisFactures: [],
                retours: [],
                parametres: []
            }
        };

        // Mapper les données selon leur structure
        if (data.data) {
            // Traiter le stock
            if (Array.isArray(data.data.stock)) {
                normalized.data.stock = data.data.stock.map(item => this.normalizeStockItem(item));
            }

            // Traiter les ventes
            if (Array.isArray(data.data.ventes)) {
                normalized.data.ventes = data.data.ventes.map(item => this.normalizeVenteItem(item));
            }

            // Traiter les achats - CORRECTION ICI
            if (Array.isArray(data.data.achats)) {
                normalized.data.achats = data.data.achats.map(item => this.normalizeAchatItem(item));
            }

            // Traiter les paiements
            if (Array.isArray(data.data.paiements)) {
                normalized.data.paiements = data.data.paiements.map(item => this.normalizePaiementItem(item));
            }

            // Traiter les autres collections
            ['devisFactures', 'retours', 'parametres'].forEach(collection => {
                if (Array.isArray(data.data[collection])) {
                    normalized.data[collection] = data.data[collection];
                }
            });
        }

        return normalized;
    }

    normalizeStockItem(item) {
        return {
            id: item.id || generateId(),
            nom: item.nom || item.name || '',
            quantite: parseInt(item.quantite) || 0,
            seuil: parseInt(item.seuil) || 5,
            prixVente: parseFloat(item.prixVente) || 0,
            prixAchat: parseFloat(item.prixAchat) || 0,
            datePeremption: item.datePeremption || null,
            fournisseur: item.dernierFournisseur || item.fournisseur || '',
            codeArticle: item.codeArticle || '',
            createdAt: item.creeLe || item.createdAt || new Date().toISOString(),
            updatedAt: item.modifieLe || item.updatedAt || new Date().toISOString()
        };
    }

    normalizeVenteItem(item) {
        const normalized = {
            id: item.id || generateId(),
            date: item.date || item.createdAt || new Date().toISOString(),
            client: item.client || '(passant)',
            telephone: item.telephone || '',
            modePaiement: item.modePaiement || 'Espèces',
            statutPaiement: item.statutPaiement || 'payé',
            articles: Array.isArray(item.articles) ? item.articles.map(a => ({
                produit: a.produit || '',
                quantite: parseFloat(a.quantite) || 0,
                prixUnitaire: parseFloat(a.prixUnitaire) || 0,
                remise: parseFloat(a.remise) || 0,
                sousTotal: parseFloat(a.sousTotal) || (parseFloat(a.quantite) || 0) * (parseFloat(a.prixUnitaire) || 0)
            })) : [],
            totalTTC: parseFloat(item.totalTTC || item.montantTotal || item.montant) || 0,
            createdAt: item.createdAt || item.creeLe || new Date().toISOString(),
            updatedAt: item.updatedAt || item.modifieLe || new Date().toISOString()
        };

        // CORRECTION: Recalculer les totaux si pas définis ou incohérents
        if (!normalized.totalTTC || normalized.totalTTC === 0) {
            this.recalculateVenteTotals(normalized);
        }

        return normalized;
    }

    normalizeAchatItem(item) {
        const normalized = {
            id: item.id || generateId(),
            date: item.date || item.createdAt || new Date().toISOString(),
            fournisseur: item.fournisseur || '',
            contactFournisseur: item.contactFournisseur || '',
            dateLivraison: item.dateLivraison || null,
            statutPaiement: item.statutPaiement || 'impayé',
            remiseGlobale: parseFloat(item.remiseGlobale) || 0,
            articles: Array.isArray(item.articles) ? item.articles.map(a => ({
                produit: a.produit || '',
                quantite: parseFloat(a.quantite) || 0,
                prixAchat: parseFloat(a.prixAchat || a.prixUnitaire) || 0,
                prixVente: parseFloat(a.prixVente) || parseFloat(a.prixAchat || a.prixUnitaire) * 1.3, // Marge 30% par défaut
                remise: parseFloat(a.remise) || 0,
                datePeremption: a.datePeremption || null,
                numeroLot: a.numeroLot || '',
                fournisseurArticle: a.fournisseurArticle || '',
                sousTotal: parseFloat(a.sousTotal) || 0
            })) : [],
            // Préserver les montants existants
            totalTTC: parseFloat(item.totalTTC || item.montant || item.montantTotal) || 0,
            totalHT: parseFloat(item.totalHT) || 0,
            montant: parseFloat(item.montant || item.totalTTC) || 0,
            createdAt: item.createdAt || item.creeLe || new Date().toISOString(),
            updatedAt: item.updatedAt || item.modifieLe || new Date().toISOString()
        };

        // CORRECTION PRINCIPALE: Recalculer les totaux après normalisation
        this.recalculateAchatTotals(normalized);

        return normalized;
    }

    // NOUVELLE FONCTION: Recalculer totaux achat
    recalculateAchatTotals(achat) {
        if (!achat.articles || !Array.isArray(achat.articles)) {
            achat.totalTTC = 0;
            achat.totalHT = 0;
            achat.montant = 0;
            return;
        }

        let totalHT = 0;
        
        // Recalculer chaque article
        achat.articles.forEach(article => {
            const qty = parseFloat(article.quantite) || 0;
            const prix = parseFloat(article.prixAchat) || 0;
            const remise = parseFloat(article.remise) || 0;
            
            let sousTotal = qty * prix;
            sousTotal = sousTotal - (sousTotal * remise / 100);
            totalHT += sousTotal;
            
            // Mettre à jour le sous-total de l'article
            article.sousTotal = sousTotal;
        });
        
        // Appliquer remise globale si définie
        if (achat.remiseGlobale && achat.remiseGlobale > 0) {
            const remiseGlobale = parseFloat(achat.remiseGlobale) || 0;
            totalHT = totalHT - (totalHT * remiseGlobale / 100);
        }
        
        // Mettre à jour tous les champs de montant
        achat.totalHT = totalHT;
        achat.totalTTC = totalHT;
        achat.montant = totalHT;

        console.log(`Achat ${achat.id}: Recalculé montant = ${totalHT.toFixed(2)} DHS`);
    }

    // NOUVELLE FONCTION: Recalculer totaux vente
    recalculateVenteTotals(vente) {
        if (!vente.articles || !Array.isArray(vente.articles)) {
            vente.totalTTC = 0;
            return;
        }

        let total = 0;
        
        vente.articles.forEach(article => {
            const qty = parseFloat(article.quantite) || 0;
            const prix = parseFloat(article.prixUnitaire) || 0;
            const remise = parseFloat(article.remise) || 0;
            
            let sousTotal = qty * prix;
            sousTotal = sousTotal - (sousTotal * remise / 100);
            total += sousTotal;
            
            article.sousTotal = sousTotal;
        });
        
        vente.totalTTC = total;
        vente.montant = total;
    }

    normalizePaiementItem(item) {
        let paymentType = item.type || 'Encaissement';
        if (paymentType === 'ventes') paymentType = 'Encaissement';
        if (paymentType === 'achats') paymentType = 'Décaissement';
        return {
            id: item.id || generateId(),
            date: item.date || item.createdAt || new Date().toISOString(),
            montant: parseFloat(item.montant) || 0,
            mode: item.mode || 'Espèces',
            type: paymentType,
            description: item.description || '',
            reference: item.reference || item.docId || '',
            docId: item.docId || '',
            createdAt: item.createdAt || new Date().toISOString()
        };
    }

    async exportData() {
        if (!this.currentData) {
            showAlert('Aucune donnée à exporter', 'warning');
            return;
        }

        try {
            showProgress('Préparation de l\'export...', 30);

            const exportData = {
                metadata: {
                    exportDateIso: new Date().toISOString(),
                    exportDateFr: new Date().toLocaleDateString('fr-FR'),
                    version: '1.0',
                    appName: 'Pharma Gestion Pro - Hybride',
                    type: 'complete_backup',
                    exportedBy: 'user'
                },
                data: JSON.parse(JSON.stringify(this.currentData.data)),
                statistics: {
                    totalDocuments: Object.values(this.currentData.data).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0),
                    exportDuration: Date.now(),
                    fileSize: 0
                }
            };

            const fileName = `pharma_export_${new Date().toISOString().split('T')[0]}.json`;
            const jsonStr = JSON.stringify(exportData, null, 2);
            
            showProgress('Téléchargement...', 80);

            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);

            showProgress('Export terminé!', 100);
            setTimeout(() => {
                hideProgress();
                showAlert('Export terminé avec succès!', 'success');
            }, 500);

        } catch (error) {
            hideProgress();
            showAlert('Erreur export: ' + error.message, 'error');
        }
    }

    updateStorageStatus() {
        const modeElement = document.getElementById('storageMode');
        const modeText = document.getElementById('storageModeText');
        const hybridModeText = document.getElementById('hybridModeText');

        if (modeElement) {
            modeElement.className = 'storage-mode browser-only';
            modeText.innerHTML = '<i class="fas fa-database"></i> Mode Mémoire';
        }

        if (hybridModeText) {
            hybridModeText.textContent = 'Stockage en mémoire - Session courante';
        }

        this.updateDataSizeDisplay();
    }

    updateDataSizeDisplay() {
        try {
            const currentSize = this.currentData ? 
                new Blob([JSON.stringify(this.currentData)]).size : 0;
            const sizeMB = (currentSize / (1024 * 1024)).toFixed(1);
            
            const sizeElement = document.getElementById('currentDataSize');
            if (sizeElement) {
                sizeElement.textContent = `${sizeMB} MB`;
            }
        } catch (error) {
            console.warn('Erreur calcul taille:', error);
        }
    }

    initializeMainApp() {
        currentData = this.currentData;
        if (currentData) {
            originalData = JSON.parse(JSON.stringify(currentData));
            updateInterface();
        }
        
        document.getElementById('setup-section').style.display = 'none';
        showSection('dashboard');
        
        // Auto-sauvegarde toutes les 2 minutes
        setInterval(() => {
            if (this.currentData) {
                this.saveCurrentSession();
            }
        }, 2 * 60 * 1000);
    }
}

const hybridStorage = new HybridStorageManager();

/* ===================== FONCTIONS PRINCIPALES ===================== */

async function setupHybridStorage() {
    await hybridStorage.setup();
}

function showAlert(message, type='info') {
    let container = document.getElementById('alertsContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'alertsContainer';
        container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:1100;max-width:400px;';
        document.body.appendChild(container);
    }
    
    const alert = document.createElement('div');
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-times-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };
    
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <i class="${icons[type]}"></i>
        <span>${message}</span>
        <button style="background:none;border:none;color:inherit;cursor:pointer;margin-left:auto;padding:4px;" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    alert.style.marginBottom = '12px';
    container.appendChild(alert);
    
    setTimeout(() => { 
        if (alert.parentElement) alert.remove();
    }, 5000);
}

function updateConnectionStatus() {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    if (dot && text) {
        if (navigator.onLine) { 
            dot.classList.add('online'); 
            text.innerHTML = '<i class="fas fa-wifi"></i> En ligne'; 
        } else { 
            dot.classList.remove('online'); 
            text.innerHTML = '<i class="fas fa-wifi-slash"></i> Hors ligne'; 
        }
    }
}

function filterTable(query) { 
    searchFilter = query.toLowerCase(); 
    updateSectionContent(currentSection); 
}

function generateId() { 
    return 'hybrid_' + Math.random().toString(36).substr(2,9) + '_' + Date.now(); 
}

async function clearAllData() {
    if (confirm('⚠️ ATTENTION: Voulez-vous vraiment effacer toutes les données ?\n\nCette action est irréversible. Confirmez-vous ?')) {
        try {
            showProgress('Effacement des données...', 50);
            
            // Réinitialiser l'état
            hybridStorage.currentData = null;
            hybridStorage.memoryStorage = {};
            currentData = null;
            originalData = null;
            
            // Nettoyer localStorage si disponible
            try {
                if (typeof localStorage !== 'undefined') {
                    localStorage.removeItem('pharma_backup');
                }
            } catch (e) {
                // Ignorer si localStorage non disponible
            }
            
            hybridStorage.updateStorageStatus();
            
            // Retourner à l'écran de setup
            document.getElementById('setup-section').style.display = 'block';
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            
            showProgress('Réinitialisation terminée!', 100);
            setTimeout(() => {
                hideProgress();
                showAlert('Application réinitialisée avec succès', 'info');
            }, 500);
            
        } catch (error) {
            hideProgress();
            showAlert('Erreur lors de la réinitialisation: ' + error.message, 'error');
        }
    }
}

async function handleFileImport(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    try {
        for (const file of files) {
            showProgress(`Import de ${file.name}...`, 30);
            
            const text = await file.text();
            const data = JSON.parse(text);
            
            await hybridStorage.importData(data);
        }
        
    } catch (error) {
        hideProgress();
        showAlert('Erreur import: ' + error.message, 'error');
    }
    
    // Reset input
    event.target.value = '';
}

function openExportOptions() {
    if (!hybridStorage.currentData) {
        showAlert('Aucune donnée à exporter', 'warning');
        return;
    }

    hybridStorage.exportData();
}

// Interface de base
function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('open');
}

function showSection(section, event) {
    currentSection = section;
    
    // Masquer setup si navigation vers section
    if (section !== 'setup') {
        document.getElementById('setup-section').style.display = 'none';
    }
    
    // Fermer sidebar mobile
    document.querySelector('.sidebar').classList.remove('open');
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (event && (event.currentTarget || event.target)) {
        (event.currentTarget || event.target).classList.add('active');
    }
    
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
    const targetSection = document.getElementById(`section-${section}`);
    if (targetSection) {
        targetSection.style.display = 'block';
        updateSectionContent(section);
    }
    updatePageHeader(section);
}

// Modals et actions
function openAddModal(section) {
    editingItem = null;
    editingIndex = null;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = createFormModal(section, 'Ajouter');
    document.body.appendChild(modal);
}

function openEditModal(section, index) {
    if (!currentData || !currentData.data[section] || !currentData.data[section][index]) {
        showAlert('Élément introuvable', 'error');
        return;
    }
    
    editingItem = currentData.data[section][index];
    editingIndex = index;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = createFormModal(section, 'Modifier');
    document.body.appendChild(modal);
    
    // Pré-remplir le formulaire
    populateForm(section, editingItem);
}

function createFormModal(section, action) {
    const config = getFormConfig(section);
    
    return `
        <div class="modal-content" style="max-width: ${config.width};">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="${config.icon}"></i>
                    ${action} ${config.title}
                </div>
                <button class="modal-close" onclick="closeFormModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                ${createFormFields(section, config)}
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFormModal()">
                    <i class="fas fa-times"></i>
                    Annuler
                </button>
                <button class="btn btn-primary" onclick="saveForm('${section}')">
                    <i class="fas fa-save"></i>
                    ${action === 'Ajouter' ? 'Ajouter' : 'Sauvegarder'}
                </button>
            </div>
        </div>
    `;
}

function getFormConfig(section) {
    const configs = {
        stock: {
            title: 'Produit',
            icon: 'fas fa-pills',
            width: '700px',
            fields: [
                { name: 'nom', label: 'Nom du produit', type: 'text', required: true, icon: 'pills' },
                { name: 'quantite', label: 'Quantité en stock', type: 'number', required: true, icon: 'warehouse' },
                { name: 'seuil', label: 'Seuil d\'alerte', type: 'number', defaultValue: '5', icon: 'exclamation-triangle' },
                { name: 'prixVente', label: 'Prix de vente (DHS)', type: 'number', step: '0.01', required: true, icon: 'tag' },
                { name: 'prixAchat', label: 'Prix d\'achat (DHS)', type: 'number', step: '0.01', icon: 'shopping-cart' },
                { name: 'datePeremption', label: 'Date de péremption', type: 'date', icon: 'calendar-alt' },
                { name: 'fournisseur', label: 'Fournisseur', type: 'text', icon: 'truck' },
                { name: 'codeArticle', label: 'Code article', type: 'text', icon: 'barcode' }
            ]
        },
        ventes: {
            title: 'Vente',
            icon: 'fas fa-cash-register',
            width: '800px',
            fields: [
                { name: 'date', label: 'Date de vente', type: 'datetime-local', required: true, icon: 'calendar', defaultValue: 'now' },
                { name: 'client', label: 'Nom du client', type: 'text', icon: 'user' },
                { name: 'telephone', label: 'Téléphone client', type: 'tel', icon: 'phone' },
                { name: 'modePaiement', label: 'Mode de paiement', type: 'select', required: true, icon: 'credit-card',
                  options: ['Espèces', 'Carte bancaire', 'Chèque', 'Virement'] },
                { name: 'statutPaiement', label: 'Statut paiement', type: 'select', required: true, icon: 'check-circle',
                  options: ['payé', 'impayé', 'partiel'], defaultValue: 'payé' },
                { name: 'articles', label: 'Articles vendus', type: 'articles-vente', icon: 'list' }
            ]
        },
        achats: {
            title: 'Commande',
            icon: 'fas fa-truck',
            width: '800px',
            fields: [
                { name: 'date', label: 'Date de commande', type: 'datetime-local', required: true, icon: 'calendar', defaultValue: 'now' },
                { name: 'fournisseur', label: 'Fournisseur', type: 'text', required: true, icon: 'building' },
                { name: 'contactFournisseur', label: 'Contact fournisseur', type: 'text', icon: 'phone' },
                { name: 'dateLivraison', label: 'Date de livraison prévue', type: 'date', icon: 'truck' },
                { name: 'statutPaiement', label: 'Statut paiement', type: 'select', required: true, icon: 'check-circle',
                  options: ['payé', 'impayé', 'partiel'], defaultValue: 'impayé' },
                { name: 'modePaiement', label: 'Mode de paiement', type: 'select', icon: 'credit-card',
                  options: ['Espèces', 'Carte bancaire', 'Chèque', 'Virement'], defaultValue: 'Espèces' },
                { name: 'remiseGlobale', label: 'Remise globale (%)', type: 'number', step: '0.01', icon: 'percent' },
                { name: 'articles', label: 'Articles commandés', type: 'articles-achat', icon: 'list' }
            ]
        },
        paiements: {
            title: 'Paiement',
            icon: 'fas fa-credit-card',
            width: '600px',
            fields: [
                { name: 'date', label: 'Date du paiement', type: 'datetime-local', required: true, icon: 'calendar', defaultValue: 'now' },
                { name: 'montant', label: 'Montant (DHS)', type: 'number', step: '0.01', required: true, icon: 'euro-sign' },
                { name: 'mode', label: 'Mode de paiement', type: 'select', required: true, icon: 'credit-card',
                  options: ['Espèces', 'Carte bancaire', 'Chèque', 'Virement', 'Prélèvement'] },
                { name: 'type', label: 'Type', type: 'select', required: true, icon: 'tag',
                  options: ['Encaissement', 'Décaissement', 'Remboursement', 'Acompte'] },
                { name: 'description', label: 'Description', type: 'textarea', icon: 'comment' },
                { name: 'reference', label: 'Référence', type: 'text', icon: 'hashtag' },
                { name: 'docId', label: 'Document associé', type: 'text', icon: 'file-alt' }
            ]
        }
    };
    return configs[section] || { title: section, icon: 'fas fa-file', width: '600px', fields: [] };
}

function createFormFields(section, config) {
    let html = '<div style="display: grid; gap: 20px;">';
    
    config.fields.forEach(field => {
        html += createFieldHTML(field);
    });
    
    html += '</div>';
    return html;
}

function createFieldHTML(field) {
    const isRequired = field.required ? 'required' : '';
    const defaultVal = field.defaultValue === 'now' ? new Date().toISOString().slice(0, 16) : (field.defaultValue || '');
    
    let inputHTML = '';
    
    switch (field.type) {
        case 'select':
            inputHTML = `
                <select id="field_${field.name}" ${isRequired} class="form-input">
                    <option value="">Choisir...</option>
                    ${field.options.map(opt => `<option value="${opt}" ${opt === defaultVal ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
            `;
            break;
        
        case 'textarea':
            inputHTML = `<textarea id="field_${field.name}" ${isRequired} class="form-input" rows="3" placeholder="${field.label}">${defaultVal}</textarea>`;
            break;
        
        case 'articles-vente':
        case 'articles-achat':
            inputHTML = `
                <div class="articles-container">
                    <div class="articles-header">
                        <button type="button" class="btn btn-sm btn-primary" onclick="addArticleRow('${field.type}')">
                            <i class="fas fa-plus"></i>
                            Ajouter article
                        </button>
                    </div>
                    <div id="articles-list" class="articles-list"></div>
                    <input type="hidden" id="field_${field.name}" value="[]">
                    <div id="total-general"></div>
                </div>
            `;
            break;
        
        default:
            inputHTML = `<input type="${field.type}" id="field_${field.name}" ${isRequired} class="form-input" placeholder="${field.label}" value="${defaultVal}" ${field.step ? `step="${field.step}"` : ''}>`;
            break;
    }
    
    return `
        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-${field.icon}" style="margin-right: 8px; color: var(--primary-color);"></i>
                ${field.label}
                ${field.required ? '<span style="color: var(--danger-color);">*</span>' : ''}
            </label>
            ${inputHTML}
        </div>
    `;
}

function populateForm(section, item) {
    const config = getFormConfig(section);
    
    config.fields.forEach(field => {
        const element = document.getElementById(`field_${field.name}`);
        if (!element) return;
        
        let value = item[field.name];
        
        if (field.type === 'datetime-local' && value) {
            // Convertir date ISO en format datetime-local
            try {
                const date = new Date(value);
                value = date.toISOString().slice(0, 16);
            } catch (e) {
                value = '';
            }
        } else if (field.type === 'articles-vente' || field.type === 'articles-achat') {
            if (Array.isArray(value)) {
                populateArticles(field.type, value);
                element.value = JSON.stringify(value);
            }
            return;
        }
        
        element.value = value || '';
    });
}

function closeFormModal() {
    const modal = document.querySelector('.modal');
    if (modal) modal.remove();
    editingItem = null;
    editingIndex = null;
}

async function saveForm(section) {
    try {
        const formData = collectFormData(section);
        
        // Validation
        if (!validateFormData(section, formData)) {
            return;
        }
        
        // Initialiser données si nécessaire
        if (!currentData) {
            currentData = {
                metadata: { createdAt: new Date().toISOString(), version: '1.0' },
                data: { stock: [], ventes: [], achats: [], paiements: [] }
            };
            hybridStorage.currentData = currentData;
        }
        
        if (!currentData.data[section]) {
            currentData.data[section] = [];
        }
        
        // Ajouter métadonnées
        formData.id = formData.id || generateId();
        formData.createdAt = formData.createdAt || new Date().toISOString();
        if (editingItem) {
            formData.updatedAt = new Date().toISOString();
        }
        
        // Traitement spécial selon section
        if (section === 'ventes' || section === 'achats') {
            calculateTotals(formData);
        }
        
        // Sauvegarder
        if (editingIndex !== null) {
            currentData.data[section][editingIndex] = formData;
            showAlert('Élément modifié avec succès', 'success');
        } else {
            currentData.data[section].unshift(formData);
            showAlert('Élément ajouté avec succès', 'success');
        }
        
        // Mise à jour stock selon le type
        if (section === 'ventes' && formData.articles) {
            updateStockFromSale(formData.articles);
        } else if (section === 'achats' && formData.articles) {
            updateStockFromPurchase(formData.articles, formData.fournisseur);
        }
        
        // Créer paiement automatique si payé
        if ((section === 'ventes' || section === 'achats') && formData.statutPaiement === 'payé') {
            const existingPayment = currentData.data.paiements.find(p => p.docId === formData.id);
            if (!existingPayment) {
                const paymentType = section === 'ventes' ? 'Encaissement' : 'Décaissement';
                const payment = {
                    id: generateId(),
                    date: formData.date,
                    montant: formData.totalTTC,
                    mode: formData.modePaiement || 'Espèces',
                    type: paymentType,
                    description: `Paiement automatique pour ${section} ${formData.id}`,
                    reference: formData.id,
                    docId: formData.id,
                    createdAt: new Date().toISOString()
                };
                currentData.data.paiements.push(payment);
                showAlert('Paiement automatique créé', 'info');
            }
        }

        // Sauvegarde
        hybridStorage.currentData = currentData;
        await hybridStorage.saveCurrentSession();
        
        // Mise à jour interface
        updateInterface();
        updateSectionContent(section);
        closeFormModal();
        
    } catch (error) {
        showAlert('Erreur lors de la sauvegarde: ' + error.message, 'error');
    }
}

function getTableColumns(section) {
    const columns = {
        stock: [
            { key:'nom', label:'Produit', icon:'pills' },
            { key:'quantite', label:'Stock', icon:'warehouse' },
            { key:'prixVente', label:'Prix Vente', icon:'tag' },
            { key:'prixAchat', label:'Prix Achat', icon:'shopping-cart' },
            { key:'datePeremption', label:'Expiration', icon:'calendar-alt' },
            { key:'_marge', label:'Marge', icon:'percent' }
        ],
        ventes: [
            { key:'date', label:'Date', icon:'calendar' },
            { key:'client', label:'Client', icon:'user' },
            { key:'_montant_vente', label:'Montant', icon:'euro-sign' },
            { key:'_benefice_vente', label:'Bénéfice', icon:'chart-line' },
            { key:'modePaiement', label:'Paiement', icon:'credit-card' }
        ],
        achats: [
            { key:'date', label:'Date', icon:'calendar' },
            { key:'fournisseur', label:'Fournisseur', icon:'building' },
            { key:'_montant_achat', label:'Montant', icon:'euro-sign' },
            { key:'_benefice_potentiel', label:'Bénéfice Potentiel', icon:'chart-line' },
            { key:'articles', label:'Articles', icon:'list' }
        ],
        paiements: [
            { key:'date', label:'Date', icon:'calendar' },
            { key:'montant', label:'Montant', icon:'euro-sign' },
            { key:'mode', label:'Mode', icon:'credit-card' },
            { key:'type', label:'Type', icon:'tag' }
        ]
    };
    return columns[section] || [];
}

function formatCellValue(value, key, item) {
    if (value === null || value === undefined) {
        return '<span style="color: var(--text-muted);">—</span>';
    }
    
    switch (key) {
        case 'date':
        case 'datePeremption':
        case 'createdAt':
            try { 
                const date = new Date(value);
                const today = new Date();
                const isExpiringSoon = key === 'datePeremption' && date <= new Date(today.getTime() + 30*24*60*60*1000);
                const isExpired = key === 'datePeremption' && date <= today;
                
                let dateStr = date.toLocaleDateString('fr-FR');
                if (isExpired) {
                    return `<span style="color: var(--danger-color); font-weight: 600;">⚠️ ${dateStr} (Expiré)</span>`;
                } else if (isExpiringSoon) {
                    return `<span style="color: var(--warning-color); font-weight: 600;">⚠️ ${dateStr}</span>`;
                }
                return dateStr;
            } catch(e){ return String(value); }
            
        case '_marge': {
            const prixVente = parseFloat(item.prixVente) || 0;
            const prixAchat = parseFloat(item.prixAchat) || 0;
            const marge = prixVente - prixAchat;
            const pourcentage = prixAchat > 0 ? ((marge / prixAchat) * 100).toFixed(1) : '0';
            const color = marge > 0 ? 'var(--success-color)' : 'var(--danger-color)';
            return `<span style="color: ${color}; font-weight: 600;">${marge.toFixed(2)} DHS (${pourcentage}%)</span>`;
        }
        
        case '_benefice_vente': {
            let beneficeTotal = 0;
            if (Array.isArray(item.articles)) {
                item.articles.forEach(article => {
                    const stockItem = currentData.data.stock?.find(s => s.nom === article.produit);
                    if (stockItem) {
                        const prixAchat = parseFloat(stockItem.prixAchat) || 0;
                        const prixVente = parseFloat(article.prixUnitaire) || 0;
                        const quantite = parseFloat(article.quantite) || 0;
                        beneficeTotal += (prixVente - prixAchat) * quantite;
                    }
                });
            }
            const color = beneficeTotal > 0 ? 'var(--success-color)' : 'var(--danger-color)';
            return `<span style="color: ${color}; font-weight: 600;">${beneficeTotal.toFixed(2)} DHS</span>`;
        }
        
        case '_benefice_potentiel': {
            let beneficePotentiel = 0;
            if (Array.isArray(item.articles)) {
                item.articles.forEach(article => {
                    const prixVente = parseFloat(article.prixVente) || 0;
                    const prixAchat = parseFloat(article.prixAchat) || 0;
                    const quantite = parseFloat(article.quantite) || 0;
                    beneficePotentiel += (prixVente - prixAchat) * quantite;
                });
            }
            const color = beneficePotentiel > 0 ? 'var(--success-color)' : 'var(--danger-color)';
            return `<span style="color: ${color}; font-weight: 600;">${beneficePotentiel.toFixed(2)} DHS</span>`;
        }
            
        case 'totalTTC':
        case 'montant':
        case 'prixVente':
        case 'prixAchat': {
            const n = parseNumeric(value) || 0;
            return `<strong>${n.toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong>`;
        }
        
        case 'quantite':
        case 'stock': {
            const qty = parseInt(value)||0;
            const seuil = parseInt(item.seuil)||5;
            const isLow = qty <= seuil;
            const icon = isLow ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
            const color = isLow ? 'var(--danger-color)' : 'var(--success-color)';
            return `<span style="color: ${color}; font-weight: 600;"><i class="${icon}"></i> ${qty}</span>`;
        }
        
        case 'statutPaiement': {
            const statusClass = value === 'payé' ? 'status-paid' : value === 'impayé' ? 'status-unpaid' : 'status-partial';
            return `<span class="status-badge ${statusClass}"><i class="fas fa-circle"></i> ${value}</span>`;
        }
        
        case 'modePaiement': {
            const icons = { 
                'Espèces': 'fas fa-money-bill-wave', 
                'Carte bancaire': 'fas fa-credit-card', 
                'Chèque': 'fas fa-money-check',
                'Virement': 'fas fa-exchange-alt'
            };
            return `<i class="${icons[value] || 'fas fa-payment'}" style="margin-right: 6px; color: var(--primary-color);"></i>${value}`;
        }
        
        case 'articles':
            if (Array.isArray(value)) {
                const count = value.length;
                const preview = value.map(a => {
                    const expInfo = a.datePeremption ? ` (Exp: ${new Date(a.datePeremption).toLocaleDateString('fr-FR')})` : '';
                    return `${a.produit || 'Article'}${expInfo}`;
                }).slice(0,2).join(', ');
                const title = preview + (count > 2 ? '...' : '');
                return `<span title="${title}">
                    <i class="fas fa-list" style="margin-right: 6px; color: var(--primary-color);"></i>
                    ${count} article${count > 1 ? 's' : ''}
                </span>`;
            }
            return '<span style="color: var(--text-muted);">—</span>';
            
        default:
            const str = String(value);
            return str.length > 60 ? str.substring(0, 57) + '...' : str;
    }
}

function collectFormData(section) {
    const config = getFormConfig(section);
    const formData = {};
    
    config.fields.forEach(field => {
        const element = document.getElementById(`field_${field.name}`);
        if (!element) return;
        
        let value = element.value;
        
        if (field.type === 'number') {
            value = parseFloat(value) || 0;
        } else if (field.type === 'articles-vente' || field.type === 'articles-achat') {
            try {
                value = JSON.parse(value) || [];
            } catch {
                value = [];
            }
        }
        
        if (value !== '' && value !== null) {
            formData[field.name] = value;
        }
    });
    
    return formData;
}

function validateFormData(section, data) {
    const config = getFormConfig(section);
    
    for (const field of config.fields) {
        if (field.required && (!data[field.name] || data[field.name] === '')) {
            showAlert(`Le champ "${field.label}" est obligatoire`, 'error');
            document.getElementById(`field_${field.name}`)?.focus();
            return false;
        }
    }
    
    // Validations spécifiques
    if (section === 'stock') {
        if (data.quantite < 0) {
            showAlert('La quantité ne peut pas être négative', 'error');
            return false;
        }
        if (data.prixVente <= 0) {
            showAlert('Le prix de vente doit être positif', 'error');
            return false;
        }
        if (data.prixAchat && data.prixVente <= data.prixAchat) {
            if (!confirm(`Le prix de vente (${data.prixVente} DHS) est inférieur ou égal au prix d'achat (${data.prixAchat} DHS). Aucun bénéfice ne sera réalisé. Continuer ?`)) {
                return false;
            }
        }
    }
    
    if ((section === 'ventes' || section === 'achats') && (!data.articles || data.articles.length === 0)) {
        showAlert('Vous devez ajouter au moins un article', 'error');
        return false;
    }
    
    // Validations pour les achats
    if (section === 'achats' && data.articles) {
        for (const article of data.articles) {
            if (!article.datePeremption) {
                showAlert(`Date d'expiration obligatoire pour "${article.produit}"`, 'error');
                return false;
            }
            if (!article.prixVente || parseFloat(article.prixVente) <= 0) {
                showAlert(`Prix de vente obligatoire pour "${article.produit}"`, 'error');
                return false;
            }
            if (parseFloat(article.prixVente) <= parseFloat(article.prixAchat)) {
                if (!confirm(`Le prix de vente de "${article.produit}" est inférieur ou égal au prix d'achat. Aucun bénéfice ne sera réalisé. Continuer ?`)) {
                    return false;
                }
            }
            
            // Vérifier date d'expiration
            const expDate = new Date(article.datePeremption);
            const today = new Date();
            if (expDate <= today) {
                showAlert(`Le produit "${article.produit}" a une date d'expiration dépassée`, 'error');
                return false;
            }
            
            // Avertissement si proche de l'expiration
            const warningDate = new Date(today.getTime() + 30*24*60*60*1000); // 30 jours
            if (expDate <= warningDate) {
                if (!confirm(`Le produit "${article.produit}" expire dans moins de 30 jours (${expDate.toLocaleDateString('fr-FR')}). Continuer ?`)) {
                    return false;
                }
            }
        }
    }
    
    // Validations pour les ventes
    if (section === 'ventes' && data.articles) {
        for (const article of data.articles) {
            // Vérifier si le bénéfice est positif
            if (article.beneficeUnitaire && article.beneficeUnitaire <= 0) {
                if (!confirm(`La vente de "${article.produit}" ne génère aucun bénéfice (${article.beneficeUnitaire.toFixed(2)} DHS). Continuer ?`)) {
                    return false;
                }
            }
        }
    }
    
    return true;
}

function calculateTotals(data) {
    if (!data.articles || !Array.isArray(data.articles)) return;
    
    let totalHT = 0;
    
    data.articles.forEach(article => {
        const qty = parseFloat(article.quantite) || 0;
        const prix = parseFloat(article.prixUnitaire || article.prixAchat) || 0;
        const remise = parseFloat(article.remise) || 0;
        
        let sousTotal = qty * prix;
        sousTotal = sousTotal - (sousTotal * remise / 100);
        totalHT += sousTotal;
        
        article.sousTotal = sousTotal;
    });
    
    // Remise globale pour achats
    if (data.remiseGlobale) {
        const remiseGlobale = parseFloat(data.remiseGlobale) || 0;
        totalHT = totalHT - (totalHT * remiseGlobale / 100);
    }
    
    data.totalHT = totalHT;
    data.totalTTC = totalHT;
    data.montant = totalHT;
}

function updateStockFromSale(articles) {
    if (!currentData.data.stock || !Array.isArray(articles)) return;
    
    articles.forEach(venteArticle => {
        const stockItem = currentData.data.stock.find(s => 
            s.nom === venteArticle.produit || s.id === venteArticle.produitId
        );
        
        if (stockItem) {
            const qtVendue = parseFloat(venteArticle.quantite) || 0;
            const qtActuelle = parseFloat(stockItem.quantite) || 0;
            stockItem.quantite = Math.max(0, qtActuelle - qtVendue);
            stockItem.updatedAt = new Date().toISOString();
        }
    });
}

function updateStockFromPurchase(articles, fournisseur) {
    if (!currentData.data.stock) currentData.data.stock = [];
    
    articles.forEach(achatArticle => {
        let stockItem = currentData.data.stock.find(s => s.nom === achatArticle.produit);
        
        if (stockItem) {
            // Mettre à jour stock
            const qtAjoutee = parseFloat(achatArticle.quantite) || 0;
            stockItem.quantite = (parseFloat(stockItem.quantite) || 0) + qtAjoutee;
            stockItem.prixAchat = parseFloat(achatArticle.prixAchat) || stockItem.prixAchat;
            stockItem.prixVente = parseFloat(achatArticle.prixVente) || stockItem.prixVente;
            
            // Mettre à jour date d'expiration si plus récente
            if (achatArticle.datePeremption) {
                if (!stockItem.datePeremption || new Date(achatArticle.datePeremption) > new Date(stockItem.datePeremption)) {
                    stockItem.datePeremption = achatArticle.datePeremption;
                }
            }
            
            stockItem.fournisseur = fournisseur;
            stockItem.updatedAt = new Date().toISOString();
        } else {
            // Créer nouveau produit en stock
            const newStockItem = {
                id: generateId(),
                nom: achatArticle.produit,
                quantite: parseFloat(achatArticle.quantite) || 0,
                seuil: 5, // Seuil par défaut
                prixVente: parseFloat(achatArticle.prixVente) || 0,
                prixAchat: parseFloat(achatArticle.prixAchat) || 0,
                datePeremption: achatArticle.datePeremption || null,
                fournisseur: fournisseur,
                codeArticle: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            currentData.data.stock.push(newStockItem);
        }
    });
}

function confirmDelete(section, index) {
    if (confirm('Voulez-vous vraiment supprimer cet élément ?')) {
        deleteItem(section, index);
    }
}

async function deleteItem(section, index) {
    if (currentData && currentData.data[section]) {
        currentData.data[section].splice(index, 1);
        hybridStorage.currentData = currentData;
        await hybridStorage.saveCurrentSession();
        updateInterface();
        updateSectionContent(section);
        showAlert('Élément supprimé', 'success');
    }
}

// Fonctions d'affichage et utilitaires
function showProgress(text, percentage) {
    let progressModal = document.getElementById('progressModal');
    if (!progressModal) {
        createProgressModal();
        progressModal = document.getElementById('progressModal');
    }
    
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    const progressDetails = document.getElementById('progressDetails');
    
    if (progressText) progressText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
    if (progressBar) progressBar.style.width = percentage + '%';
    if (progressDetails) progressDetails.textContent = `${percentage}%`;
    progressModal.style.display = 'block';
}

function hideProgress() {
    const progressModal = document.getElementById('progressModal');
    if (progressModal) {
        progressModal.style.display = 'none';
    }
}

function createProgressModal() {
    if (document.getElementById('progressModal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'progressModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width:450px;">
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner" style="margin: 0 auto 16px;"></div>
                    <div id="progressText" style="font-weight: 600; margin-bottom: 16px;">Traitement en cours...</div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width:0%;"></div>
                    </div>
                    <div id="progressDetails" style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;"></div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function removeArticleRow(button) {
    button.closest('.article-row').remove();
    updateArticleData();
}

function populateArticles(type, articles) {
    const container = document.getElementById('articles-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    articles.forEach(article => {
        addArticleRow(type);
        const lastRow = container.lastElementChild;
        const inputs = lastRow.querySelectorAll('input, select');
        
        const isVente = type === 'articles-vente';
        
        if (isVente) {
            // Remplir formulaire vente
            if (inputs[0]) inputs[0].value = article.produit || '';
            if (inputs[1]) inputs[1].value = article.quantite || '';
            if (inputs[2]) inputs[2].value = article.prixUnitaire || '';
            if (inputs[3]) inputs[3].value = article.remise || '';
        } else {
            // Remplir formulaire achat
            if (inputs[0]) inputs[0].value = article.produit || '';
            if (inputs[1]) inputs[1].value = article.quantite || '';
            if (inputs[2]) inputs[2].value = article.prixAchat || '';
            if (inputs[3]) inputs[3].value = article.prixVente || '';
            if (inputs[4]) inputs[4].value = article.datePeremption ? article.datePeremption.split('T')[0] : '';
            if (inputs[5]) inputs[5].value = article.numeroLot || '';
            if (inputs[6]) inputs[6].value = article.remise || '';
        }
    });
    
    updateArticleData();
}

function addArticleRow(type) {
    const container = document.getElementById('articles-list');
    if (!container) {
        showAlert('Conteneur articles introuvable', 'error');
        return;
    }
    
    const index = container.children.length;
    const isVente = type === 'articles-vente';
    const row = document.createElement('div');
    row.className = 'article-row';
    
    if (isVente) {
        // Formulaire de vente avec calcul de bénéfice
        row.innerHTML = `
            <div class="article-form">
                <div class="form-row">
                    <div class="form-col">
                        <label>Produit *</label>
                        ${createProductSelect(index)}
                    </div>
                    <div class="form-col">
                        <label>Quantité *</label>
                        <input type="number" class="form-input" min="0" step="1" placeholder="Quantité" onchange="updateArticleData()">
                    </div>
                    <div class="form-col">
                        <label>Prix Vente *</label>
                        <input type="number" class="form-input" min="0" step="0.01" placeholder="Prix vente" onchange="updateArticleData()">
                    </div>
                    <div class="form-col">
                        <label>Remise (%)</label>
                        <input type="number" class="form-input" min="0" max="100" step="0.01" placeholder="0" onchange="updateArticleData()">
                    </div>
                    <div class="form-col-action">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeArticleRow(this)" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="article-details">
                    <div class="detail-row">
                        <span class="detail-label">Prix d'achat:</span>
                        <span class="prix-achat">0.00 DHS</span>
                        <span class="detail-label">Expiration:</span>
                        <span class="date-expiration">Non définie</span>
                        <span class="detail-label">Bénéfice unitaire:</span>
                        <span class="benefice-unitaire" style="font-weight: 600;">0.00 DHS</span>
                    </div>
                </div>
                <div class="article-total">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Sous-total: <span class="article-subtotal">0.00 DHS</span></span>
                        <span style="color: var(--success-color); font-weight: 600;">
                            Bénéfice total: <span class="benefice-total">0.00 DHS</span>
                        </span>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Formulaire d'achat avec date d'expiration et prix de vente
        row.innerHTML = `
            <div class="article-form">
                <div class="form-row">
                    <div class="form-col">
                        <label>Produit *</label>
                        <input type="text" class="form-input" placeholder="Nom du produit" onchange="updateArticleData()">
                    </div>
                    <div class="form-col">
                        <label>Quantité *</label>
                        <input type="number" class="form-input" min="0" step="1" placeholder="Quantité" onchange="updateArticleData()">
                    </div>
                    <div class="form-col">
                        <label>Prix d'achat *</label>
                        <input type="number" class="form-input" min="0" step="0.01" placeholder="Prix achat" onchange="updateArticleData()">
                    </div>
                    <div class="form-col">
                        <label>Prix de vente *</label>
                        <input type="number" class="form-input" min="0" step="0.01" placeholder="Prix vente" onchange="updateArticleData()">
                    </div>
                    <div class="form-col-action">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeArticleRow(this)" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="form-row" style="margin-top: 12px;">
                    <div class="form-col">
                        <label>Date d'expiration *</label>
                        <input type="date" class="form-input" onchange="updateArticleData()">
                    </div>
                    <div class="form-col">
                        <label>Numéro de lot</label>
                        <input type="text" class="form-input" placeholder="Lot" onchange="updateArticleData()">
                    </div>
                    <div class="form-col">
                        <label>Remise (%)</label>
                        <input type="number" class="form-input" min="0" max="100" step="0.01" placeholder="0" onchange="updateArticleData()">
                    </div>
                    <div class="form-col">
                        <label style="color: var(--success-color);">Marge unitaire</label>
                        <input type="text" class="form-input marge-display" readonly style="background: #f0fdfa; color: var(--success-color); font-weight: 600;">
                    </div>
                </div>
                <div class="article-total">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Coût total: <span class="article-subtotal">0.00 DHS</span></span>
                        <span style="color: var(--success-color); font-weight: 600;">
                            Bénéfice potentiel: <span class="benefice-potentiel">0.00 DHS</span>
                        </span>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.appendChild(row);
    updateArticleData();
}

function createProductSelect(index) {
    if (!currentData || !currentData.data.stock) {
        return '<input type="text" class="form-input" placeholder="Nom du produit" onchange="updateArticleData()">';
    }
    
    const options = currentData.data.stock
        .filter(item => (parseInt(item.quantite) || 0) > 0)
        .map(item => {
            const expDate = item.datePeremption ? new Date(item.datePeremption).toLocaleDateString('fr-FR') : 'Non définie';
            const isExpiringSoon = item.datePeremption && new Date(item.datePeremption) <= new Date(Date.now() + 30*24*60*60*1000);
            const warningIcon = isExpiringSoon ? ' ⚠️' : '';
            
            return `<option value="${item.nom}" 
                data-prix-vente="${item.prixVente}" 
                data-prix-achat="${item.prixAchat || 0}"
                data-stock="${item.quantite}"
                data-expiration="${item.datePeremption || ''}"
                data-expiration-formatted="${expDate}">
                ${item.nom} (Stock: ${item.quantite}, Exp: ${expDate})${warningIcon}
            </option>`;
        })
        .join('');
    
    return `
        <select class="form-input" onchange="selectProduct(this); updateArticleData();">
            <option value="">Choisir un produit...</option>
            ${options}
        </select>
    `;
}

function selectProduct(select) {
    const option = select.selectedOptions[0];
    if (!option) return;
    
    const prixVente = option.getAttribute('data-prix-vente');
    const prixAchat = option.getAttribute('data-prix-achat');
    const stock = option.getAttribute('data-stock');
    const expiration = option.getAttribute('data-expiration');
    const expirationFormatted = option.getAttribute('data-expiration-formatted');
    
    const row = select.closest('.article-row');
    const prixInput = row.querySelector('input[placeholder="Prix vente"]');
    const qtyInput = row.querySelector('input[placeholder="Quantité"]');
    const prixAchatSpan = row.querySelector('.prix-achat');
    const dateExpirationSpan = row.querySelector('.date-expiration');
    
    if (prixVente && prixInput) prixInput.value = prixVente;
    if (stock && qtyInput) qtyInput.max = stock;
    if (prixAchatSpan) prixAchatSpan.textContent = `${parseFloat(prixAchat || 0).toFixed(2)} DHS`;
    if (dateExpirationSpan) {
        dateExpirationSpan.textContent = expirationFormatted;
        // Colorer en rouge si proche de l'expiration
        if (expiration && new Date(expiration) <= new Date(Date.now() + 30*24*60*60*1000)) {
            dateExpirationSpan.style.color = 'var(--danger-color)';
            dateExpirationSpan.innerHTML = `⚠️ ${expirationFormatted}`;
        }
    }
}

function updateArticleData() {
    const container = document.getElementById('articles-list');
    const hiddenInput = document.getElementById('field_articles');
    if (!container || !hiddenInput) return;
    
    const articles = [];
    let totalGeneral = 0;
    let beneficeTotal = 0;
    
    Array.from(container.children).forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        const article = {};
        
        const isVente = row.querySelector('.benefice-unitaire') !== null;
        
        if (isVente) {
            // Traitement vente
            const produitInput = inputs[0];
            const qtyInput = inputs[1];
            const prixVenteInput = inputs[2];
            const remiseInput = inputs[3];
            
            article.produit = produitInput.value;
            article.quantite = parseFloat(qtyInput.value) || 0;
            article.prixUnitaire = parseFloat(prixVenteInput.value) || 0;
            article.remise = parseFloat(remiseInput.value) || 0;
            
            // Récupérer prix d'achat depuis le stock
            let prixAchat = 0;
            if (currentData && currentData.data.stock) {
                const stockItem = currentData.data.stock.find(s => s.nom === article.produit);
                if (stockItem) {
                    prixAchat = parseFloat(stockItem.prixAchat) || 0;
                    article.datePeremption = stockItem.datePeremption;
                }
            }
            
            // Calculer bénéfices
            const beneficeUnitaire = article.prixUnitaire - prixAchat;
            let sousTotal = article.quantite * article.prixUnitaire;
            sousTotal = sousTotal - (sousTotal * article.remise / 100);
            const beneficeArticle = article.quantite * beneficeUnitaire;
            
            article.sousTotal = sousTotal;
            article.beneficeUnitaire = beneficeUnitaire;
            article.beneficeTotal = beneficeArticle;
            
            // Affichage
            const beneficeUnitaireSpan = row.querySelector('.benefice-unitaire');
            const beneficeTotalSpan = row.querySelector('.benefice-total');
            const subtotalSpan = row.querySelector('.article-subtotal');
            
            if (beneficeUnitaireSpan) {
                beneficeUnitaireSpan.textContent = `${beneficeUnitaire.toFixed(2)} DHS`;
                beneficeUnitaireSpan.style.color = beneficeUnitaire > 0 ? 'var(--success-color)' : 'var(--danger-color)';
            }
            if (beneficeTotalSpan) {
                beneficeTotalSpan.textContent = `${beneficeArticle.toFixed(2)} DHS`;
            }
            if (subtotalSpan) {
                subtotalSpan.textContent = `${sousTotal.toFixed(2)} DHS`;
            }
            
            totalGeneral += sousTotal;
            beneficeTotal += beneficeArticle;
            
        } else {
            // Traitement achat
            const produitInput = inputs[0];
            const qty = inputs[1];
            const prixAchatInput = inputs[2];
            const prixVenteInput = inputs[3];
            const dateExpirationInput = inputs[4];
            const numeroLotInput = inputs[5];
            const remiseInput = inputs[6];
            
            article.produit = produitInput.value;
            article.quantite = parseFloat(qty.value) || 0;
            article.prixAchat = parseFloat(prixAchatInput.value) || 0;
            article.prixVente = parseFloat(prixVenteInput.value) || 0;
            article.datePeremption = dateExpirationInput.value;
            article.numeroLot = numeroLotInput.value;
            article.remise = parseFloat(remiseInput.value) || 0;
            
            // Calculer marge et coûts
            const margeUnitaire = article.prixVente - article.prixAchat;
            let coutTotal = article.quantite * article.prixAchat;
            coutTotal = coutTotal - (coutTotal * article.remise / 100);
            const beneficePotentiel = article.quantite * margeUnitaire;
            
            article.sousTotal = coutTotal;
            article.margeUnitaire = margeUnitaire;
            article.beneficePotentiel = beneficePotentiel;
            
            // Affichage
            const margeDisplay = row.querySelector('.marge-display');
            const beneficePotentielSpan = row.querySelector('.benefice-potentiel');
            const subtotalSpan = row.querySelector('.article-subtotal');
            
            if (margeDisplay) {
                margeDisplay.value = `${margeUnitaire.toFixed(2)} DHS (${article.prixAchat > 0 ? ((margeUnitaire / article.prixAchat) * 100).toFixed(1) : '0'}%)`;
                margeDisplay.style.color = margeUnitaire > 0 ? 'var(--success-color)' : 'var(--danger-color)';
            }
            if (beneficePotentielSpan) {
                beneficePotentielSpan.textContent = `${beneficePotentiel.toFixed(2)} DHS`;
            }
            if (subtotalSpan) {
                subtotalSpan.textContent = `${coutTotal.toFixed(2)} DHS`;
            }
            
            totalGeneral += coutTotal;
            beneficeTotal += beneficePotentiel;
        }
        
        if (article.produit && article.quantite > 0) {
            articles.push(article);
        }
    });
    
    hiddenInput.value = JSON.stringify(articles);
    updateTotalGeneral(totalGeneral, beneficeTotal);
}

function updateTotalGeneral(total, benefice) {
    let totalContainer = document.getElementById('total-general');
    if (!totalContainer) {
        totalContainer = document.createElement('div');
        totalContainer.id = 'total-general';
        totalContainer.innerHTML = `
            <div style="background: var(--primary-light); padding: 16px; border-radius: 8px; margin-top: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="font-size: 1.1rem; color: var(--primary-color);">
                            Total: <span id="total-amount">0.00 DHS</span>
                        </strong>
                    </div>
                    <div>
                        <strong style="font-size: 1.1rem; color: var(--success-color);">
                            Bénéfice: <span id="benefice-amount">0.00 DHS</span>
                        </strong>
                    </div>
                </div>
            </div>
        `;
        document.querySelector('.articles-container')?.appendChild(totalContainer);
    }
    
    const amountSpan = document.getElementById('total-amount');
    const beneficeSpan = document.getElementById('benefice-amount');
    
    if (amountSpan) {
        amountSpan.textContent = total.toLocaleString('fr-FR', {minimumFractionDigits: 2}) + ' DHS';
    }
    if (beneficeSpan) {
        beneficeSpan.textContent = benefice.toLocaleString('fr-FR', {minimumFractionDigits: 2}) + ' DHS';
        beneficeSpan.style.color = benefice > 0 ? 'var(--success-color)' : 'var(--danger-color)';
    }
}

/* ===================== INTERFACE ET NAVIGATION ===================== */

function updateInterface() {
    if (!currentData) return;
    updateNavBadges();
    updateDashboard();
    updateAllSections();
    hybridStorage.updateStorageStatus();
}

function updateNavBadges() {
    const badges = {
        stock: document.getElementById('stockBadge'),
        ventes: document.getElementById('ventesBadge'),
        achats: document.getElementById('achatsBadge'),
        paiements: document.getElementById('paiementsBadge')
    };
    
    if (!currentData || !currentData.data) {
        Object.values(badges).forEach(b => { if (b) b.textContent = '0'; });
        return;
    }
    
    Object.entries(badges).forEach(([key, badge]) => {
        if (badge) {
            const arr = Array.isArray(currentData.data[key]) ? currentData.data[key] : [];
            badge.textContent = arr.length;
        }
    });
}

function updateDashboard() {
    const emptyState = document.getElementById('dashboardEmpty');
    const content = document.getElementById('dashboardContent');
    
    if (!currentData || !currentData.data) { 
        if (emptyState) emptyState.style.display='block'; 
        if (content) content.style.display='none'; 
        return; 
    }
    
    if (emptyState) emptyState.style.display='none'; 
    if (content) content.style.display='block';
    
    const metrics = calculateMetrics();
    updateDashboardMetrics(metrics);
    updateStockAlerts();
    updateExpirationAlerts();
}

function calculateMetrics() {
    const data = currentData.data;
    let totalStock = 0, stockFaible = 0, ventesToday = 0, ventesAmount = 0, achatsAmount = 0, beneficeToday = 0, produitsExpirant = 0;

    if (data.stock) {
        totalStock = data.stock.length;
        stockFaible = data.stock.filter(item => (parseInt(item.quantite)||0) <= (parseInt(item.seuil)||5)).length;
        
        // Compter produits expirant dans 30 jours
        const warningDate = new Date(Date.now() + 30*24*60*60*1000);
        produitsExpirant = data.stock.filter(item => {
            if (!item.datePeremption) return false;
            const expDate = new Date(item.datePeremption);
            return expDate <= warningDate;
        }).length;
    }

    const today = new Date().toISOString().split('T')[0];
    if (data.ventes) {
        const ventesTodayList = data.ventes.filter(v => {
            const dateStr = v.date || v.createdAt || '';
            return dateStr.startsWith(today);
        });
        ventesToday = ventesTodayList.length;
        ventesAmount = ventesTodayList.reduce((s,v)=> s + montantVente(v), 0);
        
        // Calcul bénéfice du jour
        beneficeToday = ventesTodayList.reduce((total, vente) => {
            if (Array.isArray(vente.articles)) {
                vente.articles.forEach(article => {
                    const stockItem = data.stock?.find(s => s.nom === article.produit);
                    if (stockItem) {
                        const prixAchat = parseFloat(stockItem.prixAchat) || 0;
                        const prixVente = parseFloat(article.prixUnitaire) || 0;
                        const quantite = parseFloat(article.quantite) || 0;
                        total += (prixVente - prixAchat) * quantite;
                    }
                });
            }
            return total;
        }, 0);
    }

    const thisMonth = new Date().toISOString().substring(0,7);
    if (data.achats) {
        const achatsThisMonth = data.achats.filter(a => {
            const dateStr = a.date || a.createdAt || '';
            return dateStr.startsWith(thisMonth);
        });
        achatsAmount = achatsThisMonth.reduce((s,a)=> s + montantAchat(a), 0);
    }

    return { totalStock, stockFaible, ventesToday, ventesAmount, achatsAmount, beneficeToday, produitsExpirant };
}

function updateDashboardMetrics(m) {
    const container = document.getElementById('dashboardMetrics');
    if (!container) return;
    
    container.innerHTML = `
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Stock Total</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);color:#1d4ed8;">
                    <i class="fas fa-boxes"></i>
                </div>
            </div>
            <div class="metric-value">${m.totalStock.toLocaleString()}</div>
            <div class="metric-subtitle">Produits en inventaire</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Alertes Stock</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);color:#dc2626;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="metric-value">${m.stockFaible}</div>
            <div class="metric-subtitle">Produits en rupture</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Ventes Aujourd'hui</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);color:#166534;">
                    <i class="fas fa-cash-register"></i>
                </div>
            </div>
            <div class="metric-value">${m.ventesToday}</div>
            <div class="metric-subtitle">${m.ventesAmount.toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Bénéfice Aujourd'hui</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);color:#166534;">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
            <div class="metric-value">${m.beneficeToday.toLocaleString('fr-FR', {minimumFractionDigits: 0})}</div>
            <div class="metric-subtitle">DHS de profit</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Expiration Proche</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);color:#92400e;">
                    <i class="fas fa-calendar-times"></i>
                </div>
            </div>
            <div class="metric-value">${m.produitsExpirant}</div>
            <div class="metric-subtitle">Produits < 30 jours</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Achats ce Mois</div>
                <div class="metric-icon" style="background:linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);color:#3730a3;">
                    <i class="fas fa-truck"></i>
                </div>
            </div>
            <div class="metric-value">${m.achatsAmount.toLocaleString('fr-FR', {minimumFractionDigits: 0})}</div>
            <div class="metric-subtitle">DHS investis</div>
        </div>
    `;
}

function updateStockAlerts() {
    const container = document.getElementById('stockAlerts');
    if (!container) return;
    
    if (!currentData || !currentData.data.stock) { 
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Aucun produit en stock</p>'; 
        return; 
    }
    
    const lowStockItems = currentData.data.stock.filter(item => 
        (parseInt(item.quantite)||0) <= (parseInt(item.seuil)||5)
    );
    
    if (lowStockItems.length === 0) { 
        container.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success-color); margin-bottom: 12px;"></i>
                <p style="color: var(--text-muted);">Aucune alerte de stock - Tout va bien!</p>
            </div>
        `; 
        return; 
    }
    
    container.innerHTML = lowStockItems.slice(0,5).map(item => {
        const marge = (parseFloat(item.prixVente) || 0) - (parseFloat(item.prixAchat) || 0);
        return `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--border-color);">
                <div>
                    <div style="font-weight:600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-pills" style="color: var(--primary-color);"></i>
                        ${item.nom}
                    </div>
                    <div style="font-size:.8rem;color:var(--text-secondary); margin-top: 4px;">
                        Stock: <span style="color: var(--danger-color); font-weight: 600;">${item.quantite}</span> | 
                        Seuil: ${item.seuil || 5} | 
                        Marge: <span style="color: ${marge > 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${marge.toFixed(2)} DHS</span>
                    </div>
                </div>
                <div class="status-badge" style="background:#fee2e2;color:#991b1b;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Critique
                </div>
            </div>
        `;
    }).join('');
}

function updateExpirationAlerts() {
    // Créer section d'alertes d'expiration après les alertes de stock
    const stockAlertsCard = document.querySelector('#stockAlerts').closest('.card');
    
    let expirationCard = document.getElementById('expirationAlertsCard');
    if (!expirationCard) {
        expirationCard = document.createElement('div');
        expirationCard.id = 'expirationAlertsCard';
        expirationCard.className = 'card';
        expirationCard.style.marginTop = '24px';
        expirationCard.innerHTML = `
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-calendar-times" style="color: var(--warning-color);"></i>
                    Alertes d'Expiration
                </div>
            </div>
            <div class="card-content" id="expirationAlerts"></div>
        `;
        stockAlertsCard.parentNode.insertBefore(expirationCard, stockAlertsCard.nextSibling);
    }
    
    const container = document.getElementById('expirationAlerts');
    if (!container) return;
    
    if (!currentData || !currentData.data.stock) { 
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Aucun produit en stock</p>'; 
        return; 
    }
    
    const today = new Date();
    const warningDate = new Date(today.getTime() + 30*24*60*60*1000); // 30 jours
    
    const expiringItems = currentData.data.stock.filter(item => {
        if (!item.datePeremption) return false;
        const expDate = new Date(item.datePeremption);
        return expDate <= warningDate;
    }).sort((a, b) => new Date(a.datePeremption) - new Date(b.datePeremption));
    
    if (expiringItems.length === 0) { 
        container.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success-color); margin-bottom: 12px;"></i>
                <p style="color: var(--text-muted);">Aucun produit en expiration proche!</p>
            </div>
        `; 
        return; 
    }
    
    container.innerHTML = expiringItems.slice(0,5).map(item => {
        const expDate = new Date(item.datePeremption);
        const isExpired = expDate <= today;
        const daysLeft = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
        const urgencyClass = isExpired ? 'danger' : daysLeft <= 7 ? 'danger' : daysLeft <= 30 ? 'warning' : 'success';
        const urgencyText = isExpired ? 'Expiré' : daysLeft <= 7 ? 'Urgent' : 'Attention';
        
        return `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--border-color);">
                <div>
                    <div style="font-weight:600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-pills" style="color: var(--primary-color);"></i>
                        ${item.nom}
                    </div>
                    <div style="font-size:.8rem;color:var(--text-secondary); margin-top: 4px;">
                        Expiration: <span style="color: var(--${urgencyClass}-color); font-weight: 600;">
                            ${expDate.toLocaleDateString('fr-FR')}
                        </span> | 
                        Stock: ${item.quantite} | 
                        ${isExpired ? 'EXPIRÉ' : `${daysLeft} jour${daysLeft > 1 ? 's' : ''} restant${daysLeft > 1 ? 's' : ''}`}
                    </div>
                </div>
                <div class="status-badge" style="background:var(--${urgencyClass === 'danger' ? 'danger' : 'warning'}-color);color:white;">
                    <i class="fas fa-calendar-times"></i>
                    ${urgencyText}
                </div>
            </div>
        `;
    }).join('');
}

function updatePageHeader(sectionName) {
    const titles = {
        dashboard: { title: 'Tableau de bord', subtitle: 'Vue d\'ensemble de votre pharmacie', icon: 'fas fa-chart-line' },
        stock: { title: 'Gestion de l\'Inventaire', subtitle: 'Produits et niveaux de stock', icon: 'fas fa-boxes' },
        ventes: { title: 'Point de Vente', subtitle: 'Transactions et caisse', icon: 'fas fa-cash-register' },
        achats: { title: 'Commandes Fournisseurs', subtitle: 'Approvisionnement et réceptions', icon: 'fas fa-truck' },
        paiements: { title: 'Gestion des Paiements', subtitle: 'Historique financier', icon: 'fas fa-credit-card' }
    };
    
    const config = titles[sectionName] || { title: sectionName, subtitle: '', icon: 'fas fa-file' };
    
    const titleElement = document.getElementById('pageTitle');
    const subtitleElement = document.getElementById('pageSubtitle');
    
    if (titleElement) titleElement.innerHTML = `<i class="${config.icon}"></i> ${config.title}`;
    if (subtitleElement) subtitleElement.textContent = config.subtitle;

    const actionsContainer = document.getElementById('headerActions');
    if (actionsContainer) {
        if (sectionName !== 'dashboard') {
            actionsContainer.innerHTML = `
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Rechercher..." onkeyup="filterTable(this.value)">
                    <div class="search-icon"><i class="fas fa-search"></i></div>
                </div>
                <button class="btn btn-primary" onclick="openAddModal('${sectionName}')">
                    <i class="fas fa-plus"></i>
                    Ajouter
                </button>
            `;
        } else {
            actionsContainer.innerHTML = `
                <button class="btn btn-success" onclick="openExportOptions()">
                    <i class="fas fa-download"></i>
                    Exporter
                </button>
            `;
        }
    }
}

function updateSectionContent(sectionName) {
    if (sectionName === 'dashboard') { 
        updateDashboard(); 
        return; 
    }
    
    const container = document.getElementById(`section-${sectionName}`);
    if (!container) return;

    if (!currentData || !currentData.data[sectionName] || currentData.data[sectionName].length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="${getSectionIcon(sectionName)}"></i>
                </div>
                <div class="empty-title">Aucun ${getSectionLabel(sectionName)}</div>
                <div class="empty-description">
                    Commencez par ajouter votre premier ${getSectionLabel(sectionName, true)}
                </div>
                <button class="btn btn-primary" onclick="openAddModal('${sectionName}')">
                    <i class="fas fa-plus"></i>
                    Ajouter ${getSectionLabel(sectionName, true)}
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = createTableView(sectionName);
}

function updateAllSections() { 
    ['stock','ventes','achats','paiements'].forEach(section => updateSectionContent(section)); 
}

/* ===================== HELPERS ===================== */

function getSectionIcon(section) {
    const icons = { 
        stock:'fas fa-boxes', 
        ventes:'fas fa-cash-register', 
        achats:'fas fa-truck', 
        paiements:'fas fa-credit-card' 
    };
    return icons[section] || 'fas fa-file';
}

function getSectionLabel(section, singular=false) {
    const labels = {
        stock: singular ? 'produit' : 'produits en stock',
        ventes: singular ? 'vente' : 'ventes',
        achats: singular ? 'commande' : 'commandes',
        paiements: singular ? 'paiement' : 'paiements'
    };
    return labels[section] || section;
}

function createTableView(sectionName) {
    const data = currentData.data[sectionName];
    const columns = getTableColumns(sectionName);
    const filteredData = searchFilter ? data.filter(item => searchInItem(item, searchFilter)) : data;

    return `
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <i class="${getSectionIcon(sectionName)}"></i>
                    ${getSectionLabel(sectionName)} (${filteredData.length})
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            ${columns.map(col => `<th><i class="fas fa-${col.icon || 'info'}"></i> ${col.label}</th>`).join('')}
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.slice(0, 100).map((item, index) => createTableRow(item, index, columns, sectionName)).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function createTableRow(item, index, columns, section) {
    let html = '<tr>';
    columns.forEach(col => {
        if (col.key === '_montant_achat') {
            html += `<td><strong>${montantAchat(item).toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong></td>`;
        } else if (col.key === '_montant_vente') {
            html += `<td><strong>${montantVente(item).toLocaleString('fr-FR', {minimumFractionDigits: 2})} DHS</strong></td>`;
        } else {
            html += `<td>${formatCellValue(item[col.key], col.key, item)}</td>`;
        }
    });
    html += `
        <td>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-sm btn-secondary" onclick="openEditModal('${section}', ${index})" title="Modifier">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${section}', ${index})" title="Supprimer">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    html += '</tr>';
    return html;
}

function searchInItem(item, query) {
    const q = query.toLowerCase();
    return Object.values(item).some(value => {
        if (typeof value === 'string') return value.toLowerCase().includes(q);
        if (typeof value === 'number') return String(value).includes(q);
        if (Array.isArray(value)) {
            return value.some(v => 
                typeof v === 'object' && v.produit && v.produit.toLowerCase().includes(q)
            );
        }
        return false;
    });
}

/* ===================== CALCULS ET PARSING ===================== */

function parseNumeric(val){
    if (typeof val === 'number') return val;
    if (typeof val !== 'string') return NaN;
    let s = val.trim().replace(/\s+/g,'').replace(/'/g,'');
    s = s.replace(/[^0-9.,-]/g,'');
    const lastComma = s.lastIndexOf(',');
    const lastDot = s.lastIndexOf('.');
    let decSep = null;
    if (lastComma > lastDot) decSep = ',';
    else if (lastDot > lastComma) decSep = '.';
    if (decSep){
        const parts = s.split(decSep);
        const intPart = parts.slice(0,-1).join(decSep).replace(/[.,]/g,'');
        const fracPart = parts[parts.length-1];
        s = intPart + '.' + fracPart;
    } else {
        s = s.replace(/[.,]/g,'');
    }
    const n = parseFloat(s);
    return Number.isNaN(n) ? NaN : n;
}

function trouverMontantBrut(val, cles = ['totalTTC','ttc','montant','total','netAPayer','montantTotal']){
    if (!val || typeof val !== 'object') return NaN;
    for (const cle of cles) {
        if (val[cle] !== undefined && val[cle] !== null){
            const n = parseNumeric(val[cle]);
            if (!Number.isNaN(n)) return n;
        }
    }
    return NaN;
}

function calculerDepuisArticles(item, type){
    if (!item || !Array.isArray(item.articles)) return NaN;
    let total = 0;
    if (type === 'achat'){
        item.articles.forEach(a => {
            const q = parseNumeric(a.quantite) || 0;
            const p = parseNumeric(a.prixAchat || a.prixUnitaire) || 0;
            const remise = parseNumeric(a.remise) || 0;
            let sousTotal = q * p;
            sousTotal = sousTotal - (sousTotal * remise / 100);
            total += sousTotal;
        });
    } else if (type === 'vente'){
        item.articles.forEach(a => {
            const q = parseNumeric(a.quantite) || 0;
            const p = parseNumeric(a.prixUnitaire) || 0;
            const remise = parseNumeric(a.remise) || 0;
            let sousTotal = q * p;
            sousTotal = sousTotal - (sousTotal * remise / 100);
            total += sousTotal;
        });
    }
    return total;
}

function montantAchat(item){
    let n = trouverMontantBrut(item);
    if (Number.isNaN(n)) n = calculerDepuisArticles(item, 'achat');
    return Number.isNaN(n) ? 0 : n;
}

function montantVente(item){
    let n = trouverMontantBrut(item);
    if (Number.isNaN(n)) n = calculerDepuisArticles(item, 'vente');
    return Number.isNaN(n) ? 0 : n;
}

/* ===================== CONFIGURATION INITIALE ===================== */

async function initializeBrowserMode() {
    try {
        showProgress('Initialisation...', 30);
        
        const stored = hybridStorage.memoryStorage.current_session;
        if (stored) {
            try {
                currentData = JSON.parse(stored);
                hybridStorage.currentData = currentData;
                originalData = JSON.parse(JSON.stringify(currentData));
                updateInterface();
                showSection('dashboard');
                showAlert('Données chargées avec succès', 'success');
            } catch (error) {
                // Données corrompues, créer nouvelles données
                await createDefaultData();
            }
        } else {
            await createDefaultData();
        }
        
        document.getElementById('setup-section').style.display = 'none';
        
        setTimeout(() => {
            hideProgress();
        }, 500);
        
    } catch (error) {
        hideProgress();
        console.error('Erreur chargement:', error);
        showAlert('Erreur de chargement: ' + error.message, 'error');
        await createDefaultData();
    }
}

async function createDefaultData() {
    currentData = {
        metadata: { 
            createdAt: new Date().toISOString(), 
            version: '1.0',
            appName: 'Pharma Gestion Pro',
            type: 'default_session'
        },
        data: { 
            stock: [], 
            ventes: [], 
            achats: [], 
            paiements: [],
            devisFactures: [],
            retours: [],
            parametres: []
        }
    };
    hybridStorage.currentData = currentData;
    originalData = JSON.parse(JSON.stringify(currentData));
    updateInterface();
    showSection('dashboard');
    showAlert('Nouvelle session créée', 'info');
}

/* ===================== ÉVÉNEMENTS ET INITIALISATION ===================== */

function setupEventListeners() {
    const importFile = document.getElementById('importFile');
    if (importFile) {
        importFile.addEventListener('change', handleFileImport);
    }
    
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    
    const checkMobile = () => {
        const mobileBtn = document.getElementById('mobileMenuBtn');
        if (mobileBtn) {
            if (window.innerWidth <= 768) {
                mobileBtn.style.display = 'flex';
            } else {
                mobileBtn.style.display = 'none';
                document.querySelector('.sidebar').classList.remove('open');
            }
        }
    };
    
    window.addEventListener('resize', checkMobile);
    checkMobile();
}

function ensureAllSections() {
    const sections = ['stock', 'ventes', 'achats', 'paiements'];
    sections.forEach(sectionName => {
        let section = document.getElementById(`section-${sectionName}`);
        if (!section) {
            section = document.createElement('div');
            section.id = `section-${sectionName}`;
            section.className = 'section';
            section.style.display = 'none';
            document.getElementById('contentArea').appendChild(section);
        }
    });
    
    // Assurer que la section dashboard existe
    let dashboardSection = document.getElementById('section-dashboard');
    if (!dashboardSection) {
        dashboardSection = document.createElement('div');
        dashboardSection.id = 'section-dashboard';
        dashboardSection.className = 'section';
        dashboardSection.style.display = 'none';
        dashboardSection.innerHTML = `
            <div id="dashboardEmpty" class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-clinic-medical"></i>
                </div>
                <div class="empty-title">Bienvenue dans Pharma Gestion Pro Hybride</div>
                <div class="empty-description">
                    Vos données sont chargées et prêtes à être utilisées
                </div>
            </div>
            <div id="dashboardContent" style="display:block;">
                <div class="dashboard-grid" id="dashboardMetrics"></div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
                            Alertes de Stock
                        </div>
                    </div>
                    <div class="card-content" id="stockAlerts"></div>
                </div>
            </div>
        `;
        document.getElementById('contentArea').appendChild(dashboardSection);
    }
}

// Initialisation principale
document.addEventListener('DOMContentLoaded', async function() {
    ensureAllSections();
    updateConnectionStatus();
    setupEventListeners();
    
    const hybridInitialized = await hybridStorage.initialize();
    
    if (hybridInitialized && hybridStorage.currentData) {
        hybridStorage.initializeMainApp();
    } else {
        // Mode navigateur standard
        await initializeBrowserMode();
    }
});

// Debug global
window.hybridStorage = hybridStorage;
console.log('Pharma Gestion Pro - Version Hybride chargée');
console.log('Mode:', 'Stockage en mémoire avec export JSON');

</script>

</body>
</html>
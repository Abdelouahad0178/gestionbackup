<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharma Gestion Pro</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background-color:var(--background-color);color:var(--text-primary);line-height:1.5}
        .app-layout{display:flex;min-height:100vh}
        /* Sidebar */
        .sidebar{width:280px;background:var(--surface-color);border-right:1px solid var(--border-color);box-shadow:var(--shadow-md);display:flex;flex-direction:column}
        .sidebar-header{padding:24px 20px;border-bottom:1px solid var(--border-color)}
        .logo{font-size:1.5rem;font-weight:700;color:var(--primary-color);margin-bottom:4px}
        .logo-subtitle{font-size:.875rem;color:var(--text-secondary)}
        .connection-status{display:flex;align-items:center;gap:8px;padding:12px 20px;background:#fef3c7;border-bottom:1px solid var(--border-color);font-size:.875rem}
        .status-dot{width:8px;height:8px;border-radius:50%;background:#f59e0b}
        .status-dot.online{background:var(--success-color)}
        .sidebar-nav{flex:1;padding:20px 0}
        .nav-section{margin-bottom:24px}
        .nav-title{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);padding:0 20px;margin-bottom:8px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 20px;color:var(--text-secondary);text-decoration:none;transition:all .2s ease;cursor:pointer;border:none;background:none;width:100%;text-align:left;font-size:.875rem}
        .nav-item:hover{background:#f1f5f9;color:var(--text-primary)}
        .nav-item.active{background:#eff6ff;color:var(--primary-color);border-right:3px solid var(--primary-color)}
        .nav-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center}
        .nav-badge{margin-left:auto;background:var(--primary-color);color:#fff;font-size:.75rem;padding:2px 8px;border-radius:12px;min-width:20px;text-align:center}
        .sidebar-footer{padding:20px;border-top:1px solid var(--border-color)}
        /* Main Content */
        .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .main-header{background:var(--surface-color);border-bottom:1px solid var(--border-color);padding:20px 32px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow-sm)}
        .header-left h1{font-size:1.5rem;font-weight:600;color:var(--text-primary);margin-bottom:4px}
        .header-subtitle{font-size:.875rem;color:var(--text-secondary)}
        .header-actions{display:flex;gap:12px}
        .content-area{flex:1;padding:32px;overflow-y:auto}
        /* Buttons */
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:8px;border:1px solid transparent;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s ease;text-decoration:none}
        .btn-primary{background:var(--primary-color);color:#fff}
        .btn-primary:hover{background:var(--primary-dark)}
        .btn-secondary{background:var(--surface-color);color:var(--text-primary);border-color:var(--border-color)}
        .btn-secondary:hover{background:#f8fafc}
        .btn-success{background:var(--success-color);color:#fff}
        .btn-success:hover{background:#047857}
        .btn-warning{background:var(--warning-color);color:#fff}
        .btn-danger{background:var(--danger-color);color:#fff}
        .btn-sm{padding:6px 12px;font-size:.75rem}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        /* Cards */
        .card{background:var(--surface-color);border:1px solid var(--border-color);border-radius:12px;box-shadow:var(--shadow-sm)}
        .card-header{padding:20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
        .card-title{font-size:1.125rem;font-weight:600;color:var(--text-primary)}
        .card-content{padding:20px}
        /* Dashboard */
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;margin-bottom:32px}
        .metric-card{background:var(--surface-color);border:1px solid var(--border-color);border-radius:12px;padding:24px;box-shadow:var(--shadow-sm)}
        .metric-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .metric-title{font-size:.875rem;color:var(--text-secondary);font-weight:500}
        .metric-icon{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.25rem}
        .metric-value{font-size:2rem;font-weight:700;color:var(--text-primary);margin-bottom:4px}
        .metric-subtitle{font-size:.75rem;color:var(--text-secondary)}
        /* Tables */
        .table-container{background:var(--surface-color);border:1px solid var(--border-color);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-sm)}
        .table-header{padding:20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px}
        .table-title{font-size:1.125rem;font-weight:600;color:var(--text-primary)}
        .table-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .search-box{position:relative;min-width:250px}
        .search-input{width:100%;padding:8px 12px 8px 36px;border:1px solid var(--border-color);border-radius:8px;font-size:.875rem;outline:none;transition:border-color .2s ease}
        .search-input:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgb(37 99 235 / 0.1)}
        .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-secondary)}
        table{width:100%;border-collapse:collapse}
        th{background:#f8fafc;padding:12px 16px;text-align:left;font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);border-bottom:1px solid var(--border-color)}
        td{padding:16px;border-bottom:1px solid var(--border-color);font-size:.875rem}
        tr:hover{background:#f8fafc}
        .status-badge{display:inline-flex;align-items:center;padding:4px 8px;border-radius:6px;font-size:.75rem;font-weight:500}
        .status-paid{background:#dcfce7;color:#166534}
        .status-unpaid{background:#fee2e2;color:#991b1b}
        .status-partial{background:#fef3c7;color:#92400e}
        .stock-low{color:var(--danger-color);font-weight:600}
        .stock-ok{color:var(--success-color)}
        /* Modals */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;backdrop-filter:blur(4px)}
        .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface-color);border-radius:16px;max-width:800px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
        .modal-header{padding:24px 24px 0;display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:1.25rem;font-weight:600;color:var(--text-primary)}
        .modal-close{width:32px;height:32px;border-radius:8px;border:none;background:#f1f5f9;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
        .modal-close:hover{background:#e2e8f0}
        .modal-body{padding:24px}
        .modal-footer{padding:0 24px 24px;display:flex;gap:12px;justify-content:flex-end}
        /* Forms */
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px}
        .form-group{display:flex;flex-direction:column}
        .form-label{font-size:.875rem;font-weight:500;color:var(--text-primary);margin-bottom:6px}
        .form-input{padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;font-size:.875rem;transition:border-color .2s ease}
        .form-input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgb(37 99 235 / 0.1)}
        .form-input:invalid{border-color:var(--danger-color)}
        /* Alerts */
        .alert{padding:16px;border-radius:8px;margin-bottom:16px;font-size:.875rem;display:flex;align-items:center;gap:12px}
        .alert-success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
        .alert-error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
        .alert-warning{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
        .alert-info{background:#dbeafe;color:#1e40af;border:1px solid #bfdbfe}
        /* Empty State */
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary)}
        .empty-icon{width:64px;height:64px;background:#f1f5f9;border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:1.5rem}
        .empty-title{font-size:1.125rem;font-weight:600;color:var(--text-primary);margin-bottom:8px}
        .empty-description{font-size:.875rem;margin-bottom:24px}
        /* Article Forms */
        .article-section{margin-top:24px;padding-top:24px;border-top:1px solid var(--border-color)}
        .article-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .article-item{background:#f8fafc;border:1px solid var(--border-color);border-radius:8px;padding:20px;margin-bottom:16px}
        .article-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .total-display{background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:16px;margin-top:20px;text-align:center}
        .total-amount{font-size:1.5rem;font-weight:700;color:var(--primary-color)}
        /* File Input */
        .file-input-wrapper{position:relative;display:inline-block}
        .file-input{display:none}
        /* Responsive */
        @media (max-width:768px){
            .sidebar{position:fixed;top:0;left:-280px;height:100%;z-index:100;transition:left .3s ease}
            .sidebar.open{left:0}
            .main-content{width:100%}
            .content-area{padding:20px}
            .dashboard-grid{grid-template-columns:1fr}
            .form-grid{grid-template-columns:1fr}
            .table-header{flex-direction:column;align-items:stretch}
            .table-actions{flex-direction:column}
        }
        /* Loading State */
        .loading{display:flex;align-items:center;justify-content:center;padding:40px}
        .spinner{width:24px;height:24px;border:2px solid var(--border-color);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        /* Icons */
        .icon{width:16px;height:16px;display:inline-block}
        .file-drop-zone{border:2px dashed var(--border-color);border-radius:12px;padding:40px;text-align:center;color:var(--text-secondary);margin-bottom:24px;transition:all .3s ease;cursor:pointer}
        .file-drop-zone:hover,.file-drop-zone.dragover{border-color:var(--primary-color);background:#f0f9ff}
        .progress{width:100%;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;margin:16px 0}
        .progress-bar{height:100%;background:var(--primary-color);transition:width .3s ease}
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Pharma Gestion</div>
                <div class="logo-subtitle">Mode Hors Ligne</div>
            </div>
            
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Hors ligne</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-title">Navigation</div>
                    <button class="nav-item active" onclick="showSection('dashboard', event)">
                        <div class="nav-icon">📊</div>
                        Tableau de bord
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Gestion</div>
                    <button class="nav-item" onclick="showSection('stock', event)">
                        <div class="nav-icon">📦</div>
                        Stock
                        <div class="nav-badge" id="stockBadge">0</div>
                    </button>
                    <button class="nav-item" onclick="showSection('ventes', event)">
                        <div class="nav-icon">💰</div>
                        Ventes
                        <div class="nav-badge" id="ventesBadge">0</div>
                    </button>
                    <button class="nav-item" onclick="showSection('achats', event)">
                        <div class="nav-icon">🛒</div>
                        Achats
                        <div class="nav-badge" id="achatsBadge">0</div>
                    </button>
                    <button class="nav-item" onclick="showSection('paiements', event)">
                        <div class="nav-icon">💳</div>
                        Paiements
                        <div class="nav-badge" id="paiementsBadge">0</div>
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Données</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="importFile" class="file-input" accept=".json">
                        <button class="nav-item" onclick="document.getElementById('importFile').click()">
                            <div class="nav-icon">📤</div>
                            Importer
                        </button>
                    </div>
                    <button class="nav-item" id="exportBtn" onclick="exportData()" disabled>
                        <div class="nav-icon">📥</div>
                        Exporter
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="btn btn-danger btn-sm" onclick="clearAllData()">
                    Effacer tout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <div class="header-left">
                    <h1 id="pageTitle">Tableau de bord</h1>
                    <div class="header-subtitle" id="pageSubtitle">Vue d'ensemble de votre pharmacie</div>
                </div>
                <div class="header-actions" id="headerActions"></div>
            </div>

            <div class="content-area" id="contentArea">
                <!-- Dashboard par défaut -->
                <div id="section-dashboard" class="section active">
                    <div id="dashboardEmpty" class="empty-state">
                        <div class="empty-icon">📋</div>
                        <div class="empty-title">Aucune donnée chargée</div>
                        <div class="empty-description">
                            Importez vos données JSON pour commencer à utiliser l'application
                        </div>
                        <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                            Importer des données
                        </button>
                    </div>
                    <div id="dashboardContent" style="display: none;">
                        <div class="dashboard-grid" id="dashboardMetrics"></div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Alertes Stock</div>
                            </div>
                            <div class="card-content" id="stockAlerts"></div>
                        </div>
                    </div>
                </div>

                <!-- Sections pour chaque collection -->
                <div id="section-stock" class="section" style="display: none;"></div>
                <div id="section-ventes" class="section" style="display: none;"></div>
                <div id="section-achats" class="section" style="display: none;"></div>
                <div id="section-paiements" class="section" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Alerts Container -->
    <div id="alertsContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1100; max-width: 400px;"></div>

    <!-- Modal pour édition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="editModalTitle">Ajouter</div>
                <button class="modal-close" onclick="closeEditModal()">×</button>
            </div>
            <div class="modal-body" id="editModalBody"></div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Confirmation</div>
                <button class="modal-close" onclick="closeConfirmModal()">×</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Annuler</button>
                <button class="btn btn-danger" id="confirmButton">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal de progression -->
    <div id="progressModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-body">
                <div style="text-align: center;">
                    <div class="spinner" style="margin: 0 auto 16px;"></div>
                    <div id="progressText">Traitement en cours...</div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
/* ===================== Variables globales ===================== */
let currentData = null;
let originalData = null;
let currentSection = 'dashboard';
let editingItem = null;
let editingIndex = null;
let searchFilter = '';

/* ===================== Initialisation ===================== */
document.addEventListener('DOMContentLoaded', function() {
    updateConnectionStatus();
    loadStoredData();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('importFile').addEventListener('change', handleFileImport);
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            if (event.target.id !== 'progressModal') {
                event.target.style.display = 'none';
            }
        }
    });
    const dropZone = document.body;
    dropZone.addEventListener('dragover', function(e) { e.preventDefault(); e.stopPropagation(); });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault(); e.stopPropagation();
        const files = e.dataTransfer.files;
        if (files.length > 0 && (files[0].type === 'application/json' || files[0].name.endsWith('.json'))) {
            handleFileImport({ target: { files: files } });
        }
    });
}

/* ===================== Statut connexion ===================== */
function updateConnectionStatus() {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    if (navigator.onLine) { dot.classList.add('online'); text.textContent = 'En ligne'; }
    else { dot.classList.remove('online'); text.textContent = 'Hors ligne'; }
}

/* ===================== Import fichier ===================== */
async function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    showProgress('Lecture du fichier...', 10);
    try {
        const text = await file.text();
        showProgress('Analyse des données...', 30);
        const data = JSON.parse(text);
        showProgress('Validation...', 50);
        if (!data || typeof data !== 'object') throw new Error('Fichier JSON invalide');

        initializeDataStructure(data);
        showProgress('Sauvegarde...', 70);
        saveToLocal(data);

        showProgress('Mise à jour interface...', 90);
        currentData = data;
        originalData = JSON.parse(JSON.stringify(data));
        updateInterface();
        showSection('dashboard');

        showProgress('Terminé!', 100);
        setTimeout(() => { hideProgress(); showAlert('Données importées avec succès!', 'success'); }, 500);
    } catch (error) {
        hideProgress();
        showAlert('Erreur: ' + error.message, 'error');
    }
}

/* ===================== Init structure ===================== */
function initializeDataStructure(data) {
    if (!data.metadata) data.metadata = {};
    if (!data.data) data.data = {};
    const collections = ['achats', 'ventes', 'stock', 'paiements'];
    collections.forEach(col => { if (!data.data[col]) data.data[col] = []; });
}

/* ===================== LocalStorage helpers ===================== */
function saveToLocal(data) {
    localStorage.setItem('pharmaData', JSON.stringify(data));
    localStorage.setItem('pharmaDataOriginal', JSON.stringify(data));
    localStorage.setItem('lastImport', new Date().toISOString());
}

function loadStoredData() {
    const stored = localStorage.getItem('pharmaData');
    if (stored) {
        try {
            currentData = JSON.parse(stored);
            originalData = JSON.parse(localStorage.getItem('pharmaDataOriginal') || stored);
            updateInterface();
        } catch (error) {
            showAlert('Erreur de chargement des données locales', 'error');
        }
    } else {
        updateNavBadges();
    }
}

/* ===================== Parsing & Montants robustes ===================== */
/** Parse toutes les notations (1 234,56 / 1,234.56 / "1 234,56") en Number */
function parseNumeric(val){
    if (typeof val === 'number') return val;
    if (typeof val !== 'string') return NaN;
    let s = val.trim().replace(/\s+/g,'').replace(/'/g,''); // supprime espaces et '
    // garder seulement chiffres, ., , et -
    s = s.replace(/[^0-9.,-]/g,'');
    const lastComma = s.lastIndexOf(',');
    const lastDot = s.lastIndexOf('.');
    let decSep = null;
    if (lastComma > lastDot) decSep = ',';
    else if (lastDot > lastComma) decSep = '.';
    if (decSep){
        const parts = s.split(decSep);
        const intPart = parts.slice(0,-1).join(decSep).replace(/[.,]/g,''); // suppr. séparateurs milliers
        const fracPart = parts[parts.length-1];
        s = intPart + '.' + fracPart;
    } else {
        // pas de décimales -> suppr. séparateurs
        s = s.replace(/[.,]/g,'');
    }
    const n = parseFloat(s);
    return Number.isNaN(n) ? NaN : n;
}

/** Cherche un montant par clés connues (y compris imbriquées à faible profondeur) */
function trouverMontantBrut(obj, cles = ['totalTTC','ttc','montant','total','netAPayer','amount','paid','due']){
    if (!obj || typeof obj !== 'object') return NaN;

    // 1) direct
    for (const cle of cles) {
        if (obj[cle] !== undefined && obj[cle] !== null){
            const n = parseNumeric(obj[cle]);
            if (!Number.isNaN(n)) return n;
        }
    }

    // 2) conventions courantes: totals/amount/payment nested
    const nests = ['totals','total','amount','payment','paiement','resume','summary'];
    for (const key of nests){
        if (obj[key] && typeof obj[key] === 'object'){
            const n = trouverMontantBrut(obj[key], cles);
            if (!Number.isNaN(n)) return n;
        }
    }

    // 3) scan peu profond
    for (const k in obj){
        const v = obj[k];
        if (v && typeof v === 'object'){
            // éviter boucle articles ici, calculé séparément
            if (k.toLowerCase() === 'articles') continue;
            const n = trouverMontantBrut(v, cles);
            if (!Number.isNaN(n)) return n;
        }
    }
    return NaN;
}

/** Calcule montant à partir des articles (fallback) */
function calculerDepuisArticles(item, type){
    if (!item || !Array.isArray(item.articles)) return NaN;
    let total = 0;
    if (type === 'achat'){
        item.articles.forEach(a => {
            const q = parseNumeric(a.quantite) || 0;
            const p = parseNumeric(a.prixAchat) || 0;
            total += q * p;
        });
        const remise = parseNumeric(item.remiseGlobale) || 0;
        total = total - total * (remise/100);
    } else if (type === 'vente'){
        item.articles.forEach(a => {
            const q = parseNumeric(a.quantite) || 0;
            const p = parseNumeric(a.prixUnitaire) || 0;
            const st = q * p;
            const r = parseNumeric(a.remise) || 0;
            total += st - (st * r / 100);
        });
    }
    return total;
}

/** Montant d'un achat (TTC/Net), robuste */
function montantAchat(item){
    let n = trouverMontantBrut(item, ['totalTTC','ttc','montant','total','netAPayer','amount']);
    if (Number.isNaN(n)) n = calculerDepuisArticles(item, 'achat');
    return Number.isNaN(n) ? 0 : n;
}

/** Montant d'une vente, robuste */
function montantVente(item){
    let n = trouverMontantBrut(item, ['totalTTC','ttc','netAPayer','montant','total','amount']);
    if (Number.isNaN(n)) n = calculerDepuisArticles(item, 'vente');
    return Number.isNaN(n) ? 0 : n;
}

/* ===================== Interface ===================== */
function updateInterface() {
    if (!currentData) return;
    updateNavBadges();
    updateDashboard();
    updateAllSections();
    document.getElementById('exportBtn').disabled = false;
}

/* SAFE: met les badges à 0 si currentData/data est null */
function updateNavBadges() {
    const badges = {
        stock: document.getElementById('stockBadge'),
        ventes: document.getElementById('ventesBadge'),
        achats: document.getElementById('achatsBadge'),
        paiements: document.getElementById('paiementsBadge')
    };
    if (!currentData || !currentData.data) {
        Object.values(badges).forEach(b => { if (b) b.textContent = '0'; });
        return;
    }
    Object.entries(badges).forEach(([key, badge]) => {
        if (badge) {
            const arr = Array.isArray(currentData.data[key]) ? currentData.data[key] : [];
            badge.textContent = arr.length;
        }
    });
}

function updateDashboard() {
    const emptyState = document.getElementById('dashboardEmpty');
    const content = document.getElementById('dashboardContent');
    if (!currentData || !currentData.data) { emptyState.style.display='block'; content.style.display='none'; return; }
    emptyState.style.display='none'; content.style.display='block';
    const metrics = calculateMetrics();
    updateDashboardMetrics(metrics);
    updateStockAlerts();
}

function calculateMetrics() {
    const data = currentData.data;
    let totalStock = 0, stockFaible = 0, ventesToday = 0, ventesAmount = 0, achatsAmount = 0;

    if (data.stock) {
        totalStock = data.stock.length;
        stockFaible = data.stock.filter(item => (parseInt(item.quantite)||0) <= (parseInt(item.seuil)||5)).length;
    }

    const today = new Date().toISOString().split('T')[0];
    if (data.ventes) {
        const ventesTodayList = data.ventes.filter(v => (v.date && v.date.startsWith(today)) || (v.createdAt && v.createdAt.startsWith(today)));
        ventesToday = ventesTodayList.length;
        ventesAmount = ventesTodayList.reduce((s,v)=> s + montantVente(v), 0);
    }

    const thisMonth = new Date().toISOString().substring(0,7);
    if (data.achats) {
        const achatsThisMonth = data.achats.filter(a => (a.date && a.date.startsWith(thisMonth)) || (a.createdAt && a.createdAt.startsWith(thisMonth)));
        achatsAmount = achatsThisMonth.reduce((s,a)=> s + montantAchat(a), 0);
    }

    return {
        totalStock, stockFaible, ventesToday, ventesAmount, achatsAmount,
        totalDocuments: Object.values(data).reduce((sum, arr) => sum + (Array.isArray(arr)?arr.length:0), 0)
    };
}

function updateDashboardMetrics(m) {
    const container = document.getElementById('dashboardMetrics');
    container.innerHTML = `
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Produits en Stock</div>
                <div class="metric-icon" style="background:#dbeafe;color:#1d4ed8;">📦</div>
            </div>
            <div class="metric-value">${m.totalStock}</div>
            <div class="metric-subtitle">Articles différents</div>
        </div>
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Alertes Stock</div>
                <div class="metric-icon" style="background:#fee2e2;color:#dc2626;">⚠️</div>
            </div>
            <div class="metric-value">${m.stockFaible}</div>
            <div class="metric-subtitle">Produits en rupture</div>
        </div>
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Ventes Aujourd'hui</div>
                <div class="metric-icon" style="background:#dcfce7;color:#166534;">💰</div>
            </div>
            <div class="metric-value">${m.ventesToday}</div>
            <div class="metric-subtitle">${m.ventesAmount.toFixed(2)} DHS</div>
        </div>
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Achats ce Mois</div>
                <div class="metric-icon" style="background:#fef3c7;color:#92400e;">🛒</div>
            </div>
            <div class="metric-value">${m.achatsAmount.toFixed(2)}</div>
            <div class="metric-subtitle">DHS dépensés</div>
        </div>
    `;
}

function updateStockAlerts() {
    const container = document.getElementById('stockAlerts');
    if (!currentData || !currentData.data.stock) { container.innerHTML = '<p class="empty-description">Aucun produit en stock</p>'; return; }
    const lowStockItems = currentData.data.stock.filter(item => (parseInt(item.quantite)||0) <= (parseInt(item.seuil)||5));
    if (lowStockItems.length === 0) { container.innerHTML = '<p class="empty-description">Aucune alerte de stock</p>'; return; }
    container.innerHTML = lowStockItems.slice(0,5).map(item => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-color);">
            <div>
                <div style="font-weight:500;">${item.nom}</div>
                <div style="font-size:.75rem;color:var(--text-secondary);">Stock: ${item.quantite} (Seuil: ${item.seuil || 5})</div>
            </div>
            <div class="status-badge" style="background:#fee2e2;color:#991b1b;">Stock faible</div>
        </div>
    `).join('') + (lowStockItems.length>5 ? `<p style="text-align:center;margin-top:16px;color:var(--text-secondary);">... et ${lowStockItems.length - 5} autres</p>` : '');
}

/* ===================== Navigation ===================== */
function showSection(sectionName, evt) {
    currentSection = sectionName;
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (evt && (evt.currentTarget || evt.target)) {
        (evt.currentTarget || evt.target).classList.add('active');
    } else {
        const guessBtn = Array.from(document.querySelectorAll('.nav-item'))
            .find(b => (b.getAttribute('onclick') || '').includes(`'${sectionName}'`));
        if (guessBtn) guessBtn.classList.add('active');
    }
    document.querySelectorAll('.section').forEach(section => { section.style.display = 'none'; });
    const targetSection = document.getElementById(`section-${sectionName}`);
    if (targetSection) {
        targetSection.style.display = 'block';
        updateSectionContent(sectionName);
    }
    updatePageHeader(sectionName);
}

function updatePageHeader(sectionName) {
    const titles = {
        dashboard: { title: 'Tableau de bord', subtitle: 'Vue d\'ensemble de votre pharmacie' },
        stock: { title: 'Gestion du Stock', subtitle: 'Produits et inventaire' },
        ventes: { title: 'Ventes', subtitle: 'Transactions de vente' },
        achats: { title: 'Achats', subtitle: 'Commandes fournisseurs' },
        paiements: { title: 'Paiements', subtitle: 'Historique des paiements' }
    };
    const config = titles[sectionName] || { title: sectionName, subtitle: '' };
    document.getElementById('pageTitle').textContent = config.title;
    document.getElementById('pageSubtitle').textContent = config.subtitle;

    const actionsContainer = document.getElementById('headerActions');
    if (sectionName !== 'dashboard') {
        actionsContainer.innerHTML = `
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Rechercher..." onkeyup="filterTable(this.value)">
                <div class="search-icon">🔍</div>
            </div>
            <button class="btn btn-primary" onclick="openAddModal('${sectionName}')">Ajouter</button>
        `;
    } else {
        actionsContainer.innerHTML = '';
    }
}

function updateSectionContent(sectionName) {
    if (sectionName === 'dashboard') { updateDashboard(); return; }
    const container = document.getElementById(`section-${sectionName}`);
    if (!container) return;

    if (!currentData || !currentData.data[sectionName] || currentData.data[sectionName].length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">${getSectionIcon(sectionName)}</div>
                <div class="empty-title">Aucun ${getSectionLabel(sectionName)}</div>
                <div class="empty-description">Commencez par ajouter votre premier ${getSectionLabel(sectionName, true)}</div>
                <button class="btn btn-primary" onclick="openAddModal('${sectionName}')">
                    Ajouter ${getSectionLabel(sectionName, true)}
                </button>
            </div>
        `;
        return;
    }
    container.innerHTML = createTableView(sectionName);
}

/* ===================== Helpers sections & tables ===================== */
function getSectionIcon(section) {
    const icons = { stock:'📦', ventes:'💰', achats:'🛒', paiements:'💳' };
    return icons[section] || '📄';
}
function getSectionLabel(section, singular=false) {
    const labels = {
        stock: singular ? 'produit' : 'produits en stock',
        ventes: singular ? 'vente' : 'ventes',
        achats: singular ? 'achat' : 'achats',
        paiements: singular ? 'paiement' : 'paiements'
    };
    return labels[section] || section;
}

function createTableView(sectionName) {
    const data = currentData.data[sectionName];
    const columns = getTableColumns(sectionName);
    const filteredData = searchFilter ? data.filter(item => searchInItem(item, searchFilter)) : data;

    return `
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">${getSectionLabel(sectionName)} (${filteredData.length})</div>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            ${columns.map(col => `<th>${col.label}</th>`).join('')}
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.slice(0, 50).map((item, index) => createTableRow(item, index, columns, sectionName)).join('')}
                    </tbody>
                </table>
            </div>
            ${filteredData.length>50 ? `<div style="padding:16px;text-align:center;color:var(--text-secondary);font-size:.875rem;">Affichage des 50 premiers éléments sur ${filteredData.length}</div>` : ''}
        </div>
    `;
}

function getTableColumns(section) {
    const columns = {
        stock: [
            { key:'nom', label:'Produit' },
            { key:'quantite', label:'Stock' },
            { key:'prixVente', label:'Prix Vente' },
            { key:'datePeremption', label:'Péremption' },
            { key:'dernierFournisseur', label:'Fournisseur' }
        ],
        ventes: [
            { key:'date', label:'Date' },
            { key:'client', label:'Client' },
            { key:'_montant_vente', label:'Montant' },
            { key:'modePaiement', label:'Paiement' },
            { key:'statutPaiement', label:'Statut' }
        ],
        achats: [
            { key:'date', label:'Date' },
            { key:'fournisseur', label:'Fournisseur' },
            { key:'_montant_achat', label:'Montant' },
            { key:'statutPaiement', label:'Statut' },
            { key:'articles', label:'Articles' }
        ],
        paiements: [
            { key:'date', label:'Date' },
            { key:'montant', label:'Montant' },
            { key:'mode', label:'Mode' },
            { key:'type', label:'Type' },
            { key:'docId', label:'Document' }
        ]
    };
    return columns[section] || [];
}

function createTableRow(item, index, columns, section) {
    let html = '<tr>';
    columns.forEach(col => {
        if (col.key === '_montant_achat') {
            html += `<td>${montantAchat(item).toFixed(2)} DHS</td>`;
        } else if (col.key === '_montant_vente') {
            html += `<td>${montantVente(item).toFixed(2)} DHS</td>`;
        } else {
            html += `<td>${formatCellValue(item[col.key], col.key, item)}</td>`;
        }
    });
    html += `
        <td>
            <div style="display:flex;gap:4px;">
                <button class="btn btn-sm btn-secondary" onclick="openEditModal('${section}', ${index})">Modifier</button>
                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${section}', ${index})">Supprimer</button>
            </div>
        </td>
    `;
    html += '</tr>';
    return html;
}

function formatCellValue(value, key, item) {
    if (key === '_montant_achat') return `${montantAchat(item).toFixed(2)} DHS`;
    if (key === '_montant_vente') return `${montantVente(item).toFixed(2)} DHS`;

    if (value === null || value === undefined) {
        if (['totalTTC','montant','total','ttc','netAPayer'].includes(key)) {
            const amt = trouverMontantBrut(item);
            if (!Number.isNaN(amt)) return `${amt.toFixed(2)} DHS`;
        }
        return '-';
    }
    switch (key) {
        case 'date':
        case 'datePeremption':
        case 'createdAt':
            try { return new Date(value).toLocaleDateString('fr-FR'); } catch(e){ return String(value); }
        case 'totalTTC':
        case 'totalHT':
        case 'montant':
        case 'prixVente':
        case 'prixAchat':
        case 'ttc': {
            const n = parseNumeric(value) || 0;
            return `${n.toFixed(2)} DHS`;
        }
        case 'quantite':
        case 'stock':
        case 'seuil': {
            const qty = parseInt(value)||0;
            const seuil = parseInt(item.seuil)||5;
            const className = qty <= seuil ? 'stock-low' : 'stock-ok';
            return `<span class="${className}">${qty}</span>`;
        }
        case 'statutPaiement': {
            const statusClass = value === 'payé' ? 'status-paid' : value === 'impayé' ? 'status-unpaid' : 'status-partial';
            return `<span class="status-badge ${statusClass}">${value}</span>`;
        }
        case 'articles':
            if (Array.isArray(value)) {
                const count = value.length;
                const preview = value.slice(0,2).map(a => a.produit || 'N/A').join(', ');
                return count>2 ? `${preview}... (+${count-2})` : (preview || '-');
            }
            return '-';
        default:
            return String(value).substring(0, 60);
    }
}

function searchInItem(item, query) {
    const q = query.toLowerCase();
    return Object.values(item).some(value => {
        if (typeof value === 'string') return value.toLowerCase().includes(q);
        if (typeof value === 'number') return String(value).includes(q);
        if (Array.isArray(value)) return value.some(v => {
            if (typeof v === 'string') return v.toLowerCase().includes(q);
            if (v && typeof v === 'object') {
                return Object.values(v).some(x => typeof x === 'string' && x.toLowerCase().includes(q));
            }
            return false;
        });
        if (value && typeof value === 'object') {
            return Object.values(value).some(x => typeof x === 'string' && x.toLowerCase().includes(q));
        }
        return false;
    });
}
function filterTable(query) { searchFilter = query.toLowerCase(); updateSectionContent(currentSection); }

/* ===================== Modals ===================== */
function openAddModal(section) {
    editingItem = null; editingIndex = null;
    document.getElementById('editModalTitle').textContent = `Ajouter ${getSectionLabel(section, true)}`;
    document.getElementById('editModalBody').innerHTML = createFormHTML(section);
    document.getElementById('editModal').style.display = 'block';
    setTimeout(() => { const firstInput = document.querySelector('#editModal input'); if (firstInput) firstInput.focus(); }, 100);
}
function openEditModal(section, index) {
    editingItem = currentData.data[section][index]; editingIndex = index;
    document.getElementById('editModalTitle').textContent = `Modifier ${getSectionLabel(section, true)}`;
    document.getElementById('editModalBody').innerHTML = createFormHTML(section, editingItem);
    document.getElementById('editModal').style.display = 'block';
}
function closeEditModal() { document.getElementById('editModal').style.display = 'none'; editingItem = null; editingIndex = null; }

/* ===================== Forms (HTML) ===================== */
function createFormHTML(section, item=null) {
    const forms = {
        stock: createStockForm(item),
        ventes: createVentesForm(item),
        achats: createAchatsForm(item),
        paiements: createPaiementsForm(item)
    };
    const formContent = forms[section] || '<p>Formulaire non disponible pour cette section.</p>';
    return `
        ${formContent}
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
            <button class="btn btn-primary" onclick="saveCurrentItem('${section}')">${item ? 'Modifier' : 'Ajouter'}</button>
        </div>
    `;
}

function createStockForm(item=null) {
    return `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Nom du produit *</label>
                <input type="text" class="form-input" id="nom" value="${item?.nom || ''}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Quantité *</label>
                <input type="number" class="form-input" id="quantite" value="${item?.quantite || 0}" min="0" required>
            </div>
            <div class="form-group">
                <label class="form-label">Prix d'achat *</label>
                <input type="number" class="form-input" id="prixAchat" value="${item?.prixAchat || 0}" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="form-label">Prix de vente *</label>
                <input type="number" class="form-input" id="prixVente" value="${item?.prixVente || 0}" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="form-label">Date de péremption</label>
                <input type="date" class="form-input" id="datePeremption" value="${item?.datePeremption ? item.datePeremption.split('T')[0] : ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Fournisseur</label>
                <input type="text" class="form-input" id="dernierFournisseur" value="${item?.dernierFournisseur || ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Seuil d'alerte</label>
                <input type="number" class="form-input" id="seuil" value="${item?.seuil || 5}" min="0">
            </div>
        </div>
    `;
}

function createVentesForm(item=null) {
    return `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-input" id="date" value="${item?.date ? item.date.split('T')[0] : new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Client *</label>
                <input type="text" class="form-input" id="client" value="${item?.client || ''}" placeholder="Nom du client" required>
            </div>
            <div class="form-group">
                <label class="form-label">Mode de paiement</label>
                <select class="form-input" id="modePaiement">
                    <option value="Espèces" ${item?.modePaiement === 'Espèces' ? 'selected' : ''}>Espèces</option>
                    <option value="Carte" ${item?.modePaiement === 'Carte' ? 'selected' : ''}>Carte</option>
                    <option value="Chèque" ${item?.modePaiement === 'Chèque' ? 'selected' : ''}>Chèque</option>
                    <option value="Virement" ${item?.modePaiement === 'Virement' ? 'selected' : ''}>Virement</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Statut paiement</label>
                <select class="form-input" id="statutPaiement">
                    <option value="payé" ${item?.statutPaiement === 'payé' ? 'selected' : ''}>Payé</option>
                    <option value="impayé" ${item?.statutPaiement === 'impayé' ? 'selected' : ''}>Impayé</option>
                </select>
            </div>
        </div>
        <div class="article-section">
            <div class="article-header">
                <h3 style="font-size:1.125rem;font-weight:600;">Articles vendus</h3>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addVenteArticle()">Ajouter article</button>
            </div>
            <div id="articlesContainer">
                ${item?.articles && item.articles.length>0 ? item.articles.map((a,i)=>createVenteArticleHTML(a,i)).join('') : createVenteArticleHTML(null,0)}
            </div>
            <div class="total-display">
                <div style="font-size:.875rem;color:var(--text-secondary);margin-bottom:4px;">Total</div>
                <div class="total-amount" id="totalAmount">0.00 DHS</div>
            </div>
        </div>
    `;
}

function createAchatsForm(item=null) {
    return `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-input" id="date" value="${item?.date ? item.date.split('T')[0] : new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Fournisseur *</label>
                <input type="text" class="form-input" id="fournisseur" value="${item?.fournisseur || ''}" placeholder="Nom du fournisseur" required>
            </div>
            <div class="form-group">
                <label class="form-label">Statut paiement</label>
                <select class="form-input" id="statutPaiement">
                    <option value="payé" ${item?.statutPaiement === 'payé' ? 'selected' : ''}>Payé</option>
                    <option value="impayé" ${item?.statutPaiement === 'impayé' ? 'selected' : ''}>Impayé</option>
                    <option value="partiel" ${item?.statutPaiement === 'partiel' ? 'selected' : ''}>Partiel</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Remise globale (%)</label>
                <input type="number" class="form-input" id="remiseGlobale" value="${item?.remiseGlobale || 0}" min="0" max="100" step="0.01" onchange="calculateTotal()">
            </div>
        </div>
        <div class="article-section">
            <div class="article-header">
                <h3 style="font-size:1.125rem;font-weight:600;">Articles achetés</h3>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addAchatArticle()">Ajouter article</button>
            </div>
            <div id="articlesContainer">
                ${item?.articles && item.articles.length>0 ? item.articles.map((a,i)=>createAchatArticleHTML(a,i)).join('') : createAchatArticleHTML(null,0)}
            </div>
            <div class="total-display">
                <div style="font-size:.875rem;color:var(--text-secondary);margin-bottom:4px;">Total TTC</div>
                <div class="total-amount" id="totalAmount">0.00 DHS</div>
            </div>
        </div>
    `;
}

function createPaiementsForm(item=null) {
    return `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-input" id="date" value="${item?.date ? item.date.split('T')[0] : new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Montant *</label>
                <input type="number" class="form-input" id="montant" value="${item?.montant || 0}" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="form-label">Mode de paiement</label>
                <select class="form-input" id="mode">
                    <option value="Espèces" ${item?.mode === 'Espèces' ? 'selected' : ''}>Espèces</option>
                    <option value="Carte" ${item?.mode === 'Carte' ? 'selected' : ''}>Carte</option>
                    <option value="Chèque" ${item?.mode === 'Chèque' ? 'selected' : ''}>Chèque</option>
                    <option value="Virement" ${item?.mode === 'Virement' ? 'selected' : ''}>Virement</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-input" id="type">
                    <option value="ventes" ${item?.type === 'ventes' ? 'selected' : ''}>Ventes</option>
                    <option value="achats" ${item?.type === 'achats' ? 'selected' : ''}>Achats</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Document ID</label>
                <input type="text" class="form-input" id="docId" value="${item?.docId || ''}" placeholder="ID du document">
            </div>
        </div>
    `;
}

/* ===================== Articles (HTML) ===================== */
function createVenteArticleHTML(article=null, index=0) {
    const products = getAvailableProducts();
    return `
        <div class="article-item" data-index="${index}">
            <div class="article-item-header">
                <strong>Article ${index + 1}</strong>
                ${index>0 ? '<button type="button" class="btn btn-sm btn-danger" onclick="removeArticle(this)">Supprimer</button>' : ''}
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Produit *</label>
                    <input type="text" class="form-input" name="produit" value="${article?.produit || ''}" 
                           list="productList${index}" required onchange="updateVenteProductInfo(this, ${index}); calculateTotal()">
                    <datalist id="productList${index}">
                        ${products.map(p => `<option value="${p.nom}">${p.nom} (Stock: ${p.quantite})</option>`).join('')}
                    </datalist>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantité *</label>
                    <input type="number" class="form-input" name="quantite" value="${article?.quantite || 1}" 
                           min="1" required onchange="calculateTotal()">
                    <small id="stockInfo${index}" style="color:var(--text-secondary);font-size:.75rem;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Prix unitaire *</label>
                    <input type="number" class="form-input" name="prixUnitaire" value="${article?.prixUnitaire || 0}" 
                           min="0" step="0.01" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label class="form-label">Remise (%)</label>
                    <input type="number" class="form-input" name="remise" value="${article?.remise || 0}" 
                           min="0" max="100" step="0.01" onchange="calculateTotal()">
                </div>
            </div>
        </div>
    `;
}

function createAchatArticleHTML(article=null, index=0) {
    const products = getAvailableProducts();
    return `
        <div class="article-item" data-index="${index}">
            <div class="article-item-header">
                <strong>Article ${index + 1}</strong>
                ${index>0 ? '<button type="button" class="btn btn-sm btn-danger" onclick="removeArticle(this)">Supprimer</button>' : ''}
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Produit *</label>
                    <input type="text" class="form-input" name="produit" value="${article?.produit || ''}" 
                           list="productListAchat${index}" required onchange="updateAchatProductInfo(this, ${index}); calculateTotal()">
                    <datalist id="productListAchat${index}">
                        ${products.map(p => `<option value="${p.nom}">${p.nom}</option>`).join('')}
                    </datalist>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantité *</label>
                    <input type="number" class="form-input" name="quantite" value="${article?.quantite || 1}" 
                           min="1" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label class="form-label">Prix d'achat *</label>
                    <input type="number" class="form-input" name="prixAchat" value="${article?.prixAchat || 0}" 
                           min="0" step="0.01" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label class="form-label">Prix de vente *</label>
                    <input type="number" class="form-input" name="prixVente" value="${article?.prixVente || 0}" 
                           min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Date de péremption</label>
                    <input type="date" class="form-input" name="datePeremption" value="${article?.datePeremption ? article.datePeremption.split('T')[0] : ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Numéro de lot</label>
                    <input type="text" class="form-input" name="numeroLot" value="${article?.numeroLot || ''}" placeholder="Ex: LOT2024001">
                </div>
            </div>
        </div>
    `;
}

/* ===================== Articles (logic) ===================== */
function getAvailableProducts() {
    if (!currentData || !currentData.data.stock) return [];
    return currentData.data.stock
        .filter(item => item && item.nom)
        .map(item => ({
            nom: item.nom,
            quantite: parseInt(item.quantite)||0,
            prixAchat: parseNumeric(item.prixAchat)||0,
            prixVente: parseNumeric(item.prixVente)||0
        }));
}
function addVenteArticle(){ const c=document.getElementById('articlesContainer'); const count=c.children.length; c.insertAdjacentHTML('beforeend', createVenteArticleHTML(null,count)); calculateTotal(); }
function addAchatArticle(){ const c=document.getElementById('articlesContainer'); const count=c.children.length; c.insertAdjacentHTML('beforeend', createAchatArticleHTML(null,count)); calculateTotal(); }
function removeArticle(button){
    const article = button.closest('.article-item'); article.remove();
    const articles = document.querySelectorAll('.article-item');
    articles.forEach((item, idx) => {
        item.dataset.index = idx;
        const header = item.querySelector('.article-item-header strong');
        if (header) header.textContent = `Article ${idx + 1}`;
    });
    calculateTotal();
}

function calculateTotal() {
    const totalElement = document.getElementById('totalAmount');
    if (!totalElement) return;

    let total = 0;
    const articles = document.querySelectorAll('.article-item');
    articles.forEach(article => {
        const quantite = parseNumeric(article.querySelector('input[name="quantite"]')?.value) || 0;
        if (currentSection === 'ventes') {
            const prix = parseNumeric(article.querySelector('input[name="prixUnitaire"]')?.value) || 0;
            const remise = parseNumeric(article.querySelector('input[name="remise"]')?.value) || 0;
            const sousTotal = quantite * prix;
            total += sousTotal - (sousTotal * remise / 100);
        } else if (currentSection === 'achats') {
            const prix = parseNumeric(article.querySelector('input[name="prixAchat"]')?.value) || 0;
            total += quantite * prix;
        }
    });
    if (currentSection === 'achats') {
        const remiseGlobale = parseNumeric(document.getElementById('remiseGlobale')?.value) || 0;
        total -= total * (remiseGlobale / 100);
    }
    totalElement.textContent = `${total.toFixed(2)} DHS`;
}

function updateVenteProductInfo(input, index) {
    const products = getAvailableProducts();
    const product = products.find(p => p.nom === input.value);
    if (product) {
        const prixInput = input.closest('.article-item').querySelector('input[name="prixUnitaire"]');
        const stockInfo = document.getElementById(`stockInfo${index}`);
        if (prixInput) prixInput.value = product.prixVente;
        if (stockInfo) {
            stockInfo.textContent = `Stock disponible: ${product.quantite}`;
            stockInfo.style.color = product.quantite <= 5 ? 'var(--danger-color)' : 'var(--success-color)';
        }
    }
}
function updateAchatProductInfo(input, index) {
    const products = getAvailableProducts();
    const product = products.find(p => p.nom === input.value);
    if (product) {
        const article = input.closest('.article-item');
        const prixAchatInput = article.querySelector('input[name="prixAchat"]');
        const prixVenteInput = article.querySelector('input[name="prixVente"]');
        if (prixAchatInput && product.prixAchat) prixAchatInput.value = product.prixAchat;
        if (prixVenteInput && product.prixVente) prixVenteInput.value = product.prixVente;
    }
}

/* ===================== Save / Validate ===================== */
function saveCurrentItem(section) {
    try {
        const formData = collectFormData(section);
        if (!validateFormData(formData, section)) return;

        if (!currentData.data[section]) currentData.data[section] = [];
        const now = new Date().toISOString();

        if (editingIndex === null) {
            formData.id = generateId();
            formData.creeLe = now;
            formData.creeParEmail = 'offline@user.com';
            currentData.data[section].push(formData);
            showAlert('Élément ajouté avec succès!', 'success');
        } else {
            const existing = currentData.data[section][editingIndex];
            Object.assign(formData, {
                id: existing.id || generateId(),
                creeLe: existing.creeLe || now,
                creeParEmail: existing.creeParEmail || 'offline@user.com',
                modifieLe: now,
                modifieParEmail: 'offline@user.com'
            });
            currentData.data[section][editingIndex] = formData;
            showAlert('Élément modifié avec succès!', 'success');
        }

        updateStockForOperation(section, formData);
        saveData();
        closeEditModal();
        updateInterface();
    } catch (error) {
        showAlert('Erreur: ' + error.message, 'error');
    }
}

function collectFormData(section) {
    const formData = {};
    const inputs = document.querySelectorAll('#editModal input:not([name]), #editModal select:not([name])');
    inputs.forEach(input => {
        if (input.id) {
            let value = input.value;
            if (input.type === 'number') {
                value = (input.id === 'quantite' || input.id === 'seuil') ? (parseInt(value)||0) : (parseNumeric(value)||0);
            } else if (input.type === 'date' && value) {
                value = new Date(value).toISOString();
            }
            formData[input.id] = value;
        }
    });

    if (section === 'achats' || section === 'ventes') {
        const articles = [];
        const articleItems = document.querySelectorAll('.article-item');
        articleItems.forEach(item => {
            const article = {};
            const inputs = item.querySelectorAll('input[name]');
            inputs.forEach(input => {
                let value = input.value;
                if (input.type === 'number') value = (input.name === 'quantite') ? (parseInt(value)||0) : (parseNumeric(value)||0);
                else if (input.type === 'date' && value) value = new Date(value).toISOString();
                article[input.name] = value;
            });
            if (article.produit && article.produit.trim()) articles.push(article);
        });
        formData.articles = articles;

        if (section === 'ventes') {
            formData.totalTTC = montantVente(formData);
        } else if (section === 'achats') {
            formData.totalTTC = montantAchat(formData);
        }
    }
    return formData;
}

function validateFormData(formData, section) {
    if ((section === 'achats' || section === 'ventes') && (!formData.articles || formData.articles.length === 0)) {
        showAlert('Veuillez ajouter au moins un article', 'error');
        return false;
    }
    return true;
}

/* ===================== Stock update (achats/ventes) ===================== */
function updateStockForOperation(section, data) {
    if (!currentData.data.stock) return;

    if (section === 'achats' && data.articles) {
        data.articles.forEach(article => {
            let stockItem = currentData.data.stock.find(s => s.nom && s.nom.toLowerCase() === article.produit.toLowerCase());
            if (stockItem) {
                stockItem.quantite = (parseInt(stockItem.quantite)||0) + (parseInt(article.quantite)||0);
                stockItem.prixAchat = parseNumeric(article.prixAchat)||0;
                stockItem.prixVente = parseNumeric(article.prixVente)||0;
                stockItem.datePeremption = article.datePeremption || stockItem.datePeremption;
                stockItem.dernierFournisseur = data.fournisseur || stockItem.dernierFournisseur;
                stockItem.modifieLe = new Date().toISOString();
            } else {
                currentData.data.stock.push({
                    id: generateId(),
                    nom: article.produit,
                    quantite: parseInt(article.quantite)||0,
                    prixAchat: parseNumeric(article.prixAchat)||0,
                    prixVente: parseNumeric(article.prixVente)||0,
                    datePeremption: article.datePeremption,
                    dernierFournisseur: data.fournisseur,
                    seuil: 5,
                    creeLe: new Date().toISOString()
                });
            }
        });
    } else if (section === 'ventes' && data.articles) {
        data.articles.forEach(article => {
            let stockItem = currentData.data.stock.find(s => s.nom && s.nom.toLowerCase() === article.produit.toLowerCase());
            if (stockItem) {
                const oldQty = parseInt(stockItem.quantite)||0;
                const qtyToRemove = parseInt(article.quantite)||0;
                stockItem.quantite = Math.max(0, oldQty - qtyToRemove);
                stockItem.modifieLe = new Date().toISOString();
                if (stockItem.quantite <= (parseInt(stockItem.seuil)||5)) {
                    showAlert(`⚠️ Stock faible: ${stockItem.nom} (${stockItem.quantite} restants)`, 'warning');
                }
            }
        });
    }
}

/* ===================== Sections refresh ===================== */
function updateAllSections(){ ['stock','ventes','achats','paiements'].forEach(section => updateSectionContent(section)); }

/* ===================== Confirm/Suppressions ===================== */
function confirmDelete(section, index) {
    const item = currentData.data[section][index];
    const name = item.nom || item.client || item.fournisseur || `Élément ${index + 1}`;
    document.getElementById('confirmMessage').textContent = `Voulez-vous vraiment supprimer "${name}" ?`;
    document.getElementById('confirmButton').onclick = () => { deleteItem(section, index); closeConfirmModal(); };
    document.getElementById('confirmModal').style.display = 'block';
}
function deleteItem(section, index) {
    currentData.data[section].splice(index, 1);
    saveData();
    updateInterface();
    showAlert('Élément supprimé', 'success');
}
function closeConfirmModal(){ document.getElementById('confirmModal').style.display='none'; }

/* ===================== Progress & Alerts ===================== */
function showProgress(text, percentage) {
    document.getElementById('progressText').textContent = text;
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressModal').style.display = 'block';
}
function hideProgress(){ document.getElementById('progressModal').style.display='none'; }

function showAlert(message, type='info') {
    const container = document.getElementById('alertsContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `<span>${message}</span>
        <button style="background:none;border:none;color:inherit;cursor:pointer;margin-left:auto;" onclick="this.parentElement.remove()">×</button>`;
    container.appendChild(alert);
    setTimeout(()=>{ if (alert.parentElement) alert.remove(); }, 5000);
}

/* ===================== Persist ===================== */
function saveData() {
    if (currentData) {
        localStorage.setItem('pharmaData', JSON.stringify(currentData));
        localStorage.setItem('lastModified', new Date().toISOString());
    }
}

/* ===================== Utils ===================== */
function generateId(){ return 'id_' + Math.random().toString(36).substr(2,9) + '_' + Date.now(); }

/* ===================== Export / Clear ===================== */
function exportData() {
    if (!currentData) { showAlert('Aucune donnée à exporter', 'error'); return; }
    showProgress('Préparation...', 20);
    const exportData = JSON.parse(JSON.stringify(currentData));
    exportData.metadata = exportData.metadata || {};
    exportData.metadata.exportDateIso = new Date().toISOString();
    exportData.metadata.exportedFrom = 'offline-app-pro';
    showProgress('Génération du fichier...', 80);
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `pharma-export-${new Date().toISOString().split('T')[0]}.json`; a.click();
    URL.revokeObjectURL(url);
    showProgress('Terminé!', 100);
    setTimeout(()=>{ hideProgress(); showAlert('Export terminé avec succès!', 'success'); }, 500);
}

function clearAllData() {
    if (confirm('Voulez-vous vraiment effacer toutes les données ? Cette action est irréversible.')) {
        ['pharmaData','pharmaDataOriginal','lastImport','lastModified'].forEach(key => localStorage.removeItem(key));
        currentData = null;
        originalData = null;

        document.getElementById('exportBtn').disabled = true;
        updateNavBadges();

        const emptyState = document.getElementById('dashboardEmpty');
        const content = document.getElementById('dashboardContent');
        if (emptyState) emptyState.style.display = 'block';
        if (content) content.style.display = 'none';

        showSection('dashboard');

        showAlert('Toutes les données ont été effacées', 'info');
    }
}

/* ===================== Boot ===================== */
window.addEventListener('load', () => {
    updateConnectionStatus();
    loadStoredData();
});
</script>
</body>
</html>
